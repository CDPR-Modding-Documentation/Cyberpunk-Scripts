import class PlayerProximityStartEvent extends Event
{
	import var profile : CName;
}

import class PlayerProximityStopEvent extends Event
{
	import var profile : CName;
}

importonly abstract class ReactionChangeRequestEvent extends Event
{
	import var reactionPresetRecord : ReactionPreset_Record;
}

importonly class AIPuppetSwappedEvent extends Event
{
}

class SecuritySystemOutputTaskData extends ScriptTaskData
{
	var cachedEvt : SecuritySystemOutput;
}

class StimEventTaskData extends ScriptTaskData
{
	var cachedEvt : StimuliEvent;
	editable var id : Uint32;
}

class AnimFeature_FacialReaction extends AnimFeature
{
	editable var category : Int32;
	editable var idle : Int32;
}

struct StimParams
{
	var reactionOutput : ReactionOutput;
	var stimData : StimEventData;
}

class ReprimandEscalationEvent extends Event
{
	var startReprimand : Bool;
	var startDeescalate : Bool;
}

class IgnoreListEvent extends Event
{
	var bodyID : EntityID;
	var removeEvent : Bool;
}

class DeadBodyEvent extends Event
{
}

class HandleRagdollOnDeathEvent extends Event
{
	var handleUncontrolledMovement : Bool;
}

import class StanceStateChangeEvent extends Event
{
	import var state : gamedataNPCStanceState;
}

class CrowdCallingPoliceEvent extends Event
{
}

class SwapPresetEvent extends Event
{
	var mappingName : String;
}

class ReevaluatePresetEvent extends Event
{
}

class EndLookatEvent extends Event
{
	var repeat : Bool;
}

class TerminateReactionLookatEvent extends Event
{
}

class RepeatLookatEvent extends Event
{
	var target : weak< Entity >;
}

class CommunicationEvent extends Event
{
	var name : CName;
	var sender : EntityID;
}

class DelayedCrowdReactionEvent extends Event
{
	var stimEvent : StimuliEvent;
	var vehicleFearPhase : Int32;
}

class DelayStimEvent extends Event
{
	var stimEvent : StimuliEvent;
}

class TriggerDelayedReactionEvent extends DelayedCrowdReactionEvent
{
	var initAnim : Bool;
	var behavior : gamedataOutput;
}

class ExitWorkspotSequenceEvent extends Event
{
}

class DeescalateFearInVehicle extends Event
{
}

class CrowdSettingsEvent extends Event
{
	var movementType : CName;
}

class ProximityLookatEvent extends Event
{
}

class AddInvestigatorEvent extends Event
{
	var investigator : EntityID;
}

class SetBodyPositionEvent extends Event
{
	var bodyPosition : Vector4;
	var bodyPositionID : EntityID;
	var pickedUp : Bool;
}

class ResetLookatReactionEvent extends Event
{
}

class ResetFacialEvent extends Event
{
}

class SpreadFearEvent extends Event
{
	var player : Bool;
	var phase : Int32;
}

class DisturbingComfortZone extends Event
{
}

class CheckComfortZoneEvent extends Event
{
}

class StalkEvent extends Event
{
}

class DistrurbComfortZoneAggressiveEvent extends Event
{
}

class ResetReactionEvent extends Event
{
	var data : AIReactionData;
}

class CleanEnvironmentalHazardEvent extends Event
{
	var stimEvent : StimuliEvent;
}

class StimThresholdEvent extends Event
{
	var reset : Bool;
	var timeThreshold : Float;
}

class StealthStimThresholdEvent extends Event
{
	var reset : Bool;
	var timeThreshold : Float;
}

class BodyInvestigatedEvent extends Event
{
}

class PlayerMuntedToMyVehicle extends Event
{
	var player : weak< PlayerPuppet >;

	public static function Create( player : weak< PlayerPuppet > ) : PlayerMuntedToMyVehicle
	{
		var evt : PlayerMuntedToMyVehicle;
		evt = new PlayerMuntedToMyVehicle;
		evt.player = player;
		return evt;
	}

}

struct StimEventData
{
	var source : weak< GameObject >;
	var stimType : gamedataStimType;
}

struct ReactionOutput
{
	var reactionBehavior : gamedataOutput;
	var reactionPriority : Int32;
	var AIbehaviorPriority : Float;
	var reactionCooldown : Float;
	var startedInWorkspot : Bool;
	var workspotReaction : Bool;
	var workspotReactionType : CName;
}

struct LookAtData
{
	var idle : Int32;
	var category : Int32;
	var personality : gamedataStatType;
}

class ReactionBehaviorStatus extends Event
{
	var status : AIbehaviorUpdateOutcome;
	var reactionData : AIReactionData;
}

class AIReactionData
{
	var reactionPriority : Int32;
	var reactionBehaviorName : gamedataOutput;
	var reactionBehaviorAIPriority : Float;
	var reactionCooldown : Float;
	var stimTarget : weak< GameObject >;
	var stimSource : Vector4;
	var stimType : gamedataStimType;
	var stimPriority : gamedataStimPriority;
	var stimRecord : Stim_Record;
	var stimInvestigateData : stimInvestigateData;
	var stimEventData : StimEventData;
	var initAnimInWorkspot : Bool;
	var skipInitialAnimation : Bool;
	var validTillTimeStamp : Float;
	var recentReactionTimeStamp : Float;
	var escalateProvoke : Bool;
}

class ReactionManagerComponent extends ScriptableComponent
{
	private var m_activeReaction : AIReactionData;
	private var m_desiredReaction : AIReactionData;
	private var m_stimuliCache : array< StimEventTaskData >;
	private var m_reactionCache : array< AIReactionData >;
	private var m_reactionPreset : ReactionPreset_Record;
	private var m_puppetReactionBlackboard : IBlackboard;
	private var m_receivedStimType : gamedataStimType;
	private var m_inCrowd : Bool;
	private var m_inTrafficLane : Bool;
	private var m_desiredFearPhase : Int32;
	default m_desiredFearPhase = -1;
	private var m_previousFearPhase : Int32;
	private var m_NPCRadius : Float;
	default m_NPCRadius = 0.3f;
	private var m_bumpTriggerDistanceBufferMounted : Float;
	default m_bumpTriggerDistanceBufferMounted = 1.0f;
	private var m_bumpTriggerDistanceBufferCrouched : Float;
	default m_bumpTriggerDistanceBufferCrouched = -0.11f;
	private var m_delayReactionEventID : DelayID;
	private var m_delay : Vector2;
	private var m_delayDetectionEventID : DelayID;
	private var m_delayStimEventID : DelayID;
	private var m_resetReactionDataID : DelayID;
	private var m_callingPoliceID : DelayID;
	private var m_lookatEvent : LookAtAddEvent;
	private var m_ignoreList : array< EntityID >;
	private var m_investigationList : array< StimEventData >;
	private var m_pendingReaction : AIReactionData;
	private var m_ovefloodCooldown : Float;
	default m_ovefloodCooldown = 1.f;
	private var m_stanceState : gamedataNPCStanceState;
	default m_stanceState = gamedataNPCStanceState.Stand;
	private var m_highLevelState : gamedataNPCHighLevelState;
	default m_highLevelState = gamedataNPCHighLevelState.Relaxed;
	private var m_aiRole : EAIRole;
	private var m_pendingBehaviorCb : CallbackHandle;
	private var m_inPendingBehavior : Bool;
	private var m_cacheSecuritySysOutput : SecuritySystemOutput;
	private var m_environmentalHazards : array< StimuliEvent >;
	private var m_environmentalHazardsDelayIDs : array< DelayID >;
	private var m_stolenVehicle : weak< VehicleObject >;
	private var m_isAlertedByDeadBody : Bool;
	default m_isAlertedByDeadBody = false;
	private var m_isInCrosswalk : Bool;
	private var m_beignHijacked : Bool;
	private var m_owner_id : EntityID;
	private var m_presetName : CName;
	private var m_updateByActive : Bool;
	private var m_personalities : array< gamedataStatType >;
	private var m_workspotReactionPlayed : Bool;
	private var m_inReactionSequence : Bool;
	private var m_playerProximity : Bool;
	private var m_fearToIdleDistance : Vector2;
	private var m_exitWorkspotAim : Vector2;
	private var m_bumpedRecently : Int32;
	private var m_bumpTimestamp : Float;
	private var m_crowdAimingReactionDistance : Float;
	private var m_fearInPlaceAroundDistance : Float;
	private var m_lookatRepeat : Bool;
	private var m_disturbingComfortZoneInProgress : Bool;
	private var m_entereProximityRecently : Int32;
	private var m_comfortZoneTimestamp : Float;
	private var m_disturbComfortZoneEventId : DelayID;
	private var m_checkComfortZoneEventId : DelayID;
	private var m_spreadingFearEventId : DelayID;
	private var m_proximityLookatEventId : DelayID;
	private var m_resetFacialEventId : DelayID;
	private var m_exitWorkspotSequenceEventId : DelayID;
	private var m_exitFearInVehicleEventId : DelayID;
	private var m_fastWalk : Bool;
	default m_fastWalk = true;
	private var m_createThreshold : Bool;
	default m_createThreshold = true;
	private var m_initialized : Bool;
	private var m_initCrowd : Bool;
	private var m_facialCooldown : Float;
	private var m_disturbComfortZoneAggressiveEventId : DelayID;
	private var m_backOffInProgress : Bool;
	private var m_backOffTimestamp : Float;
	private var m_crowdFearStage : gameFearStage;
	default m_crowdFearStage = gameFearStage.Relaxed;
	private var m_fearLocomotionWrapper : Bool;
	private var m_successfulFearDeescalation : Float;
	private var m_willingToCallPolice : Bool;
	private var m_deadBodyInvestigators : array< EntityID >;
	private var m_deadBodyStartingPosition : Vector4;
	private var m_currentStimThresholdValue : Int32;
	private var m_timeStampThreshold : Float;
	private var m_currentStealthStimThresholdValue : Int32;
	private var m_stealthTimeStampThreshold : Float;

	protected function HandleStimEventByTask( stimEvent : StimuliEvent )
	{
		var data : StimEventTaskData;
		data = new StimEventTaskData;
		data.cachedEvt = stimEvent;
		GameInstance.GetDelaySystem( GetOwner().GetGame() ).QueueTask( this, data, 'HandleStimEventTask', gameScriptTaskExecutionStage.PostPhysics );
	}

	protected export function HandleStimEventTask( data : ScriptTaskData )
	{
		var stimData : StimEventTaskData;
		stimData = ( ( StimEventTaskData )( data ) );
		if( stimData )
		{
			HandleStimEvent( stimData );
		}
	}

	protected function HandleStimEvent( stimData : StimEventTaskData )
	{
		var stimParams : StimParams;
		var ownerPuppet : ScriptedPuppet;
		var localPlayer : GameObject;
		var resetLookatReaction : ResetLookatReactionEvent;
		var stimType : gamedataStimType;
		var stimEvent : StimuliEvent;
		if( !( stimData ) || !( stimData.cachedEvt ) )
		{
			return;
		}
		stimEvent = stimData.cachedEvt;
		stimType = stimEvent.GetStimType();
		m_receivedStimType = stimType;
		if( !( IsEnabled() ) )
		{
			m_receivedStimType = gamedataStimType.Invalid;
			return;
		}
		if( !( m_initialized ) )
		{
			Initialiaze();
			m_initialized = true;
		}
		ownerPuppet = GetOwnerPuppet();
		if( m_receivedStimType == gamedataStimType.AudioEnemyPing )
		{
			if( ScriptedPuppet.IsActive( ownerPuppet ) && ownerPuppet.IsAggressive() )
			{
				localPlayer = GameInstance.GetPlayerSystem( ownerPuppet.GetGame() ).GetLocalPlayerMainGameObject();
				if( !( SourceAttitude( localPlayer, EAIAttitude.AIA_Friendly ) ) )
				{
					GameInstance.GetAudioSystem( ownerPuppet.GetGame() ).RegisterEnemyPingStim( ownerPuppet.GetHighLevelStateFromBlackboard(), ownerPuppet.IsPrevention() );
				}
			}
			return;
		}
		if( ShouldEventBeProcessed( stimEvent ) )
		{
			if( ownerPuppet.GetCrowdMemberComponent() && ( m_inCrowd || ownerPuppet.IsCharacterCivilian() ) )
			{
				if( ShouldStimBeProcessedByCrowd( stimEvent ) )
				{
					HandleCrowdReaction( stimEvent );
				}
				if( stimEvent.IsTagInStimuli( 'Safe' ) )
				{
					resetLookatReaction = new ResetLookatReactionEvent;
					GameInstance.GetDelaySystem( GetOwner().GetGame() ).DelayEvent( GetOwner(), resetLookatReaction, 1.0 );
				}
				m_receivedStimType = gamedataStimType.Invalid;
				return;
			}
			if( ShouldStimBeProcessed( stimEvent ) )
			{
				stimParams = ProcessStimParams( stimEvent );
				ProcessReactionOutput( stimData, stimParams );
			}
		}
		if( stimType == gamedataStimType.StopedAiming && m_reactionPreset.IsAggressive() )
		{
			ownerPuppet.GetSensesComponent().ReevaluateDetectionOverwrite( stimEvent.sourceObject );
		}
		if( stimType == gamedataStimType.EnvironmentalHazard )
		{
			ProcessEnvironmentalHazard( stimEvent );
		}
		m_receivedStimType = gamedataStimType.Invalid;
	}

	protected function ReactToSecuritySystemOutputByTask( evt : SecuritySystemOutput )
	{
		var data : SecuritySystemOutputTaskData;
		data = new SecuritySystemOutputTaskData;
		data.cachedEvt = evt;
		GameInstance.GetDelaySystem( GetOwner().GetGame() ).QueueTask( this, data, 'ReactToSecuritySystemOutputTask', gameScriptTaskExecutionStage.Any );
	}

	protected export function ReactToSecuritySystemOutputTask( data : ScriptTaskData )
	{
		var taskData : SecuritySystemOutputTaskData;
		taskData = ( ( SecuritySystemOutputTaskData )( data ) );
		if( taskData )
		{
			ReactToSecurityOutput( taskData.cachedEvt );
		}
	}

	public export function OnGameAttach()
	{
		m_owner_id = GetOwner().GetEntityID();
		m_puppetReactionBlackboard = IBlackboard.Create( GetAllBlackboardDefs().PuppetReaction );
	}

	protected event OnPlayerMuntedToMyVehicle( evt : PlayerMuntedToMyVehicle )
	{
		var ownerPuppet : ScriptedPuppet;
		ownerPuppet = GetOwnerPuppet();
		if( ( ownerPuppet.IsAggressive() && ScriptedPuppet.IsActive( ownerPuppet ) ) && AIActionHelper.TryChangingAttitudeToHostile( ownerPuppet, evt.player ) )
		{
			if( !( GetOwnerPuppet().GetPuppetStateBlackboard().GetBool( GetAllBlackboardDefs().PuppetState.WorkspotAnimationInProgress ) ) )
			{
				GetOwner().QueueEvent( AIEvents.ExitVehicleEvent() );
				TargetTrackingExtension.InjectThreat( ownerPuppet, evt.player );
			}
		}
	}

	protected event OnSenseVisibilityEvent( evt : SenseVisibilityEvent )
	{
		var investigateData : stimInvestigateData;
		var broadcaster : StimBroadcasterComponent;
		var ignoreListEvent : IgnoreListEvent;
		var ownerPuppet : ScriptedPuppet;
		var owner : GameObject;
		ownerPuppet = GetOwnerPuppet();
		owner = GetOwner();
		if( evt.target )
		{
			broadcaster = evt.target.GetStimBroadcasterComponent();
		}
		if( evt.target.IsPlayer() )
		{
			if( ownerPuppet.IsPrevention() || NPCManager.HasTag( ownerPuppet.GetRecordID(), 'TriggerPrevention' ) )
			{
				if( evt.isVisible )
				{
					PreventionSystem.RegisterAsViewerToPreventionSystem( owner.GetGame(), ownerPuppet );
				}
				else
				{
					PreventionSystem.UnRegisterAsViewerToPreventionSystem( owner.GetGame(), ownerPuppet );
				}
			}
			if( evt.isVisible )
			{
				if( CanTriggerReprimandOrder() )
				{
					if( !( m_activeReaction ) )
					{
						broadcaster.SendDrirectStimuliToTarget( owner, gamedataStimType.AskToFollowOrder, owner );
					}
					if( m_highLevelState != gamedataNPCHighLevelState.Combat )
					{
						( ( NPCPuppet )( owner ) ).GetComfortZoneComponent().Toggle( true );
					}
				}
			}
			else
			{
				( ( NPCPuppet )( owner ) ).GetComfortZoneComponent().Toggle( false );
			}
		}
		else if( !( HasCombatTarget() ) && broadcaster )
		{
			if( evt.description == 'Dead_Body' )
			{
				investigateData.attackInstigator = EntityGameInterface.GetEntity( GameInstance.GetPlayerSystem( owner.GetGame() ).GetLocalPlayerControlledGameObject().GetEntity() );
				broadcaster.SendDrirectStimuliToTarget( owner, gamedataStimType.DeadBody, owner, investigateData );
			}
			else if( evt.description == 'Unconscious' )
			{
				broadcaster.SendDrirectStimuliToTarget( owner, gamedataStimType.DeadBody, owner );
			}
			else if( evt.description == 'HeartAttack' )
			{
				broadcaster.SendDrirectStimuliToTarget( owner, gamedataStimType.DeadBody, owner );
			}
		}
		else if( HasCombatTarget() )
		{
			if( ( evt.description == 'Dead_Body' || evt.description == 'Unconscious' ) || evt.description == 'HeartAttack' )
			{
				if( !( m_ignoreList.Contains( evt.target.GetEntityID() ) ) )
				{
					ignoreListEvent = new IgnoreListEvent;
					ignoreListEvent.bodyID = evt.target.GetEntityID();
					m_ignoreList.PushBack( ignoreListEvent.bodyID );
					SendEventToSquad( ignoreListEvent );
				}
			}
		}
	}

	protected event OnLookedAtEvent( evt : LookedAtEvent )
	{
		var broadcaster : StimBroadcasterComponent;
		broadcaster = GetPlayerSystem().GetLocalPlayerControlledGameObject().GetStimBroadcasterComponent();
		if( broadcaster )
		{
			if( ( evt.isLookedAt && !( m_activeReaction ) ) && CanTriggerReprimandOrder() )
			{
				broadcaster.SendDrirectStimuliToTarget( GetOwner(), gamedataStimType.AskToFollowOrder, GetOwner() );
			}
		}
	}

	protected event OnDetectedEvent( evt : OnDetectedEvent )
	{
		var broadcaster : StimBroadcasterComponent;
		var securitySystem : SecuritySystemControllerPS;
		var securitySystemInput : SecuritySystemInput;
		var deviceLink : PuppetDeviceLinkPS;
		var ownerPuppet : ScriptedPuppet;
		var owner : GameObject;
		var scriptedPuppetTarget : ScriptedPuppet;
		ownerPuppet = GetOwnerPuppet();
		owner = GetOwner();
		if( ScriptedPuppet.IsBlinded( ownerPuppet ) )
		{
			return false;
		}
		if( evt.target && evt.isVisible )
		{
			if( evt.target.IsPlayer() )
			{
				deviceLink = ( ( PuppetDeviceLinkPS )( owner.GetDeviceLink() ) );
				if( deviceLink )
				{
					deviceLink.NotifyAboutSpottingPlayer( true );
				}
				if( ( IsPlayerAiming() && IsReactionAvailableInPreset( gamedataStimType.AimingAt ) ) || DidTargetMakeMeAlerted( evt.target ) )
				{
					if( AIActionHelper.TryChangingAttitudeToHostile( ownerPuppet, evt.target ) )
					{
						TargetTrackingExtension.InjectThreat( ownerPuppet, evt.target );
					}
				}
				else
				{
					broadcaster = evt.target.GetStimBroadcasterComponent();
					securitySystem = ownerPuppet.GetSecuritySystem();
					if( m_reactionPreset.Type() == gamedataReactionPresetType.Civilian_Guard )
					{
						broadcaster.SendDrirectStimuliToTarget( owner, gamedataStimType.SecurityBreach, owner );
					}
					else if( securitySystem )
					{
						securitySystemInput = deviceLink.ActionSecurityBreachNotification( evt.target.GetWorldPosition(), evt.target, ESecurityNotificationType.DEFAULT );
						if( securitySystem.DetermineSecuritySystemState( securitySystemInput, true ) == ESecuritySystemState.COMBAT )
						{
							if( AIActionHelper.TryChangingAttitudeToHostile( ownerPuppet, evt.target ) )
							{
								TargetTrackingExtension.InjectThreat( ownerPuppet, evt.target );
							}
						}
						else
						{
							ownerPuppet.TriggerSecuritySystemNotification( evt.target.GetWorldPosition(), evt.target, ESecurityNotificationType.DEFAULT );
						}
					}
					if( IsTargetArmed( evt.target ) && broadcaster )
					{
						broadcaster.SendDrirectStimuliToTarget( owner, gamedataStimType.WeaponDisplayed, owner );
					}
				}
			}
			else if( ( ( m_highLevelState == gamedataNPCHighLevelState.Combat && ownerPuppet.IsPrevention() ) && ( ( ScriptedPuppet )( evt.target ) ).GetHighLevelStateFromBlackboard() == gamedataNPCHighLevelState.Combat ) && SourceAttitude( evt.target, EAIAttitude.AIA_Neutral ) )
			{
				if( AIActionHelper.TryChangingAttitudeToHostile( ownerPuppet, evt.target ) )
				{
					TargetTrackingExtension.InjectThreat( ownerPuppet, evt.target );
				}
			}
			else if( ( ( ( ( m_highLevelState != gamedataNPCHighLevelState.Combat && evt.target.IsPuppet() ) && ( IsTargetSquadAlly( evt.target ) || IsTargetFromSameAttitudeGroup( evt.target ) ) ) && !( evt.target.IsDead() ) ) && !( ownerPuppet.IsCharacterCivilian() ) ) && !( ownerPuppet.IsCharacterChildren() ) )
			{
				scriptedPuppetTarget = ( ( ScriptedPuppet )( evt.target ) );
				if( scriptedPuppetTarget.GetStimReactionComponent().GetReactionPreset().Type() == gamedataReactionPresetType.Civilian_Guard )
				{
					if( scriptedPuppetTarget.GetHighLevelStateFromBlackboard() == gamedataNPCHighLevelState.Fear && m_highLevelState == gamedataNPCHighLevelState.Relaxed )
					{
						NPCPuppet.ChangeHighLevelState( owner, gamedataNPCHighLevelState.Alerted );
					}
				}
				else
				{
					HelpAlly( scriptedPuppetTarget );
				}
			}
		}
	}

	protected event OnSecurityAreaCrossingPerimeter( evt : SecurityAreaCrossingPerimeter )
	{
		var target : weak< GameObject >;
		if( !( IsEnabled() ) )
		{
			return NULL;
		}
		if( GetOwner() )
		{
			target = evt.GetWhoBreached();
		}
		if( ( target && target.IsPlayer() ) && IsTargetDetected( target ) )
		{
			if( m_reactionPreset.Type() != gamedataReactionPresetType.Civilian_Guard )
			{
				GetOwnerPuppet().TriggerSecuritySystemNotification( target.GetWorldPosition(), target, ESecurityNotificationType.DEFAULT );
			}
		}
	}

	protected event OnSecuritySystemOutput( evt : SecuritySystemOutput )
	{
		var debugFact : CName;
		if( GetOwnerPuppet().GetAreIncomingSecuritySystemEventsSuppressed() )
		{
			return NULL;
		}
		if( !( IsFinal() ) )
		{
			debugFact = StringToName( EntityID.ToDebugStringDecimal( m_owner_id ) );
			AddFact( GetOwnerPuppet().GetGame(), debugFact );
		}
		ReactToSecuritySystemOutputByTask( evt );
	}

	protected event OnReprimandEscalationEvent( evt : ReprimandEscalationEvent )
	{
		if( evt.startReprimand )
		{
			StartEscalateReprimand();
		}
		else if( evt.startDeescalate )
		{
			DeescalateReprimand();
		}
		else
		{
			ReprimandEscalation();
		}
	}

	private function StartEscalateReprimand()
	{
		var statPoolSys : StatPoolsSystem;
		statPoolSys = GameInstance.GetStatPoolsSystem( GetOwner().GetGame() );
		statPoolSys.RequestAddingStatPool( GetOwner().GetEntityID(), T"BaseStatPools.ReprimandEscalation", true );
	}

	private function ReprimandEscalation()
	{
		var statPoolSys : StatPoolsSystem;
		var statPoolMod : StatPoolModifier;
		var owner : GameObject;
		var ownerId : EntityID;
		owner = GetOwner();
		ownerId = owner.GetEntityID();
		statPoolSys = GameInstance.GetStatPoolsSystem( owner.GetGame() );
		statPoolSys.GetModifier( ownerId, gamedataStatPoolType.ReprimandEscalation, gameStatPoolModificationTypes.Regeneration, statPoolMod );
		statPoolMod.enabled = true;
		statPoolSys.RequestSettingModifier( ownerId, gamedataStatPoolType.ReprimandEscalation, gameStatPoolModificationTypes.Regeneration, statPoolMod );
	}

	private function DeescalateReprimand()
	{
		var statPoolSys : StatPoolsSystem;
		var regenMod : StatPoolModifier;
		var decayMod : StatPoolModifier;
		var owner : GameObject;
		var ownerId : EntityID;
		owner = GetOwner();
		ownerId = owner.GetEntityID();
		statPoolSys = GameInstance.GetStatPoolsSystem( owner.GetGame() );
		statPoolSys.GetModifier( ownerId, gamedataStatPoolType.ReprimandEscalation, gameStatPoolModificationTypes.Regeneration, regenMod );
		regenMod.enabled = false;
		statPoolSys.RequestSettingModifier( ownerId, gamedataStatPoolType.ReprimandEscalation, gameStatPoolModificationTypes.Regeneration, regenMod );
		statPoolSys.GetModifier( ownerId, gamedataStatPoolType.ReprimandEscalation, gameStatPoolModificationTypes.Decay, decayMod );
		decayMod.enabled = true;
		statPoolSys.RequestSettingModifier( ownerId, gamedataStatPoolType.ReprimandEscalation, gameStatPoolModificationTypes.Decay, decayMod );
	}

	protected event OnReprimandUpdate( evt : ReprimandUpdate )
	{
		var trespasserID : EntityID;
		var trespasser : GameObject;
		var reprimandUpdateEvent : StimuliEvent;
		var broadcaster : StimBroadcasterComponent;
		var owner : GameObject;
		var ownerPuppet : ScriptedPuppet;
		if( !( IsEnabled() ) )
		{
			return false;
		}
		owner = GetOwner();
		ownerPuppet = GetOwnerPuppet();
		if( ownerPuppet.GetAreIncomingSecuritySystemEventsSuppressed() )
		{
			return false;
		}
		if( evt.reprimandInstructions == EReprimandInstructions.CONCLUDE_SUCCESSFUL )
		{
			reprimandUpdateEvent = new StimuliEvent;
			reprimandUpdateEvent.name = 'targetComplies';
			owner.QueueEvent( reprimandUpdateEvent );
		}
		if( evt.reprimandInstructions == EReprimandInstructions.CONCLUDE_FAILED )
		{
			reprimandUpdateEvent = new StimuliEvent;
			reprimandUpdateEvent.name = 'concludeFailed';
			owner.QueueEvent( reprimandUpdateEvent );
		}
		if( evt.reprimandInstructions == EReprimandInstructions.RELEASE_TO_ANOTHER_ENTITY )
		{
			reprimandUpdateEvent = new StimuliEvent;
			reprimandUpdateEvent.name = 'exitReprimand';
		}
		trespasserID = evt.target;
		trespasser = ( ( GameObject )( GameInstance.FindEntityByID( owner.GetGame(), trespasserID ) ) );
		if( !( trespasser ) )
		{
			return false;
		}
		broadcaster = trespasser.GetStimBroadcasterComponent();
		if( VehicleComponent.IsMountedToVehicle( owner.GetGame(), trespasser ) )
		{
			if( AIActionHelper.TryChangingAttitudeToHostile( ownerPuppet, trespasser ) )
			{
				TargetTrackingExtension.InjectThreat( ownerPuppet, trespasser );
			}
		}
		if( evt.reprimandInstructions == EReprimandInstructions.INITIATE_FIRST )
		{
			if( RecentReaction( gamedataOutput.AskToHolster ) )
			{
				broadcaster.SendDrirectStimuliToTarget( owner, gamedataStimType.ReprimandFinalWarning, owner );
			}
			else
			{
				broadcaster.SendDrirectStimuliToTarget( owner, gamedataStimType.Reprimand, owner );
			}
		}
		if( evt.reprimandInstructions == EReprimandInstructions.INITIATE_SUCCESSIVE )
		{
			broadcaster.SendDrirectStimuliToTarget( owner, gamedataStimType.ReprimandFinalWarning, owner );
		}
		if( evt.reprimandInstructions == EReprimandInstructions.TAKEOVER )
		{
			broadcaster.SendDrirectStimuliToTarget( owner, gamedataStimType.Reprimand, owner );
		}
	}

	private function RecentReaction( behaviorName : gamedataOutput ) : Bool
	{
		var reactionData : AIReactionData;
		var i : Int32;
		var simTime : Float;
		simTime = EngineTime.ToFloat( GameInstance.GetSimTime( GetOwner().GetGame() ) );
		for( i = 0; i < m_reactionCache.Size(); i += 1 )
		{
			reactionData = m_reactionCache[ i ];
			if( reactionData.reactionBehaviorName == behaviorName && ( reactionData.recentReactionTimeStamp >= simTime ) )
			{
				return true;
			}
		}
		return false;
	}

	protected event OnSuspiciousObjectEvent( evt : SuspiciousObjectEvent )
	{
		if( evt.target.IsPlayer() )
		{
			AIActionHelper.TryChangingAttitudeToHostile( ( ( ScriptedPuppet )( GetOwner() ) ), evt.target );
		}
	}

	private function HelpAlly( ally : weak< GameObject >, optional attacker : weak< Entity > )
	{
		var targetOfAlly : weak< GameObject >;
		var threat : TrackedLocation;
		var allyAIComponent : AIHumanComponent;
		var commandCombatTargetVariant : Variant;
		var ownerPuppet : ScriptedPuppet;
		if( !( ally ) )
		{
			return;
		}
		if( m_reactionPreset.Type() == gamedataReactionPresetType.NoReaction )
		{
			return;
		}
		if( attacker )
		{
			targetOfAlly = ( ( GameObject )( attacker ) );
		}
		else
		{
			allyAIComponent = ( ( ScriptedPuppet )( ally ) ).GetAIControllerComponent();
			if( allyAIComponent )
			{
				commandCombatTargetVariant = allyAIComponent.GetBehaviorArgument( 'CommmandCombatTarget' );
				if( commandCombatTargetVariant.IsValid() )
				{
					targetOfAlly = ( ( weak< weak< GameObject > > )commandCombatTargetVariant );
				}
			}
		}
		ownerPuppet = GetOwnerPuppet();
		if( targetOfAlly && ally.GetTargetTrackerComponent().ThreatFromEntity( targetOfAlly, threat ) )
		{
		}
		else if( ally.GetTargetTrackerComponent().GetTopHostileThreat( false, threat ) )
		{
		}
		else if( !( ScriptedPuppet.IsActive( ally ) ) )
		{
			AISquadHelper.EnterAlerted( ownerPuppet );
			return;
		}
		else if( attacker && IsSquadMateInDanger( gamedataOutput.Intruder ) )
		{
			if( AIActionHelper.TryChangingAttitudeToHostile( ownerPuppet, targetOfAlly ) && IsTargetInFront( ally ) )
			{
				TargetTrackingExtension.InjectThreat( ownerPuppet, targetOfAlly );
			}
			return;
		}
		else
		{
			return;
		}
		if( threat.entity && AIActionHelper.TryChangingAttitudeToHostile( ownerPuppet, ( ( GameObject )( threat.entity ) ) ) )
		{
			TargetTrackingExtension.InjectThreat( ownerPuppet, threat );
		}
	}

	private function ReactToSecurityOutput( evt : SecuritySystemOutput )
	{
		var trespasser : weak< GameObject >;
		var deviceNotifier : GameObject;
		if( !( IsEnabled() ) )
		{
			return;
		}
		if( evt.GetOriginalInputEvent().GetNotificationType() == ESecurityNotificationType.DEVICE_DESTROYED && evt.GetCachedSecurityState() != ESecuritySystemState.COMBAT )
		{
			deviceNotifier = ( ( GameObject )( evt.GetOriginalInputEvent().GetNotifierHandle().GetOwnerEntityWeak() ) );
			StimBroadcasterComponent.SendStimDirectly( deviceNotifier, gamedataStimType.ProjectileDistraction, GetOwner() );
			return;
		}
		if( !( evt.GetSecurityStateChanged() ) && ReflectSecSysStateToHLS( evt.GetCachedSecurityState() ) )
		{
			return;
		}
		trespasser = evt.GetOriginalInputEvent().GetWhoBreached();
		switch( evt.GetCachedSecurityState() )
		{
			case ESecuritySystemState.COMBAT:
				if( evt.GetBreachOrigin() == EBreachOrigin.LOCAL && trespasser )
				{
					if( StatusEffectSystem.ObjectHasStatusEffectWithTag( GetOwner(), 'LoreAnim' ) )
					{
						m_cacheSecuritySysOutput = evt;
					}
					else
					{
						TriggerCombat( trespasser );
					}
				}
				else if( !( trespasser ) || ( trespasser && trespasser.IsPlayer() ) )
				{
					TriggerAlerted();
				}
			break;
			case ESecuritySystemState.ALERTED:
				if( !( trespasser ) || ( trespasser && trespasser.IsPlayer() ) )
				{
					if( evt.GetOriginalInputEvent().GetNotificationType() == ESecurityNotificationType.ALARM )
					{
						if( evt.GetOriginalInputEvent().GetStimTypeTriggeredAlarm() == gamedataStimType.DeadBody )
						{
							m_isAlertedByDeadBody = true;
						}
						else
						{
							m_stolenVehicle = ( ( VehicleObject )( evt.GetOriginalInputEvent().GetNotifierHandle().GetOwnerEntityWeak() ) );
						}
					}
					TriggerAlerted();
				}
			break;
			default:
				break;
		}
	}

	private function ReflectSecSysStateToHLS( securityState : ESecuritySystemState ) : Bool
	{
		switch( securityState )
		{
			case ESecuritySystemState.COMBAT:
				if( m_highLevelState == gamedataNPCHighLevelState.Combat )
				{
					return true;
				}
			return false;
			case ESecuritySystemState.ALERTED:
				if( m_highLevelState == gamedataNPCHighLevelState.Alerted )
				{
					return true;
				}
			return false;
			case ESecuritySystemState.SAFE:
				if( m_highLevelState == gamedataNPCHighLevelState.Relaxed )
				{
					return true;
				}
			return false;
			default:
				return false;
		}
	}

	private function TriggerAlerted()
	{
		var ownerPuppet : ScriptedPuppet;
		ownerPuppet = GetOwnerPuppet();
		if( ( ( !( ownerPuppet.GetSecuritySystem().IsReprimandOngoing() ) && ownerPuppet.GetHighLevelStateFromBlackboard() == gamedataNPCHighLevelState.Relaxed ) && !( ownerPuppet.IsCharacterCivilian() ) ) && !( ownerPuppet.IsCharacterChildren() ) )
		{
			NPCPuppet.ChangeHighLevelState( GetOwner(), gamedataNPCHighLevelState.Alerted );
		}
	}

	private function TriggerCombat( trespasser : weak< GameObject > )
	{
		var ownerPuppet : ScriptedPuppet;
		var broadcaster : StimBroadcasterComponent;
		ownerPuppet = GetOwnerPuppet();
		if( ownerPuppet.IsCharacterCivilian() )
		{
			broadcaster = trespasser.GetStimBroadcasterComponent();
			if( broadcaster )
			{
				broadcaster.SendDrirectStimuliToTarget( GetOwner(), gamedataStimType.SecurityBreach, GetOwner() );
			}
		}
		if( AIActionHelper.TryChangingAttitudeToHostile( ownerPuppet, trespasser ) )
		{
			TargetTrackingExtension.InjectThreat( ownerPuppet, trespasser );
		}
	}

	protected event OnReactionBehaviorStatus( evt : ReactionBehaviorStatus )
	{
		switch( evt.status )
		{
			case AIbehaviorUpdateOutcome.IN_PROGRESS:
				if( m_desiredReaction )
				{
					OnReactionStarted( evt.reactionData );
				}
				else
				{
					m_activeReaction = evt.reactionData;
				}
			break;
			default:
				OnReactionEnded();
			break;
		}
	}

	protected event OnEndLookatEvent( evt : EndLookatEvent )
	{
		if( !( m_inReactionSequence ) )
		{
			DeactiveLookAt( evt.repeat );
		}
	}

	protected event OnTerminateReactionLookatEvent( evt : TerminateReactionLookatEvent )
	{
		DeactiveLookAt();
	}

	protected event OnRepeatLookatEvent( evt : RepeatLookatEvent )
	{
		m_lookatRepeat = false;
		if( m_playerProximity && !( m_inReactionSequence ) )
		{
			TriggerFacialLookAtReaction( false, true );
		}
	}

	protected event OnEventReceived( stimEvent : StimuliEvent )
	{
		if( !( IsStimuliEventValid( stimEvent ) ) )
		{
			return NULL;
		}
		HandleStimEventByTask( stimEvent );
	}

	protected event OnAIEvent( aiEvent : AIEvent )
	{
		if( aiEvent.name == 'ReprimandSuccessful' )
		{
			GetOwnerPuppet().TriggerSecuritySystemNotification( m_activeReaction.stimTarget.GetWorldPosition(), m_activeReaction.stimTarget, ESecurityNotificationType.REPRIMAND_SUCCESSFUL );
		}
		if( aiEvent.name == 'TriggerCombatReaction' )
		{
			TriggerPendingReaction();
			m_inPendingBehavior = false;
		}
		if( aiEvent.name == 'TriggerPendingReaction' )
		{
			TriggerPendingReaction();
			m_inPendingBehavior = false;
		}
	}

	private function Initialiaze()
	{
		var puppetBlackboard : IBlackboard;
		m_delay = TweakDBInterface.GetVector2( T"AIGeneralSettings.reactionDelay", Vector2( 0.30000001, 0.69999999 ) );
		puppetBlackboard = GetOwnerPuppet().GetPuppetStateBlackboard();
		if( puppetBlackboard )
		{
			if( puppetBlackboard.GetBool( GetAllBlackboardDefs().PuppetState.InPendingBehavior ) )
			{
				m_inPendingBehavior = true;
			}
			m_pendingBehaviorCb = puppetBlackboard.RegisterListenerBool( GetAllBlackboardDefs().PuppetState.InPendingBehavior, this, 'OnPendingBehaviorChanged' );
		}
	}

	private function CacheEvent( stimData : StimEventTaskData )
	{
		var stimEvent : StimuliEvent;
		stimEvent = stimData.cachedEvt;
		if( m_stimuliCache.Size() > 0 )
		{
			if( !( IsEventDuplicated( stimEvent ) ) )
			{
				if( m_stimuliCache.Size() > 4 )
				{
					m_stimuliCache.Remove( m_stimuliCache[ 0 ] );
				}
				stimData.id = ( ( Uint32 )( m_stimuliCache.Size() ) );
				m_stimuliCache.PushBack( stimData );
			}
		}
		else
		{
			stimData.id = ( ( Uint32 )( m_stimuliCache.Size() ) );
			m_stimuliCache.PushBack( stimData );
		}
	}

	private function CacheReaction( reactionData : AIReactionData )
	{
		if( m_reactionCache.Size() > 0 )
		{
			if( m_reactionCache.Size() > 4 )
			{
				m_reactionCache.Remove( m_reactionCache[ 0 ] );
			}
			reactionData.recentReactionTimeStamp = EngineTime.ToFloat( GameInstance.GetSimTime( GetOwner().GetGame() ) ) + TweakDBInterface.GetFloat( T"AIGeneralSettings.recentReactionValidTimeStamp", 120.0 );
			m_reactionCache.PushBack( reactionData );
		}
		else
		{
			reactionData.recentReactionTimeStamp = EngineTime.ToFloat( GameInstance.GetSimTime( GetOwner().GetGame() ) ) + TweakDBInterface.GetFloat( T"AIGeneralSettings.recentReactionValidTimeStamp", 120.0 );
			m_reactionCache.PushBack( reactionData );
		}
	}

	private function IsEventDuplicated( stimEvent : StimuliEvent ) : Bool
	{
		var i : Int32;
		for( i = 0; i < m_stimuliCache.Size(); i += 1 )
		{
			if( IsDuplicate( stimEvent, m_stimuliCache[ i ].cachedEvt ) )
			{
				return true;
			}
		}
		return false;
	}

	private function IsDuplicate( stimEvent : StimuliEvent, cacheStim : StimuliEvent ) : Bool
	{
		if( ( stimEvent.sourceObject == cacheStim.sourceObject ) && stimEvent.GetStimType() == cacheStim.GetStimType() )
		{
			return true;
		}
		return false;
	}

	protected event OnStimThresholdEvent( thresholdEvent : StimThresholdEvent )
	{
		var delayEvent : StimThresholdEvent;
		if( thresholdEvent.reset )
		{
			m_currentStimThresholdValue = 0;
			m_timeStampThreshold = 0.0;
		}
		else
		{
			if( ( m_currentStimThresholdValue == 0 ) && ( m_timeStampThreshold == 0.0 ) )
			{
				m_timeStampThreshold = EngineTime.ToFloat( GameInstance.GetSimTime( GetOwner().GetGame() ) ) + thresholdEvent.timeThreshold;
				delayEvent = new StimThresholdEvent;
				delayEvent.reset = true;
				GameInstance.GetDelaySystem( GetOwnerPuppet().GetGame() ).DelayEvent( GetOwner(), delayEvent, thresholdEvent.timeThreshold );
			}
			m_currentStimThresholdValue += 1;
		}
	}

	protected event OnStealthStimThresholdEvent( thresholdEvent : StealthStimThresholdEvent )
	{
		var delayEvent : StealthStimThresholdEvent;
		if( thresholdEvent.reset )
		{
			m_currentStealthStimThresholdValue = 0;
			m_stealthTimeStampThreshold = 0.0;
		}
		else
		{
			if( ( m_currentStealthStimThresholdValue == 0 ) && ( m_stealthTimeStampThreshold == 0.0 ) )
			{
				m_stealthTimeStampThreshold = EngineTime.ToFloat( GameInstance.GetSimTime( GetOwner().GetGame() ) ) + thresholdEvent.timeThreshold;
				delayEvent = new StealthStimThresholdEvent;
				delayEvent.reset = true;
				GameInstance.GetDelaySystem( GetOwnerPuppet().GetGame() ).DelayEvent( GetOwner(), delayEvent, thresholdEvent.timeThreshold );
			}
			m_currentStealthStimThresholdValue += 1;
		}
	}

	public function GetIgnoreList() : array< EntityID >
	{
		return m_ignoreList;
	}

	private function IsStimuliEventValid( stimEvent : StimuliEvent ) : Bool
	{
		var owner : GameObject;
		if( ( stimEvent.sourceObject == NULL ) || Vector4.IsZero( stimEvent.sourcePosition ) )
		{
			return false;
		}
		owner = GetOwner();
		if( stimEvent.sourceObject == owner )
		{
			return false;
		}
		if( stimEvent.GetStimType() == gamedataStimType.Invalid )
		{
			return false;
		}
		if( owner.IsPlayer() )
		{
			return false;
		}
		return true;
	}

	private function ShouldEventBeProcessed( stimEvent : StimuliEvent ) : Bool
	{
		if( !( ScriptedPuppet.IsActive( GetOwner() ) ) || ScriptedPuppet.IsUnconscious( GetOwner() ) )
		{
			return false;
		}
		if( !( stimEvent.stimRecord.IsReactionStim() ) )
		{
			return false;
		}
		if( m_reactionPreset.Type() == gamedataReactionPresetType.NoReaction )
		{
			return false;
		}
		if( m_puppetReactionBlackboard.GetBool( GetAllBlackboardDefs().PuppetReaction.blockReactionFlag ) )
		{
			return false;
		}
		return true;
	}

	private function ShouldStimBeProcessed( stimEvent : StimuliEvent ) : Bool
	{
		var reactionData : AIReactionData;
		var stimData : StimEventData;
		var investigateData : stimInvestigateData;
		var investigators : array< EntityID >;
		var broadcaster : StimBroadcasterComponent;
		var reevaluateDetectionOverwriteEvent : ReevaluateDetectionOverwriteEvent;
		var delayStimEvent : DelayStimEvent;
		var allyReactionCmp : ReactionManagerComponent;
		var device : Device;
		var stimType : gamedataStimType;
		var owner : GameObject;
		var ownerPuppet : ScriptedPuppet;
		var delaySystem : DelaySystem;
		var ownerSecuritySystem : SecuritySystemControllerPS;
		var aiComponent : AIHumanComponent;
		var context : ScriptExecutionContext;
		var stimTags : array< CName >;
		owner = GetOwner();
		ownerPuppet = GetOwnerPuppet();
		reactionData = m_desiredReaction;
		if( !( reactionData ) )
		{
			reactionData = m_activeReaction;
		}
		stimType = stimEvent.GetStimType();
		if( stimType == gamedataStimType.MeleeAttack && WeaponObject.IsFists( GameObject.GetActiveWeapon( stimEvent.sourceObject ).GetItemID() ) )
		{
			return false;
		}
		if( stimType == gamedataStimType.WeaponDisplayed && !( CanAskToHolsterWeapon() ) )
		{
			return false;
		}
		if( IsCategory( stimEvent, 'Security' ) )
		{
			if( stimEvent.sourceObject.IsPuppet() && !( owner.IsTargetTresspassingMyZone( stimEvent.sourceObject ) ) )
			{
				return false;
			}
		}
		if( IsPublicZone( stimEvent ) && !( IsPlayerInZone( gamePSMZones.Public ) ) )
		{
			return false;
		}
		if( stimEvent.stimPropagation == gamedataStimPropagation.Visual )
		{
			if( ( ( ScriptedPuppet )( stimEvent.sourceObject ) ) )
			{
				if( !( IsTargetVisible( stimEvent.sourceObject ) ) )
				{
					if( stimType == gamedataStimType.Gunshot )
					{
						if( ValidVisualGunshotTarget( stimEvent, reactionData ) )
						{
							if( !( IsVisible( stimEvent, Vector4( 0.0, 0.0, 0.80000001, 0.0 ) ) ) )
							{
								return false;
							}
						}
						else
						{
							return false;
						}
					}
					else
					{
						return false;
					}
				}
			}
			else
			{
				if( !( IsTargetInFront( stimEvent.sourceObject ) ) )
				{
					return false;
				}
				else if( !( IsTargetClose( stimEvent.sourceObject ) ) )
				{
					return false;
				}
				else if( GameInstance.GetWorkspotSystem( owner.GetGame() ).IsActorInWorkspot( owner ) )
				{
					if( StatusEffectSystem.ObjectHasStatusEffectWithTag( owner, 'Braindance' ) || StatusEffectSystem.ObjectHasStatusEffectWithTag( owner, 'Sleep' ) )
					{
						return false;
					}
				}
			}
		}
		if( stimEvent.stimPropagation == gamedataStimPropagation.Audio && !( IsDirectStimuli( stimType ) ) )
		{
			if( !( IsTargetVisible( stimEvent.sourceObject ) ) )
			{
				if( !( ownerPuppet.GetSensesComponent().IsHearingEnabled() ) )
				{
					return false;
				}
				if( StatusEffectSystem.ObjectHasStatusEffectWithTag( owner, 'HearingImpaired' ) && !( CheckHearingDistance( stimEvent ) ) )
				{
					return false;
				}
			}
		}
		if( stimType != gamedataStimType.Combat && ScriptedPuppet.IsBeingGrappled( ownerPuppet ) )
		{
			return false;
		}
		if( ( stimType == gamedataStimType.AimingAt && m_reactionPreset.IsAggressive() ) && IsReactionAvailableInPreset( gamedataStimType.AimingAt ) )
		{
			delaySystem = GameInstance.GetDelaySystem( owner.GetGame() );
			delaySystem.CancelDelay( m_delayDetectionEventID );
			reevaluateDetectionOverwriteEvent = new ReevaluateDetectionOverwriteEvent;
			reevaluateDetectionOverwriteEvent.target = stimEvent.sourceObject;
			m_delayDetectionEventID = delaySystem.DelayEvent( owner, reevaluateDetectionOverwriteEvent, 0.1 );
			delaySystem.CancelDelay( m_delayStimEventID );
			delayStimEvent = new DelayStimEvent;
			delayStimEvent.stimEvent = stimEvent;
			m_delayStimEventID = delaySystem.DelayEvent( owner, delayStimEvent, 0.34999999 );
			return false;
		}
		if( IgnoreStimIfNonFriendly( stimEvent ) && !( SourceAttitude( stimEvent.sourceObject, EAIAttitude.AIA_Friendly ) ) )
		{
			return false;
		}
		stimTags = stimEvent.stimRecord.Tags();
		if( stimTags.Contains( 'Stealth' ) && !( ReactOnPlayerStealthStim( owner, stimEvent.sourceObject ) ) )
		{
			return false;
		}
		if( stimTags.Contains( 'Security' ) && !( ownerPuppet.IsConnectedToSecuritySystem() ) )
		{
			return false;
		}
		if( stimTags.Contains( 'PlayerOnly' ) && !( stimEvent.sourceObject.IsDevice() ) )
		{
			investigateData = stimEvent.stimInvestigateData;
			if( !( stimEvent.sourceObject.IsPlayer() ) && !( investigateData.attackInstigator ) )
			{
				return false;
			}
			else if( investigateData.attackInstigator && !( ( ( GameObject )( investigateData.attackInstigator ) ).IsPlayer() ) )
			{
				return false;
			}
		}
		if( SourceAttitude( stimEvent.sourceObject, EAIAttitude.AIA_Friendly ) )
		{
			if( stimTags.Contains( 'IgnoreFriendly' ) && !( stimEvent.sourceObject.IsDevice() ) )
			{
				return false;
			}
			if( m_highLevelState == gamedataNPCHighLevelState.Combat && !( stimTags.Contains( 'AllowFriendlyInCombat' ) ) )
			{
				return false;
			}
			if( ShouldHelpAlly( stimType ) )
			{
				if( ( IsTargetFromSameAttitudeGroup( stimEvent.sourceObject ) || IsTargetSquadAlly( stimEvent.sourceObject ) ) || IsTargetRecentSquadAlly( stimEvent.sourceObject ) )
				{
					HelpAlly( stimEvent.sourceObject, investigateData.attackInstigator );
					allyReactionCmp = ( ( ScriptedPuppet )( stimEvent.sourceObject ) ).GetStimReactionComponent();
					if( ownerPuppet )
					{
						ownerSecuritySystem = ownerPuppet.GetSecuritySystem();
						if( ( ownerSecuritySystem && ( ( ScriptedPuppet )( stimEvent.sourceObject ) ) ) && allyReactionCmp )
						{
							if( ( ( ownerSecuritySystem.IsReprimandOngoing() && ownerSecuritySystem.GetReprimandPerformer() ) || allyReactionCmp.GetReactionPreset().Type() == gamedataReactionPresetType.Civilian_Guard ) || allyReactionCmp.GetActiveReactionData().reactionBehaviorName == gamedataOutput.BackOff )
							{
								broadcaster = GetPlayerSystem().GetLocalPlayerControlledGameObject().GetStimBroadcasterComponent();
								if( broadcaster )
								{
									broadcaster.SendDrirectStimuliToTarget( owner, gamedataStimType.SoundDistraction, owner );
								}
								return false;
							}
						}
					}
					if( stimType != gamedataStimType.Call && stimType != gamedataStimType.Dying )
					{
						return false;
					}
				}
				else
				{
					return false;
				}
			}
		}
		if( CheckSquadInvestigation( stimData ) )
		{
			return false;
		}
		if( ( IsSameStimulus( stimEvent ) && IsSameSourceObject( stimEvent ) ) && IgnoreStimIfFromSameSource( stimEvent ) )
		{
			return false;
		}
		if( reactionData && !( IsStimPriorityValid( stimEvent, reactionData.stimPriority ) ) )
		{
			return false;
		}
		stimData = FillStimData( stimEvent );
		if( m_ignoreList.Contains( stimEvent.sourceObject.GetEntityID() ) )
		{
			return false;
		}
		if( GameObject.IsCooldownActive( owner, EnumValueToName( 'gamedataStimType', ( ( Int32 )( stimType ) ) ) ) )
		{
			return false;
		}
		if( ( stimType == gamedataStimType.AreaEffect && !( m_inPendingBehavior ) ) && !( ownerPuppet.IsCharacterCivilian() ) )
		{
			return false;
		}
		if( ( m_desiredReaction && m_desiredReaction.stimType == stimType ) && GameObject.IsCooldownActive( owner, StringToName( "ovefloodCooldown" + EnumValueToString( "gamedataStimType", ( ( Int32 )( m_desiredReaction.stimType ) ) ) ) ) )
		{
			return false;
		}
		if( stimType == gamedataStimType.GrenadeLanded && !( ShouldTriggerGrenadeDodgeBehavior( stimEvent ) ) )
		{
			return false;
		}
		if( stimType == gamedataStimType.DeviceExplosion && !( CanTriggerPanicInCombat( stimEvent ) ) )
		{
			return false;
		}
		if( ownerPuppet.IsCharacterPolice() && !( ShouldPoliceReact( stimEvent ) ) )
		{
			return false;
		}
		if( ShouldBeDetected( stimType ) && !( IsTargetDetected( stimEvent.sourceObject ) ) )
		{
			return false;
		}
		if( stimType == gamedataStimType.Distract )
		{
			device = ( ( Device )( stimEvent.sourceObject ) );
			investigators = device.GetDevicePS().GetWillingInvestigators();
			if( !( investigators.Contains( owner.GetEntityID() ) ) && IsTargetInFront( stimEvent.sourceObject, 180.0 ) )
			{
				if( !( ownerPuppet.IsInvestigating() ) && ( investigators.Size() != 0 ) )
				{
					ActivateReactionLookAt( stimEvent.sourceObject, true, false, 1.0, true );
				}
				return false;
			}
		}
		if( stimType == gamedataStimType.Explosion )
		{
			aiComponent = ownerPuppet.GetAIControllerComponent();
			if( aiComponent && ( ( ( weak< weak< GameObject > > )( aiComponent.GetBehaviorArgument( 'StimTarget' ) ) ) == reactionData.stimTarget ) )
			{
				if( AIHumanComponent.GetScriptContext( ownerPuppet, context ) )
				{
					ScriptExecutionContext.SetArgumentObject( context, 'StimTarget', NULL );
					ScriptExecutionContext.GetTweakActionSystem( context ).ForceDirty( context, T"AIActionTarget.StimTarget" );
				}
			}
		}
		if( HasCombatTarget() )
		{
			if( CanStimInterruptCombat( stimEvent ) )
			{
				ScriptedPuppet.SendActionSignal( ownerPuppet, 'GracefulCombatInterruption', 2.0 );
				m_inPendingBehavior = true;
			}
			else
			{
				if( ShouldUpdateThreatPosition( stimEvent ) )
				{
					ownerPuppet.GetTargetTrackerComponent().AddThreat( stimEvent.sourceObject, true, stimEvent.sourceObject.GetWorldPosition(), 1.0, -1.0, false );
				}
				return false;
			}
		}
		return true;
	}

	private function ProcessStimParams( stimEvent : StimuliEvent ) : StimParams
	{
		var stimParams : StimParams;
		var reactionOutput : ReactionOutput;
		var stimData : StimEventData;
		var rules : array< weak< Rule_Record > >;
		var owner : GameObject;
		owner = GetOwner();
		stimData = FillStimData( stimEvent );
		rules = GetRules();
		reactionOutput = GetReactionOutput( stimEvent.GetStimType(), rules );
		if( GameInstance.GetWorkspotSystem( owner.GetGame() ).IsActorInWorkspot( owner ) )
		{
			reactionOutput.startedInWorkspot = true;
			if( GetOwnerPuppet().IsCharacterCivilian() )
			{
				reactionOutput.workspotReaction = GameInstance.GetWorkspotSystem( owner.GetGame() ).IsReactionAvailable( owner, reactionOutput.workspotReactionType );
			}
		}
		stimParams.stimData = stimData;
		stimParams.reactionOutput = reactionOutput;
		return stimParams;
	}

	private virtual function FillStimData( stimEvent : StimuliEvent ) : StimEventData
	{
		var data : StimEventData;
		data.source = stimEvent.sourceObject;
		data.stimType = stimEvent.GetStimType();
		return data;
	}

	private const function IsReactionAvailableInPreset( stimTrigger : gamedataStimType ) : Bool
	{
		var reactionPresetOutput : ReactionOutput;
		reactionPresetOutput = GetReactionOutput( stimTrigger, GetRules() );
		if( reactionPresetOutput.reactionBehavior != gamedataOutput.Ignore && reactionPresetOutput.reactionBehavior != gamedataOutput.Invalid )
		{
			return true;
		}
		return false;
	}

	private function CreateFearThreashold()
	{
		var statSystem : StatsSystem;
		var statMod : gameStatModifierData;
		statSystem = GameInstance.GetStatsSystem( GetOwner().GetGame() );
		statMod = RPGManager.CreateStatModifier( gamedataStatType.PersonalityFear, gameStatModifierType.Additive, m_reactionPreset.FearThreshold() );
		statSystem.AddModifier( GetOwner().GetEntityID(), statMod );
	}

	private function AddReactionValueToStatPool( reactionData : AIReactionData )
	{
		var statPoolSystem : StatPoolsSystem;
		var securitySystem : SecuritySystemControllerPS;
		var ownerPuppet : ScriptedPuppet;
		var ownerId : EntityID;
		ownerPuppet = GetOwnerPuppet();
		statPoolSystem = GameInstance.GetStatPoolsSystem( ownerPuppet.GetGame() );
		if( ( ( reactionData && reactionData.reactionBehaviorName == gamedataOutput.TurnAt ) && reactionData.stimTarget.IsPuppet() ) && IsTargetVisible( reactionData.stimTarget ) )
		{
			return;
		}
		securitySystem = ownerPuppet.GetSecuritySystem();
		if( securitySystem && !( securitySystem.IsReprimandOngoing() ) )
		{
			if( reactionData.stimRecord.Fear() > 0.0 )
			{
				ownerId = ownerPuppet.GetEntityID();
				statPoolSystem.RequestSettingModifierWithRecord( ownerId, gamedataStatPoolType.Fear, gameStatPoolModificationTypes.Decay, T"BaseStatPools.ReactionValueDecay" );
				statPoolSystem.RequestChangingStatPoolValue( ownerId, gamedataStatPoolType.Fear, reactionData.stimRecord.Fear(), NULL, true, false );
			}
		}
	}

	private const function GetRules() : array< weak< Rule_Record > >
	{
		var rules : array< weak< Rule_Record > >;
		m_reactionPreset.Rules( rules );
		return rules;
	}

	private const function GetReactionOutput( stimType : gamedataStimType, rules : array< weak< Rule_Record > > ) : ReactionOutput
	{
		var reactionOutput : ReactionOutput;
		var i : Int32;
		for( i = 0; i < rules.Size(); i += 1 )
		{
			if( StimRule( rules[ i ], stimType ) )
			{
				reactionOutput.reactionPriority = rules[ i ].Output().Priority();
				reactionOutput.AIbehaviorPriority = rules[ i ].Output().AIPriority();
				reactionOutput.reactionCooldown = rules[ i ].Cooldown();
				reactionOutput.reactionBehavior = rules[ i ].Output().Type();
				reactionOutput.workspotReactionType = rules[ i ].WorkspotOutput();
				break;
			}
			else
			{
				reactionOutput.reactionBehavior = gamedataOutput.Ignore;
			}
		}
		return reactionOutput;
	}

	private const function StimRule( rule : weak< Rule_Record >, stimType : gamedataStimType ) : Bool
	{
		if( rule && rule.Stimulus().Type() == stimType )
		{
			return true;
		}
		return false;
	}

	private function ProcessReactionOutput( stimData : StimEventTaskData, stimParams : StimParams )
	{
		var reactionData : AIReactionData;
		var grenade : BaseGrenade;
		var owner : GameObject;
		var ownerPuppet : ScriptedPuppet;
		var stimEvent : StimuliEvent;
		owner = GetOwner();
		ownerPuppet = GetOwnerPuppet();
		stimEvent = stimData.cachedEvt;
		reactionData = m_desiredReaction;
		if( !( reactionData ) )
		{
			reactionData = m_activeReaction;
		}
		grenade = ( ( BaseGrenade )( stimEvent.sourceObject ) );
		if( ( grenade && HasCombatTarget() ) && stimEvent.GetStimType() == gamedataStimType.ProjectileDistraction )
		{
			stimEvent.SetStimType( gamedataStimType.GrenadeLanded );
			stimParams = ProcessStimParams( stimEvent );
		}
		if( stimParams.reactionOutput.reactionBehavior == gamedataOutput.Panic && ownerPuppet.IsBoss() )
		{
			return;
		}
		if( stimParams.reactionOutput.workspotReaction )
		{
			if( GameInstance.GetWorkspotSystem( owner.GetGame() ).SendReactionSignal( owner, stimParams.reactionOutput.workspotReactionType ) )
			{
				return;
			}
		}
		if( stimParams.reactionOutput.reactionBehavior == gamedataOutput.Ignore )
		{
			return;
		}
		if( stimParams.reactionOutput.reactionBehavior == gamedataOutput.LookAt )
		{
			if( IsTargetInFront( stimEvent.sourceObject ) || stimEvent.GetStimType() == gamedataStimType.Attention )
			{
				GameObject.PlayVoiceOver( owner, 'stlh_curious_grunt', 'Scripts:ProcessReactionOutput' );
				ActivateReactionLookAt( stimEvent.sourceObject, true );
				return;
			}
			stimParams.reactionOutput.reactionBehavior = gamedataOutput.TurnAt;
			TriggerBehaviorReaction( stimParams.reactionOutput, stimData, stimParams.stimData );
		}
		if( stimEvent.GetStimType() == gamedataStimType.OpeningDoor )
		{
			if( IsTargetInFront( stimEvent.sourceObject ) )
			{
				GameObject.PlayVoiceOver( owner, 'stlh_curious_grunt', 'Scripts:ProcessReactionOutput' );
				ActivateReactionLookAt( stimEvent.sourceObject, true );
				return;
			}
		}
		if( stimParams.reactionOutput.reactionBehavior == gamedataOutput.Intruder && !( StatusEffectSystem.ObjectHasStatusEffectWithTag( owner, 'LoreAnim' ) ) )
		{
			if( GameInstance.GetWorkspotSystem( owner.GetGame() ).IsActorInWorkspot( owner ) )
			{
				if( TriggerCombatFromHostileStim( stimEvent.GetStimType() ) && AIActionHelper.TryChangingAttitudeToHostile( ownerPuppet, stimEvent.sourceObject ) )
				{
					if( SenseComponent.ShouldIgnoreIfPlayerCompanion( owner, stimEvent.sourceObject ) )
					{
						return;
					}
					TargetTrackingExtension.InjectThreat( ownerPuppet, stimEvent.sourceObject );
					return;
				}
				else if( TriggerAlertedFromHostileStim( stimEvent ) )
				{
					NPCPuppet.ChangeHighLevelState( owner, gamedataNPCHighLevelState.Alerted );
					CacheEvent( stimData );
					return;
				}
			}
			if( IsSquadMateInDanger( stimParams.reactionOutput.reactionBehavior ) )
			{
				if( AIActionHelper.TryChangingAttitudeToHostile( ownerPuppet, stimEvent.sourceObject ) )
				{
					TargetTrackingExtension.InjectThreat( ownerPuppet, stimEvent.sourceObject );
					return;
				}
			}
		}
		if( reactionData && ( stimParams.reactionOutput.reactionPriority < reactionData.reactionPriority ) )
		{
			return;
		}
		if( m_pendingReaction && ( stimParams.reactionOutput.reactionPriority < m_pendingReaction.reactionPriority ) )
		{
			return;
		}
		if( ( m_activeReaction && m_activeReaction.reactionBehaviorName == stimParams.reactionOutput.reactionBehavior ) && m_activeReaction.reactionBehaviorName != gamedataOutput.DeviceInvestigate )
		{
			UpdateActiveReaction( stimParams.reactionOutput, stimEvent, stimParams.stimData, m_updateByActive );
		}
		else
		{
			if( ( ( reactionData && m_desiredReaction ) && reactionData.reactionBehaviorName == stimParams.reactionOutput.reactionBehavior ) && GameObject.IsCooldownActive( owner, StringToName( "ovefloodCooldown" + EnumValueToString( "gamedataOutput", ( ( Int32 )( m_desiredReaction.reactionBehaviorName ) ) ) ) ) )
			{
				return;
			}
			TriggerBehaviorReaction( stimParams.reactionOutput, stimData, stimParams.stimData );
		}
	}

	private function UpdateActiveReaction( reaction : ReactionOutput, stimEvent : StimuliEvent, stimData : StimEventData, updateByActive : Bool )
	{
		var updateStimSourceAIEvent : StimuliEvent;
		var resetDesiredReactionData : ResetReactionEvent;
		var owner : GameObject;
		var stimName : CName;
		owner = GetOwner();
		GameInstance.GetDelaySystem( owner.GetGame() ).CancelDelay( m_resetReactionDataID );
		if( updateByActive )
		{
			m_desiredReaction = m_activeReaction;
		}
		else
		{
			m_desiredReaction = new AIReactionData;
			m_desiredReaction.reactionBehaviorName = reaction.reactionBehavior;
			m_desiredReaction.stimPriority = stimEvent.stimRecord.Priority().Type();
			m_desiredReaction.stimTarget = stimEvent.sourceObject;
			m_desiredReaction.stimSource = GetStimSource( stimEvent );
			m_desiredReaction.stimType = stimEvent.GetStimType();
			m_desiredReaction.stimRecord = stimEvent.stimRecord;
			m_desiredReaction.stimEventData = stimData;
			m_desiredReaction.reactionPriority = reaction.reactionPriority;
			m_desiredReaction.stimInvestigateData = stimEvent.stimInvestigateData;
			m_desiredReaction.reactionBehaviorAIPriority = reaction.AIbehaviorPriority;
			m_desiredReaction.reactionCooldown = reaction.reactionCooldown;
			m_desiredReaction.initAnimInWorkspot = reaction.startedInWorkspot;
		}
		if( m_desiredReaction.reactionBehaviorName == gamedataOutput.DeviceInvestigate && !( IsInList( m_investigationList, stimData ) ) )
		{
			m_investigationList.PushBack( stimData );
		}
		updateStimSourceAIEvent = new StimuliEvent;
		updateStimSourceAIEvent.name = 'updateSource';
		owner.QueueEvent( updateStimSourceAIEvent );
		stimName = EnumValueToName( 'gamedataStimType', ( ( Int32 )( m_desiredReaction.stimType ) ) );
		if( m_desiredReaction.reactionCooldown != 0.0 )
		{
			GameObject.StartCooldown( owner, stimName, m_desiredReaction.reactionCooldown );
		}
		if( !( GameObject.IsCooldownActive( owner, 'ActiveReactionValueCooldown-' + stimName ) ) && !( GetOwnerPuppet().GetSecuritySystem().IsReprimandOngoing() ) )
		{
			AddReactionValueToStatPool( m_desiredReaction );
			GameObject.StartCooldown( owner, 'ActiveReactionValueCooldown-' + stimName, 1.0 );
		}
		resetDesiredReactionData = new ResetReactionEvent;
		resetDesiredReactionData.data = m_desiredReaction;
		m_resetReactionDataID = GameInstance.GetDelaySystem( owner.GetGame() ).DelayEvent( owner, resetDesiredReactionData, 1.0 );
	}

	private virtual function TriggerBehaviorReaction( reaction : ReactionOutput, stimTaskData : StimEventTaskData, stimData : StimEventData )
	{
		var triggerAIEvent : StimuliEvent;
		var exitEvent : AIEvent;
		var owner : GameObject;
		var game : GameInstance;
		var stimEvent : StimuliEvent;
		owner = GetOwner();
		DeactiveLookAt();
		game = owner.GetGame();
		stimEvent = stimTaskData.cachedEvt;
		GameInstance.GetDelaySystem( game ).CancelDelay( m_resetReactionDataID );
		m_desiredReaction = new AIReactionData;
		m_desiredReaction.reactionBehaviorName = reaction.reactionBehavior;
		m_desiredReaction.stimPriority = stimEvent.stimRecord.Priority().Type();
		m_desiredReaction.stimTarget = stimEvent.sourceObject;
		m_desiredReaction.stimType = stimEvent.GetStimType();
		m_desiredReaction.stimSource = GetStimSource( stimEvent );
		m_desiredReaction.stimRecord = stimEvent.stimRecord;
		m_desiredReaction.reactionPriority = reaction.reactionPriority;
		m_desiredReaction.stimInvestigateData = stimEvent.stimInvestigateData;
		m_desiredReaction.stimEventData = stimData;
		m_desiredReaction.reactionBehaviorAIPriority = reaction.AIbehaviorPriority;
		m_desiredReaction.reactionCooldown = reaction.reactionCooldown;
		m_desiredReaction.initAnimInWorkspot = reaction.startedInWorkspot;
		GameObject.StartCooldown( owner, StringToName( "ovefloodCooldown" + EnumValueToString( "gamedataStimType", ( ( Int32 )( m_desiredReaction.stimType ) ) ) ), m_ovefloodCooldown );
		GameObject.StartCooldown( owner, StringToName( "ovefloodCooldown" + EnumValueToString( "gamedataOutput", ( ( Int32 )( m_desiredReaction.reactionBehaviorName ) ) ) ), 0.5 );
		triggerAIEvent = new StimuliEvent;
		triggerAIEvent.SetStimType( gamedataStimType.Invalid );
		if( IsInPendingBehavior() )
		{
			m_pendingReaction = m_desiredReaction;
			m_pendingReaction.validTillTimeStamp = EngineTime.ToFloat( GameInstance.GetSimTime( game ) ) + TweakDBInterface.GetFloat( T"AIGeneralSettings.pendingReactionValidTimeStamp", 10.0 );
			m_desiredReaction = NULL;
			if( reaction.reactionBehavior == gamedataOutput.Reprimand && VehicleComponent.IsMountedToVehicle( game, owner ) )
			{
				exitEvent = new AIEvent;
				exitEvent.name = 'ExitVehicle';
				owner.QueueEvent( exitEvent );
			}
		}
		else
		{
			triggerAIEvent.name = 'triggerReaction';
			if( ( m_activeReaction && m_activeReaction.reactionBehaviorName == gamedataOutput.BodyInvestigate ) && AISquadHelper.IsSignalActive( GetOwnerPuppet(), 'BodyInvestigationTicketReceived' ) )
			{
				OnBodyInvestigated( new BodyInvestigatedEvent );
			}
			if( FirstSquadMemberReaction() && !( DelayReaction( stimEvent.GetStimType() ) ) )
			{
				owner.QueueEvent( triggerAIEvent );
			}
			else
			{
				m_delayReactionEventID = GameInstance.GetDelaySystem( game ).DelayEvent( owner, triggerAIEvent, RandRangeF( 0.2, 0.69999999 ) );
			}
			if( ( ( reaction.reactionBehavior == gamedataOutput.Flee || reaction.reactionBehavior == gamedataOutput.Surrender ) || reaction.reactionBehavior == gamedataOutput.WalkAway ) || reaction.reactionBehavior == gamedataOutput.CallGuard )
			{
				NPCPuppet.ChangeHighLevelState( owner, gamedataNPCHighLevelState.Fear );
				AnimationControllerComponent.SetAnimWrapperWeightOnOwnerAndItems( owner, GetFearAnimWrapper( GetFearReactionPhase( stimEvent ) ), 1.0 );
				if( !( m_fearLocomotionWrapper ) )
				{
					AnimationControllerComponent.SetAnimWrapperWeightOnOwnerAndItems( owner, GetRandomFearLocomotionAnimWrapper( GetFearReactionPhase( stimEvent ) ), 1.0 );
				}
			}
		}
		if( m_createThreshold )
		{
			CreateFearThreashold();
			m_createThreshold = false;
		}
		CacheEvent( stimTaskData );
	}

	private function GetStimSource( stimEvent : StimuliEvent ) : Vector4
	{
		var investigationSources : array< Vector4 >;
		var closestPosition : Vector4;
		var closestDistanceSquared : Float;
		var distanceSquared : Float;
		var navigationSystem : AINavigationSystem;
		var query : AINavigationSystemQuery;
		var queryId : Uint32;
		var result : AINavigationSystemResult;
		var sourceWorldPosition : WorldPosition;
		var path : NavigationPath;
		var owner : GameObject;
		var ownerPos : Vector4;
		var i : Int32;
		owner = GetOwner();
		ownerPos = owner.GetWorldPosition();
		investigationSources = stimEvent.movePositions;
		for( i = 0; i < investigationSources.Size(); i += 1 )
		{
			distanceSquared = Vector4.DistanceSquared( investigationSources[ i ], ownerPos );
			path = GameInstance.GetAINavigationSystem( owner.GetGame() ).CalculatePathForCharacter( ownerPos, investigationSources[ i ], 0.0, owner );
			if( !( path ) )
			{
				continue;
			}
			if( ( distanceSquared < closestDistanceSquared ) || ( closestDistanceSquared == 0.0 ) )
			{
				closestDistanceSquared = distanceSquared;
				closestPosition = investigationSources[ i ];
			}
		}
		if( !( Vector4.IsZero( closestPosition ) ) )
		{
			return closestPosition;
		}
		if( stimEvent.IsTagInStimuli( 'NavReach' ) )
		{
			navigationSystem = GameInstance.GetAINavigationSystem( owner.GetGame() );
			AIPositionSpec.SetEntity( query.source, GetEntity() );
			WorldPosition.SetVector4( sourceWorldPosition, stimEvent.sourcePosition );
			AIPositionSpec.SetWorldPosition( query.target, sourceWorldPosition );
			queryId = navigationSystem.StartPathfinding( query );
			navigationSystem.GetResult( queryId, result );
			navigationSystem.StopPathfinding( queryId );
			if( result.hasClosestReachablePoint )
			{
				return WorldPosition.ToVector4( result.closestReachablePoint );
			}
		}
		return stimEvent.sourcePosition;
	}

	private function TriggerCombatFromHostileStim( stimType : gamedataStimType ) : Bool
	{
		if( GetOwnerPuppet().IsCharacterPolice() )
		{
			return false;
		}
		if( ( ( ( ( stimType == gamedataStimType.Gunshot || stimType == gamedataStimType.Combat ) || stimType == gamedataStimType.IllegalAction ) || stimType == gamedataStimType.IllegalInteraction ) || stimType == gamedataStimType.Bullet ) || stimType == gamedataStimType.CarryBody )
		{
			return true;
		}
		return false;
	}

	private function TriggerAlertedFromHostileStim( stimEvent : StimuliEvent ) : Bool
	{
		if( GetOwnerPuppet().IsCharacterPolice() )
		{
			return true;
		}
		if( stimEvent.GetStimType() == gamedataStimType.CombatHit )
		{
			return true;
		}
		return false;
	}

	private function IsSquadMateInDanger( reaction : gamedataOutput ) : Bool
	{
		var smi : SquadScriptInterface;
		var squadMembers : array< weak< Entity > >;
		var member : ScriptedPuppet;
		var i : Int32;
		var memberDesiredReaction : AIReactionData;
		var ownerPuppet : ScriptedPuppet;
		ownerPuppet = GetOwnerPuppet();
		if( !( AISquadHelper.GetSquadMemberInterface( ownerPuppet, smi ) ) )
		{
			return false;
		}
		squadMembers = smi.ListMembersWeak();
		if( squadMembers.Size() <= 1 )
		{
			return false;
		}
		for( i = 0; i < squadMembers.Size(); i += 1 )
		{
			member = ( ( ScriptedPuppet )( squadMembers[ i ] ) );
			if( !( ScriptedPuppet.IsActive( member ) ) )
			{
				continue;
			}
			if( member == ownerPuppet )
			{
				continue;
			}
			memberDesiredReaction = member.GetStimReactionComponent().GetDesiredReactionData();
			if( memberDesiredReaction && memberDesiredReaction.reactionBehaviorName == reaction )
			{
				if( IsTargetVisible( member ) )
				{
					return true;
				}
			}
		}
		return false;
	}

	private function FirstSquadMemberReaction() : Bool
	{
		var smi : SquadScriptInterface;
		var squadMembers : array< weak< Entity > >;
		var member : ScriptedPuppet;
		var i : Int32;
		var stimDistance, distance : Float;
		var suitableSquadmate : ScriptedPuppet;
		var memberDesiredReactionData : AIReactionData;
		if( !( AISquadHelper.GetSquadMemberInterface( GetOwnerPuppet(), smi ) ) )
		{
			return true;
		}
		squadMembers = smi.ListMembersWeak();
		if( squadMembers.Size() <= 1 )
		{
			return true;
		}
		for( i = 0; i < squadMembers.Size(); i += 1 )
		{
			member = ( ( ScriptedPuppet )( squadMembers[ i ] ) );
			if( !( ScriptedPuppet.IsActive( member ) ) )
			{
				continue;
			}
			memberDesiredReactionData = member.GetStimReactionComponent().GetDesiredReactionData();
			if( ( ( m_desiredReaction && member.GetStimReactionComponent().GetReceivedStimType() != m_desiredReaction.stimType ) && memberDesiredReactionData ) && memberDesiredReactionData.stimType != m_desiredReaction.stimType )
			{
				continue;
			}
			stimDistance = Vector4.Distance( member.GetWorldPosition(), m_desiredReaction.stimSource );
			if( ( stimDistance < distance ) || ( distance == 0.0 ) )
			{
				suitableSquadmate = member;
				distance = stimDistance;
			}
		}
		if( suitableSquadmate )
		{
			return GetOwnerPuppet() == suitableSquadmate;
		}
		return true;
	}

	private virtual function TriggerPendingReaction()
	{
		var triggerAIEvent : StimuliEvent;
		var crowdMemberComponent : CrowdMemberBaseComponent;
		var owner : GameObject;
		if( !( m_pendingReaction ) )
		{
			return;
		}
		owner = GetOwner();
		if( ( m_pendingReaction.validTillTimeStamp > 0.0 ) && ( m_pendingReaction.validTillTimeStamp < EngineTime.ToFloat( GameInstance.GetSimTime( owner.GetGame() ) ) ) )
		{
			m_pendingReaction = NULL;
			return;
		}
		DeactiveLookAt();
		GameInstance.GetDelaySystem( owner.GetGame() ).CancelDelay( m_resetReactionDataID );
		m_desiredReaction = new AIReactionData;
		m_desiredReaction.reactionBehaviorName = m_pendingReaction.reactionBehaviorName;
		m_desiredReaction.stimPriority = m_pendingReaction.stimPriority;
		m_desiredReaction.stimTarget = m_pendingReaction.stimTarget;
		m_desiredReaction.stimType = m_pendingReaction.stimType;
		m_desiredReaction.stimSource = m_pendingReaction.stimSource;
		m_desiredReaction.stimRecord = m_pendingReaction.stimRecord;
		m_desiredReaction.reactionPriority = m_pendingReaction.reactionPriority;
		m_desiredReaction.stimInvestigateData = m_pendingReaction.stimInvestigateData;
		m_desiredReaction.stimEventData = m_pendingReaction.stimEventData;
		m_desiredReaction.reactionBehaviorAIPriority = m_pendingReaction.reactionBehaviorAIPriority;
		m_desiredReaction.reactionCooldown = m_pendingReaction.reactionCooldown;
		if( IsInitAnimShock( m_pendingReaction.reactionBehaviorName ) )
		{
			m_desiredReaction.initAnimInWorkspot = true;
			if( m_previousFearPhase == 2 )
			{
				m_previousFearPhase = 0;
			}
		}
		triggerAIEvent = new StimuliEvent;
		triggerAIEvent.SetStimType( gamedataStimType.Invalid );
		triggerAIEvent.name = 'triggerReaction';
		if( m_pendingReaction.reactionBehaviorName == gamedataOutput.Flee )
		{
			NPCPuppet.ChangeHighLevelState( owner, gamedataNPCHighLevelState.Fear );
			DeactiveLookAt();
			ResetFacial( 0.0 );
			TriggerFearFacial( 3 );
			AnimationControllerComponent.SetAnimWrapperWeightOnOwnerAndItems( owner, GetRandomFearLocomotionAnimWrapper( 3 ), 1.0 );
			if( m_inCrowd )
			{
				crowdMemberComponent = GetOwnerPuppet().GetCrowdMemberComponent();
				crowdMemberComponent.SetThreatLastKnownPosition( GetPlayerSystem().GetLocalPlayerMainGameObject().GetWorldPosition() );
				crowdMemberComponent.AllowWorkspotsUsage( false );
			}
		}
		owner.QueueEvent( triggerAIEvent );
		m_pendingReaction = NULL;
	}

	private function TriggerReactionBehaviorForCrowd( stimEvent : StimuliEvent, reaction : gamedataOutput, dontPlayStartUpAnimation : Bool, optional skipInitialAnimation : Bool )
	{
		var triggerAIEvent : StimuliEvent;
		var crowdMemberComponent : CrowdMemberBaseComponent;
		var stimData : stimInvestigateData;
		stimData = stimEvent.stimInvestigateData;
		m_desiredReaction = new AIReactionData;
		m_desiredReaction.reactionBehaviorName = reaction;
		m_desiredReaction.stimPriority = stimEvent.stimRecord.Priority().Type();
		m_desiredReaction.stimTarget = stimEvent.sourceObject;
		m_desiredReaction.stimType = stimEvent.GetStimType();
		m_desiredReaction.stimSource = GetStimSource( stimEvent );
		m_desiredReaction.stimRecord = stimEvent.stimRecord;
		m_desiredReaction.stimInvestigateData = stimData;
		m_desiredReaction.reactionBehaviorAIPriority = GetOutputPriority( reaction );
		m_desiredReaction.initAnimInWorkspot = dontPlayStartUpAnimation;
		if( skipInitialAnimation )
		{
			m_desiredReaction.skipInitialAnimation = skipInitialAnimation;
		}
		else
		{
			m_desiredReaction.skipInitialAnimation = stimData.skipInitialAnimation;
		}
		triggerAIEvent = new StimuliEvent;
		triggerAIEvent.SetStimType( gamedataStimType.Invalid );
		triggerAIEvent.name = 'triggerReaction';
		if( IsInPendingBehavior() && ( reaction != gamedataOutput.Flee || ( reaction == gamedataOutput.Flee && stimEvent.GetStimType() == gamedataStimType.HijackVehicle ) ) )
		{
			m_pendingReaction = m_desiredReaction;
			m_pendingReaction.validTillTimeStamp = EngineTime.ToFloat( GameInstance.GetSimTime( GetOwner().GetGame() ) ) + TweakDBInterface.GetFloat( T"AIGeneralSettings.pendingReactionValidTimeStamp", 10.0 );
			m_desiredFearPhase = -1;
			m_desiredReaction = NULL;
		}
		else
		{
			GetOwner().QueueEvent( triggerAIEvent );
			if( m_inCrowd )
			{
				crowdMemberComponent = GetOwnerPuppet().GetCrowdMemberComponent();
				crowdMemberComponent.SetThreatLastKnownPosition( GetPlayerSystem().GetLocalPlayerMainGameObject().GetWorldPosition() );
				crowdMemberComponent.AllowWorkspotsUsage( false );
			}
		}
	}

	private function TriggerReactionBehaviorForCrowd( target : GameObject, reaction : gamedataOutput, initAnimInWorkspot : Bool, optional sourcePosition : Vector4 )
	{
		var triggerAIEvent : StimuliEvent;
		var crowdMemberComponent : CrowdMemberBaseComponent;
		m_desiredReaction = new AIReactionData;
		m_desiredReaction.reactionBehaviorName = reaction;
		m_desiredReaction.stimTarget = target;
		if( Vector4.IsZero( sourcePosition ) )
		{
			m_desiredReaction.stimSource = target.GetWorldPosition();
		}
		else
		{
			m_desiredReaction.stimSource = sourcePosition;
		}
		m_desiredReaction.reactionBehaviorAIPriority = GetOutputPriority( reaction );
		m_desiredReaction.initAnimInWorkspot = initAnimInWorkspot;
		triggerAIEvent = new StimuliEvent;
		triggerAIEvent.SetStimType( gamedataStimType.Invalid );
		triggerAIEvent.name = 'triggerReaction';
		if( IsInPendingBehavior() )
		{
			m_pendingReaction = m_desiredReaction;
			m_pendingReaction.validTillTimeStamp = EngineTime.ToFloat( GameInstance.GetSimTime( GetOwner().GetGame() ) ) + TweakDBInterface.GetFloat( T"AIGeneralSettings.pendingReactionValidTimeStamp", 10.0 );
			m_desiredReaction = NULL;
		}
		else
		{
			GetOwner().QueueEvent( triggerAIEvent );
			if( ( reaction == gamedataOutput.Bump && m_activeReaction ) && ( m_activeReaction.reactionBehaviorName == gamedataOutput.Bump || m_activeReaction.reactionBehaviorName == gamedataOutput.BackOff ) )
			{
				m_desiredReaction.escalateProvoke = true;
			}
			if( m_inCrowd )
			{
				if( m_crowdFearStage != gameFearStage.Relaxed )
				{
					crowdMemberComponent = GetOwnerPuppet().GetCrowdMemberComponent();
					crowdMemberComponent.SetThreatLastKnownPosition( GetPlayerSystem().GetLocalPlayerMainGameObject().GetWorldPosition() );
					crowdMemberComponent.AllowWorkspotsUsage( false );
				}
				else if( reaction == gamedataOutput.CallPolice )
				{
					crowdMemberComponent.TryStopTrafficMovement();
				}
			}
		}
	}

	protected event OnDelayStimEvent( evt : DelayStimEvent )
	{
		if( ( ( IsPlayerAiming() && evt.stimEvent.sourceObject.IsPlayer() ) && IsTargetDetected( evt.stimEvent.sourceObject ) ) && IsReactionAvailableInPreset( gamedataStimType.AimingAt ) )
		{
			if( AIActionHelper.TryChangingAttitudeToHostile( GetOwnerPuppet(), evt.stimEvent.sourceObject ) )
			{
				TargetTrackingExtension.InjectThreat( GetOwnerPuppet(), evt.stimEvent.sourceObject );
			}
		}
	}

	private function ProcessEnvironmentalHazard( stimEvent : StimuliEvent )
	{
		var i : Int32;
		if( m_inCrowd )
		{
			return;
		}
		if( stimEvent.sourceObject )
		{
			if( !( IsTargetInFront( stimEvent.sourceObject ) ) )
			{
				return;
			}
			else if( !( IsTargetClose( stimEvent.sourceObject, stimEvent.radius ) ) )
			{
				return;
			}
		}
		else
		{
			return;
		}
		for( i = 0; i < m_environmentalHazards.Size(); i += 1 )
		{
			if( m_environmentalHazards[ i ].sourceObject == stimEvent.sourceObject )
			{
				GameInstance.GetDelaySystem( GetOwner().GetGame() ).CancelDelay( m_environmentalHazardsDelayIDs[ i ] );
				m_environmentalHazards[ i ] = stimEvent;
				m_environmentalHazardsDelayIDs[ i ] = DelayEnvironmentalHazardEvent( stimEvent );
				return;
			}
		}
		m_environmentalHazards.PushBack( stimEvent );
		m_environmentalHazardsDelayIDs.PushBack( DelayEnvironmentalHazardEvent( stimEvent ) );
	}

	private function DelayEnvironmentalHazardEvent( stimEvent : StimuliEvent ) : DelayID
	{
		var cleanEnvironmentalHazardEvent : CleanEnvironmentalHazardEvent;
		cleanEnvironmentalHazardEvent = new CleanEnvironmentalHazardEvent;
		cleanEnvironmentalHazardEvent.stimEvent = stimEvent;
		return GameInstance.GetDelaySystem( GetOwner().GetGame() ).DelayEvent( GetOwner(), cleanEnvironmentalHazardEvent, 2.0 );
	}

	protected event OnCleanEnvironmentalHazardEvent( cleanEnvironmentalHazardEvent : CleanEnvironmentalHazardEvent )
	{
		var i : Int32;
		for( i = 0; i < m_environmentalHazards.Size(); i += 1 )
		{
			if( m_environmentalHazards[ i ] == cleanEnvironmentalHazardEvent.stimEvent )
			{
				m_environmentalHazards.Remove( m_environmentalHazards[ i ] );
				m_environmentalHazardsDelayIDs.Remove( m_environmentalHazardsDelayIDs[ i ] );
			}
		}
	}

	private function InitCrowd()
	{
		m_exitWorkspotAim = TweakDBInterface.GetVector2( T"AIGeneralSettings.workspotReactionExitDelay", Vector2( 3.0, 5.0 ) );
		m_fearToIdleDistance = TweakDBInterface.GetVector2( T"AIGeneralSettings.fearToIdleDistance", Vector2( 15.0, 5.0 ) );
		m_crowdAimingReactionDistance = TweakDBInterface.GetFloat( T"AIGeneralSettings.crowdAimingReactionDistance", 20.0 );
		m_fearInPlaceAroundDistance = TweakDBInterface.GetFloat( T"AIGeneralSettings.fearInPlaceAroundDistance", 20.0 );
	}

	private function ShouldStimBeProcessedByCrowd( stimEvent : StimuliEvent ) : Bool
	{
		var vehicle : VehicleObject;
		var stimType : gamedataStimType;
		var owner : GameObject;
		var fearReactionPhase : Int32;
		var reactionSystem : ReactionSystem;
		var sceneSystemInt : SceneSystemInterface;
		owner = GetOwner();
		stimType = stimEvent.GetStimType();
		if( !( m_initCrowd ) )
		{
			InitCrowd();
			m_initCrowd = true;
		}
		if( stimType == gamedataStimType.HijackVehicle )
		{
			return true;
		}
		if( ( !( m_inCrowd ) || stimType == gamedataStimType.AimingAt ) && SourceAttitude( stimEvent.sourceObject, EAIAttitude.AIA_Friendly ) )
		{
			return false;
		}
		if( stimType == gamedataStimType.MeleeAttack && StatusEffectSystem.ObjectHasStatusEffect( stimEvent.sourceObject, T"GameplayRestriction.FistFight" ) )
		{
			return false;
		}
		if( ( ( NPCPuppet )( owner ) ).IsRagdolling() )
		{
			return false;
		}
		if( !( CanReactInVehicle( stimEvent ) ) )
		{
			return false;
		}
		if( stimEvent.stimPropagation == gamedataStimPropagation.Visual && stimType != gamedataStimType.Gunshot )
		{
			if( !( IsTargetInFront( stimEvent.sourceObject ) ) )
			{
				return false;
			}
			else if( !( IsTargetClose( stimEvent.sourceObject ) ) )
			{
				return false;
			}
			else if( !( TargetVerticalCheck( stimEvent.sourceObject ) ) )
			{
				return false;
			}
			else if( GameInstance.GetWorkspotSystem( owner.GetGame() ).IsActorInWorkspot( owner ) )
			{
				if( StatusEffectSystem.ObjectHasStatusEffectWithTag( owner, 'Braindance' ) || StatusEffectSystem.ObjectHasStatusEffectWithTag( owner, 'Sleep' ) )
				{
					return false;
				}
			}
		}
		if( ( ( ( m_desiredFearPhase > -1 ) || m_activeReaction ) || m_crowdFearStage != gameFearStage.Relaxed ) || ( m_inReactionSequence && GameInstance.GetWorkspotSystem( owner.GetGame() ).IsActorInWorkspot( owner ) ) )
		{
			if( stimType == gamedataStimType.CombatHit )
			{
				if( ( ( Bool )( GetOwnerPuppet().GetAIControllerComponent().GetBehaviorArgument( 'InFearInPlace' ) ) ) )
				{
					GameObject.PlayVoiceOver( owner, 'fear_beg', 'Scripts:ShouldStimBeProcessedByCrowd', , , true );
				}
				else if( PlayerPuppet.GetCurrentCombatState( ( ( PlayerPuppet )( stimEvent.sourceObject ) ) ) == gamePSMCombat.InCombat || !( m_activeReaction ) )
				{
					return true;
				}
			}
			fearReactionPhase = GetFearReactionPhase( stimEvent );
			if( m_desiredFearPhase >= fearReactionPhase )
			{
				return false;
			}
			if( !( ShouldInterruptCurrentFearStage( fearReactionPhase ) ) )
			{
				return false;
			}
		}
		if( !( stimEvent.IsTagInStimuli( 'CrowdReaction' ) ) && !( stimEvent.IsTagInStimuli( 'ChildDanger' ) ) )
		{
			return false;
		}
		if( m_reactionPreset.Type() != gamedataReactionPresetType.Civilian_Neutral && !( IsReactionAvailableInPreset( stimEvent.GetStimType() ) ) )
		{
			return false;
		}
		if( stimType == gamedataStimType.CrowdIllegalAction && StatusEffectSystem.ObjectHasStatusEffectWithTag( owner, 'LoreVictimSaved' ) )
		{
			return false;
		}
		if( stimType == gamedataStimType.Driving && ( ( VehicleObject )( stimEvent.sourceObject ) ) )
		{
			if( !( ( ( VehicleObject )( stimEvent.sourceObject ) ).IsOnPavement() ) )
			{
				return false;
			}
			if( ( !( IsTargetInFront( stimEvent.sourceObject, 30.0, true ) ) && !( IsTargetBehind( stimEvent.sourceObject, 160.0, true ) ) ) && !( IsTargetClose( stimEvent.sourceObject, 10.0 ) ) )
			{
				return false;
			}
			vehicle = ( ( VehicleObject )( stimEvent.sourceObject ) );
			if( vehicle )
			{
				if( vehicle.GetCurrentSpeed() < 8.0 )
				{
					return false;
				}
			}
		}
		if( GameInstance.GetGameFeatureManager( owner.GetGame() ).AggressiveCrowdsEnabled() )
		{
			reactionSystem = GameInstance.GetReactionSystem( owner.GetGame() );
			if( reactionSystem.IsRegisteredAsAggressive( owner.GetEntityID() ) )
			{
				if( !( ShouldFearWhileAggressiveCrowdNPCCombat( stimEvent ) ) )
				{
					return false;
				}
			}
			else if( stimEvent.IsTagInStimuli( 'AggressiveCrowd' ) )
			{
				return false;
			}
		}
		else if( stimEvent.IsTagInStimuli( 'AggressiveCrowd' ) )
		{
			return false;
		}
		sceneSystemInt = GameInstance.GetSceneSystem( owner.GetGame() ).GetScriptInterface();
		if( sceneSystemInt.IsEntityInScene( owner.GetEntityID() ) && sceneSystemInt.IsEntityInScene( stimEvent.sourceObject.GetEntityID() ) )
		{
			return false;
		}
		if( GameInstance.GetSafeAreaManager( owner.GetGame() ).IsPointInSafeArea( owner.GetWorldPosition() ) && IsEntityInInteriorArea( EntityGameInterface.GetEntity( owner.GetEntity() ) ) )
		{
			return false;
		}
		return true;
	}

	private function HandleCrowdReaction( stimEvent : StimuliEvent )
	{
		var delayedCrowdReaction : DelayedCrowdReactionEvent;
		var stimAttackData : stimInvestigateData;
		var mountInfo : MountingInfo;
		var vehicleReactionEvent : HandleReactionEvent;
		var owner : GameObject;
		var game : GameInstance;
		var reactionSystem : ReactionSystem;
		owner = GetOwner();
		game = owner.GetGame();
		reactionSystem = GameInstance.GetReactionSystem( GetOwner().GetGame() );
		if( ( ( ( ( m_inCrowd && GameInstance.GetGameFeatureManager( game ).AggressiveCrowdsEnabled() ) && !( VehicleComponent.IsMountedToVehicle( game, owner ) ) ) && ShouldTriggerAggressiveCrowdNPCCombat( stimEvent ) ) && reactionSystem.TryRegisteringAggressiveNPC( owner ) ) && AIActionHelper.TryChangingAttitudeToHostile( ( ( ScriptedPuppet )( owner ) ), stimEvent.sourceObject ) )
		{
			owner.GetSensesComponent().IgnoreLODChange( true );
			owner.GetSensesComponent().Toggle( true );
			owner.GetTargetTrackerComponent().Toggle( true );
			TargetTrackingExtension.InjectThreat( ( ( ScriptedPuppet )( owner ) ), stimEvent.sourceObject );
			( ( NPCPuppet )( owner ) ).SetWasAggressiveCrowd( true );
			ResetAllFearAnimWrappers();
		}
		else if( m_reactionPreset.Type() == gamedataReactionPresetType.Child && stimEvent.IsTagInStimuli( 'ChildDanger' ) )
		{
			m_desiredFearPhase = 3;
			DeactiveLookAt();
			stimAttackData = stimEvent.stimInvestigateData;
			if( stimAttackData.attackInstigator )
			{
				stimEvent.sourceObject = ( ( GameObject )( stimAttackData.attackInstigator ) );
				stimEvent.sourcePosition = stimEvent.sourceObject.GetWorldPosition();
			}
			ActivateReactionLookAt( stimEvent.sourceObject, false );
			delayedCrowdReaction = new DelayedCrowdReactionEvent;
			delayedCrowdReaction.stimEvent = stimEvent;
			owner.QueueEvent( delayedCrowdReaction );
		}
		else if( ( VehicleComponent.IsMountedToVehicle( game, owner ) && stimEvent.GetStimType() != gamedataStimType.HijackVehicle ) && stimEvent.GetStimType() != gamedataStimType.Dying )
		{
			NPCPuppet.ChangeHighLevelState( owner, gamedataNPCHighLevelState.Fear );
			mountInfo = GameInstance.GetMountingFacility( game ).GetMountingInfoSingleWithObjects( owner );
			m_previousFearPhase = ConvertFearStageToFearPhase( m_crowdFearStage );
			vehicleReactionEvent = new HandleReactionEvent;
			vehicleReactionEvent.fearPhase = GetFearReactionPhase( stimEvent );
			vehicleReactionEvent.stimEvent = stimEvent;
			GameInstance.FindEntityByID( game, mountInfo.parentId ).QueueEvent( vehicleReactionEvent );
		}
		else
		{
			m_previousFearPhase = ConvertFearStageToFearPhase( m_crowdFearStage );
			m_desiredFearPhase = GetFearReactionPhase( stimEvent );
			if( VehicleComponent.IsMountedToVehicle( game, owner ) && stimEvent.GetStimType() == gamedataStimType.HijackVehicle )
			{
				GameObject.PlayVoiceOver( owner, 'fear_beg', 'Scripts:HandleCrowdReaction', , , true );
			}
			DeactiveLookAt();
			stimAttackData = stimEvent.stimInvestigateData;
			if( stimAttackData.attackInstigator )
			{
				stimEvent.sourceObject = ( ( GameObject )( stimAttackData.attackInstigator ) );
				stimEvent.sourcePosition = stimEvent.sourceObject.GetWorldPosition();
			}
			ActivateReactionLookAt( stimEvent.sourceObject, false );
			delayedCrowdReaction = new DelayedCrowdReactionEvent;
			delayedCrowdReaction.stimEvent = stimEvent;
			if( m_desiredFearPhase == -1 )
			{
				return;
			}
			CreateFearArea( stimEvent, m_desiredFearPhase );
			if( !( stimAttackData.skipReactionDelay ) )
			{
				m_delayReactionEventID = GameInstance.GetDelaySystem( game ).DelayEvent( owner, delayedCrowdReaction, RandRangeF( m_delay.X, m_delay.Y ) );
			}
			else
			{
				owner.QueueEvent( delayedCrowdReaction );
			}
		}
	}

	protected event OnCrowdReaction( reactionDelayEvent : DelayedCrowdReactionEvent )
	{
		var workspotSystem : WorkspotGameSystem;
		var blackboardSystem : BlackboardSystem;
		var blackboard : IBlackboard;
		var exitWorkspot : ExitWorkspotSequenceEvent;
		var fearPhase : Int32;
		var pointResults : NavigationFindPointResult;
		var crowdMemberComponent : CrowdMemberComponent;
		var broadcaster : StimBroadcasterComponent;
		var owner : GameObject;
		var game : GameInstance;
		var stimType : gamedataStimType;
		var reactionSystem : ReactionSystem;
		var stimData : stimInvestigateData;
		var exitFearInVehicle : DeescalateFearInVehicle;
		owner = GetOwner();
		stimData = reactionDelayEvent.stimEvent.stimInvestigateData;
		if( !( ScriptedPuppet.IsActive( owner ) ) )
		{
			return false;
		}
		stimType = reactionDelayEvent.stimEvent.GetStimType();
		if( m_beignHijacked && stimType != gamedataStimType.HijackVehicle )
		{
			return false;
		}
		game = owner.GetGame();
		reactionSystem = GameInstance.GetReactionSystem( game );
		crowdMemberComponent = GetOwnerPuppet().GetCrowdMemberComponent();
		crowdMemberComponent.OnCrowdReaction( stimType );
		if( stimType == gamedataStimType.AimingAt && ( reactionDelayEvent.vehicleFearPhase != 3 ) )
		{
			blackboardSystem = GameInstance.GetBlackboardSystem( game );
			blackboard = blackboardSystem.GetLocalInstanced( GetPlayerSystem().GetLocalPlayerMainGameObject().GetEntityID(), GetAllBlackboardDefs().PlayerStateMachine );
			if( blackboard.GetInt( GetAllBlackboardDefs().PlayerStateMachine.UpperBody ) == ( ( Int32 )( gamePSMUpperBodyStates.Aim ) ) )
			{
				blackboard = GameInstance.GetBlackboardSystem( game ).Get( GetAllBlackboardDefs().UI_TargetingInfo );
				if( ( blackboard.GetEntityID( GetAllBlackboardDefs().UI_TargetingInfo.CurrentVisibleTarget ) != owner.GetEntityID() ) && m_reactionPreset.Type() != gamedataReactionPresetType.InVehicle_Civilian )
				{
					DeactiveLookAt();
					m_desiredFearPhase = -1;
					return NULL;
				}
			}
			else
			{
				DeactiveLookAt();
				m_desiredFearPhase = -1;
				return NULL;
			}
		}
		GameInstance.GetDelaySystem( game ).CancelDelay( m_callingPoliceID );
		fearPhase = GetFearReactionPhase( reactionDelayEvent.stimEvent );
		if( reactionDelayEvent.vehicleFearPhase > 0 )
		{
			fearPhase = reactionDelayEvent.vehicleFearPhase;
		}
		workspotSystem = GameInstance.GetWorkspotSystem( game );
		crowdMemberComponent.SetThreatLastKnownPosition( GetPlayerSystem().GetLocalPlayerMainGameObject().GetWorldPosition() );
		crowdMemberComponent.AllowWorkspotsUsage( false );
		NPCPuppet.ChangeHighLevelState( owner, gamedataNPCHighLevelState.Fear );
		if( !( VehicleComponent.IsMountedToVehicle( game, owner ) ) || stimType == gamedataStimType.HijackVehicle )
		{
			reactionSystem.MarkDespawnCandidate( owner.GetEntityID() );
		}
		DeactiveLookAt();
		ResetFacial( 0.0 );
		TriggerFearFacial( fearPhase );
		if( m_previousFearPhase != 2 )
		{
			AnimationControllerComponent.SetAnimWrapperWeightOnOwnerAndItems( owner, GetFearAnimWrapper( fearPhase ), 1.0 );
			if( ( fearPhase != 0 ) && ( !( m_fearLocomotionWrapper ) || ( fearPhase == 3 ) ) )
			{
				AnimationControllerComponent.SetAnimWrapperWeightOnOwnerAndItems( owner, GetRandomFearLocomotionAnimWrapper( fearPhase, stimType ), 1.0 );
			}
			m_fearLocomotionWrapper = true;
		}
		switch( fearPhase )
		{
			case 1:
				m_crowdFearStage = gameFearStage.Stressed;
			break;
			case 2:
				m_crowdFearStage = gameFearStage.Alarmed;
			break;
			case 3:
				m_crowdFearStage = gameFearStage.Panic;
			crowdMemberComponent.SetThreatLastKnownPosition( GetPlayerSystem().GetLocalPlayerMainGameObject().GetWorldPosition() );
			break;
			default:
				m_crowdFearStage = gameFearStage.Relaxed;
			break;
		}
		crowdMemberComponent.ChangeFearStage( m_crowdFearStage, !( stimData.skipInitialAnimation ) );
		if( workspotSystem.IsActorInWorkspot( owner ) )
		{
			if( reactionSystem.IsInImmovableWorkspot( owner.GetEntityID() ) )
			{
				if( ( fearPhase > 1 ) && workspotSystem.IsReactionAvailable( owner, 'Fear' ) )
				{
					ActivateReactionLookAt( reactionDelayEvent.stimEvent.sourceObject, false, false, , true );
					workspotSystem.SendReactionSignal( owner, 'Fear' );
					m_inReactionSequence = true;
					GameObject.PlayVoiceOver( owner, 'fear_beg', 'Scripts:OnDelayedReaction' );
				}
				else
				{
					TriggerFacialLookAtReaction( true, true );
				}
			}
			else
			{
				switch( fearPhase )
				{
					case 0:
						TriggerFacialLookAtReaction( true, true );
					break;
					case 1:
						pointResults = GameInstance.GetAINavigationSystem( game ).FindPointInSphereForCharacter( owner.GetWorldPosition(), 0.5, owner );
					if( ( ( IsTargetClose( reactionDelayEvent.stimEvent.sourceObject, 3.0 ) && IsTargetInFront( reactionDelayEvent.stimEvent.sourceObject ) ) && workspotSystem.IsReactionAvailable( owner, 'Fear' ) ) && stimType != gamedataStimType.Bump )
					{
						ActivateReactionLookAt( reactionDelayEvent.stimEvent.sourceObject, false, false, , true );
						workspotSystem.SendReactionSignal( owner, 'Fear' );
						m_inReactionSequence = true;
						GameObject.PlayVoiceOver( owner, 'fear_beg', 'Scripts:OnDelayedReaction' );
						exitWorkspot = new ExitWorkspotSequenceEvent;
						m_exitWorkspotSequenceEventId = GameInstance.GetDelaySystem( game ).DelayEvent( owner, exitWorkspot, 3.0 );
					}
					else if( pointResults.status == worldNavigationRequestStatus.OK )
					{
						TriggerReactionBehaviorForCrowd( reactionDelayEvent.stimEvent, gamedataOutput.WalkAway, false );
					}
					else
					{
						if( workspotSystem.IsReactionAvailable( owner, 'Fear' ) && stimType != gamedataStimType.Bump )
						{
							ActivateReactionLookAt( reactionDelayEvent.stimEvent.sourceObject, false, false, , true );
							workspotSystem.SendReactionSignal( owner, 'Fear' );
							m_inReactionSequence = true;
							GameObject.PlayVoiceOver( owner, 'fear_beg', 'Scripts:OnDelayedReaction' );
							exitWorkspot = new ExitWorkspotSequenceEvent;
							m_exitWorkspotSequenceEventId = GameInstance.GetDelaySystem( game ).DelayEvent( owner, exitWorkspot, 3.0 );
						}
						else
						{
							TriggerFacialLookAtReaction( true, true );
						}
					}
					break;
					case 2:
						if( workspotSystem.IsReactionAvailable( owner, 'Fear' ) )
						{
							ActivateReactionLookAt( reactionDelayEvent.stimEvent.sourceObject, false, false, , true );
							workspotSystem.SendReactionSignal( owner, 'Fear' );
							m_inReactionSequence = true;
							GameObject.PlayVoiceOver( owner, 'fear_beg', 'Scripts:OnDelayedReaction' );
							exitWorkspot = new ExitWorkspotSequenceEvent;
							m_exitWorkspotSequenceEventId = GameInstance.GetDelaySystem( game ).DelayEvent( owner, exitWorkspot, 3.0 );
						}
						else if( VehicleComponent.IsMountedToVehicle( game, owner ) )
						{
							ActivateReactionLookAt( reactionDelayEvent.stimEvent.sourceObject, false, false, , true, true );
							GameObject.PlayVoiceOver( owner, 'fear_beg', 'Scripts:OnCrowdReaction', , , true );
							exitFearInVehicle = new DeescalateFearInVehicle;
							m_exitFearInVehicleEventId = GameInstance.GetDelaySystem( game ).DelayEvent( owner, exitFearInVehicle, 3.0 );
						}
						else if( !( m_inReactionSequence ) )
						{
							if( fearPhase == 3 )
							{
								SetCrowdRunningAwayAnimFeature( stimType );
								TriggerReactionBehaviorForCrowd( reactionDelayEvent.stimEvent, gamedataOutput.Flee, false );
							}
							else
							{
								TriggerReactionBehaviorForCrowd( reactionDelayEvent.stimEvent, gamedataOutput.Surrender, false );
							}
						}
					break;
					case 3:
						if( ( workspotSystem.IsWorkspotEnabled( owner ) && !( workspotSystem.HasExitNodes( owner, true, false, true ) ) ) && ( workspotSystem.IsReactionAvailable( owner, 'Fear' ) || m_inReactionSequence ) )
						{
							ActivateReactionLookAt( reactionDelayEvent.stimEvent.sourceObject, false, false, , true );
							workspotSystem.SendReactionSignal( owner, 'Fear' );
							m_inReactionSequence = true;
							GameObject.PlayVoiceOver( owner, 'fear_beg', 'Scripts:OnDelayedReaction' );
							exitWorkspot = new ExitWorkspotSequenceEvent;
							m_exitWorkspotSequenceEventId = GameInstance.GetDelaySystem( game ).DelayEvent( owner, exitWorkspot, 3.0 );
						}
						else if( ( m_previousFearPhase > 1 ) || workspotSystem.HasExitNodes( owner, true, false ) )
						{
							SetCrowdRunningAwayAnimFeature( stimType );
							TriggerReactionBehaviorForCrowd( reactionDelayEvent.stimEvent, gamedataOutput.Flee, true );
						}
						else
						{
							SetCrowdRunningAwayAnimFeature( stimType );
							TriggerReactionBehaviorForCrowd( reactionDelayEvent.stimEvent, gamedataOutput.Flee, false );
						}
					break;
				}
			}
		}
		else if( m_inTrafficLane )
		{
			GetOwnerPuppet().GetAIControllerComponent().SetBehaviorArgument( 'StimTarget', reactionDelayEvent.stimEvent.sourceObject );
			switch( fearPhase )
			{
				case 0:
					TriggerFacialLookAtReaction( true, true );
				break;
				case 1:
					TriggerReactionBehaviorForCrowd( reactionDelayEvent.stimEvent, gamedataOutput.WalkAway, false, true );
				break;
				case 2:
					crowdMemberComponent.TryStopTrafficMovement();
				TriggerReactionBehaviorForCrowd( reactionDelayEvent.stimEvent, gamedataOutput.Surrender, false, true );
				break;
				case 3:
					SetCrowdRunningAwayAnimFeature( stimType );
				TriggerReactionBehaviorForCrowd( reactionDelayEvent.stimEvent, gamedataOutput.Flee, false, true );
				break;
			}
		}
		else
		{
			switch( fearPhase )
			{
				case 0:
					TriggerFacialLookAtReaction( true, true );
				break;
				case 1:
					pointResults = GameInstance.GetAINavigationSystem( game ).FindPointInSphereForCharacter( owner.GetWorldPosition(), 0.5, owner );
				if( pointResults.status == worldNavigationRequestStatus.OK )
				{
					TriggerReactionBehaviorForCrowd( reactionDelayEvent.stimEvent, gamedataOutput.WalkAway, false );
				}
				else
				{
					TriggerFacialLookAtReaction( true, true );
				}
				break;
				case 2:
					TriggerReactionBehaviorForCrowd( reactionDelayEvent.stimEvent, gamedataOutput.Surrender, true );
				break;
				case 3:
					if( m_previousFearPhase > 1 )
					{
						SetCrowdRunningAwayAnimFeature( stimType );
						TriggerReactionBehaviorForCrowd( reactionDelayEvent.stimEvent, gamedataOutput.Flee, false, true );
					}
					else
					{
						SetCrowdRunningAwayAnimFeature( stimType );
						TriggerReactionBehaviorForCrowd( reactionDelayEvent.stimEvent, gamedataOutput.Flee, false );
					}
				break;
			}
		}
		if( ( m_reactionPreset.Type() != gamedataReactionPresetType.Child && ( reactionDelayEvent.stimEvent.sourceObject == GetPlayerSystem().GetLocalPlayerMainGameObject() ) ) && !( reactionDelayEvent.stimEvent.IsTagInStimuli( 'NoFearSpread' ) ) )
		{
			SpreadFear( fearPhase );
		}
		else if( stimType == gamedataStimType.HijackVehicle )
		{
			broadcaster = reactionDelayEvent.stimEvent.sourceObject.GetStimBroadcasterComponent();
			if( broadcaster )
			{
				broadcaster.TriggerSingleBroadcast( owner, gamedataStimType.CrimeWitness );
			}
		}
		m_desiredFearPhase = -1;
	}

	private function SpreadFear( phase : Int32 )
	{
		var broadcaster : StimBroadcasterComponent;
		var stimData : stimInvestigateData;
		var owner : GameObject;
		owner = GetOwner();
		if( !( GameObject.IsCooldownActive( owner, 'spreadFearCooldown' ) ) )
		{
			GameObject.StartCooldown( owner, 'spreadFearCooldown', 3.0 );
			broadcaster = owner.GetStimBroadcasterComponent();
			if( broadcaster )
			{
				if( phase > 1 )
				{
					stimData.fearPhase = 3;
					broadcaster.TriggerSingleBroadcast( owner, gamedataStimType.SpreadFear, 10.0, stimData );
				}
				else
				{
					stimData.fearPhase = 1;
				}
				broadcaster.AddActiveStimuli( owner, gamedataStimType.SpreadFear, 3.0, 15.0, stimData, true );
			}
		}
	}

	private function CreateFearArea( stimEvent : StimuliEvent, fearPhase : Int32 )
	{
		var owner : GameObject;
		var game : GameInstance;
		var debugInfo : String;
		var radius : Float;
		owner = GetOwner();
		radius = stimEvent.radius;
		game = owner.GetGame();
		if( stimEvent.GetStimType() == gamedataStimType.Gunshot )
		{
			radius = 50.0;
		}
		radius = radius / SqrtF( 2.0 );
		if( fearPhase > 1 )
		{
			if( IsFinal() )
			{
				GameInstance.GetReactionSystem( game ).AddFearSource( ( ( Vector3 )( stimEvent.sourcePosition ) ), radius );
			}
			else
			{
				debugInfo = ( ( "[" + EntityID.ToDebugStringDecimal( stimEvent.sourceObject.GetEntityID() ) ) + "] " ) + EnumValueToString( "gamedataStimType", ( ( Int32 )( stimEvent.GetStimType() ) ) );
				debugInfo += ( ( "(R=" + radius ) + ")" );
				GameInstance.GetReactionSystem( game ).AddFearSource( ( ( Vector3 )( stimEvent.sourcePosition ) ), radius, StringToName( debugInfo ) );
			}
		}
	}

	private function ShouldFearInPlace( stimEvent : StimuliEvent ) : Bool
	{
		var weapon : WeaponObject;
		var player : PlayerPuppet;
		var owner : GameObject;
		var game : GameInstance;
		owner = GetOwner();
		game = owner.GetGame();
		if( VehicleComponent.IsMountedToVehicle( game, owner ) )
		{
			return false;
		}
		player = ( ( PlayerPuppet )( GameInstance.GetPlayerSystem( game ).GetLocalPlayerMainGameObject() ) );
		if( VehicleComponent.IsMountedToVehicle( game, player ) )
		{
			return false;
		}
		if( stimEvent.IsTagInStimuli( 'TryRunAway' ) )
		{
			return false;
		}
		weapon = GameObject.GetActiveWeapon( player );
		if( weapon.IsMelee() )
		{
			return false;
		}
		if( PlayerPuppet.GetCurrentCombatState( player ) == gamePSMCombat.InCombat )
		{
			if( stimEvent.GetStimType() == gamedataStimType.CombatHit )
			{
				return true;
			}
			if( GetThreatDistanceSquared( stimEvent.sourceObject ) < ( m_fearInPlaceAroundDistance * m_fearInPlaceAroundDistance ) )
			{
				return true;
			}
		}
		return false;
	}

	private function TriggerFacialLookAtReaction( optional forceFear : Bool, optional playVO : Bool )
	{
		var facialReactionAnimFeature : AnimFeature_FacialReaction;
		var lookAtData : LookAtData;
		var vo : CName;
		var target : GameObject;
		facialReactionAnimFeature = new AnimFeature_FacialReaction;
		target = GetPlayerSystem().GetLocalPlayerControlledGameObject();
		if( !( m_inCrowd ) )
		{
			playVO = true;
			facialReactionAnimFeature.category = 3;
			facialReactionAnimFeature.idle = 1;
			m_facialCooldown = 2.0;
			vo = 'greeting';
			ActivateReactionLookAt( target, false );
		}
		else if( forceFear || IsTargetArmed( target ) )
		{
			facialReactionAnimFeature.category = 3;
			facialReactionAnimFeature.idle = 10;
			ActivateReactionLookAt( target, false );
			m_facialCooldown = 5.0;
		}
		else if( ( ( PlayerPuppet )( target ) ).IsNaked() )
		{
			facialReactionAnimFeature.category = 3;
			facialReactionAnimFeature.idle = 7;
			vo = 'fear_foll';
			ActivateReactionLookAt( target, true );
			m_facialCooldown = 5.0;
		}
		else
		{
			SelectFacialEmotion( lookAtData );
			vo = 'greeting';
			ActivateReactionLookAt( target, true, true );
			facialReactionAnimFeature.category = lookAtData.category;
			facialReactionAnimFeature.idle = lookAtData.idle;
			m_facialCooldown = 2.0;
		}
		AnimationControllerComponent.ApplyFeatureToReplicate( GetOwner(), 'FacialReaction', facialReactionAnimFeature );
		if( !( GetOwnerPuppet().IsVendor() ) && playVO )
		{
			GameObject.PlayVoiceOver( GetOwner(), vo, 'Scripts:TriggerLookAtReaction' );
		}
	}

	private function TriggerFearFacial( phase : Int32 )
	{
		var facialReactionAnimFeature : AnimFeature_FacialReaction;
		facialReactionAnimFeature = new AnimFeature_FacialReaction;
		facialReactionAnimFeature.category = 3;
		switch( phase )
		{
			case 1:
				facialReactionAnimFeature.idle = 10;
			break;
			case 2:
				facialReactionAnimFeature.idle = 11;
			break;
			case 3:
				facialReactionAnimFeature.idle = 9;
			break;
			default:
				facialReactionAnimFeature.idle = 10;
			break;
		}
		AnimationControllerComponent.ApplyFeatureToReplicate( GetOwner(), 'FacialReaction', facialReactionAnimFeature );
	}

	private function ResetFacial( cooldown : Float )
	{
		var facialReactionAnimFeature : AnimFeature_FacialReaction;
		var facialResetEvent : ResetFacialEvent;
		if( cooldown > 0.0 )
		{
			GameInstance.GetDelaySystem( GetOwner().GetGame() ).CancelDelay( m_resetFacialEventId );
			facialResetEvent = new ResetFacialEvent;
			m_resetFacialEventId = GetDelaySystem().DelayEvent( GetOwner(), facialResetEvent, cooldown );
		}
		else
		{
			facialReactionAnimFeature = new AnimFeature_FacialReaction;
			AnimationControllerComponent.ApplyFeatureToReplicate( GetOwner(), 'FacialReaction', facialReactionAnimFeature );
		}
	}

	protected event OnResetLookatReactionEvent( evt : ResetLookatReactionEvent )
	{
		DeactiveLookAt();
		ResetFacial( m_facialCooldown );
	}

	protected event OnResetFacialEvent( evt : ResetFacialEvent )
	{
		var facialReactionAnimFeature : AnimFeature_FacialReaction;
		m_facialCooldown = 0.0;
		facialReactionAnimFeature = new AnimFeature_FacialReaction;
		AnimationControllerComponent.ApplyFeatureToReplicate( GetOwner(), 'FacialReaction', facialReactionAnimFeature );
	}

	private function CanTriggerExpressionLookAt() : Bool
	{
		var sceneSystem : SceneSystemInterface;
		var owner : GameObject;
		var ownerPuppet : ScriptedPuppet;
		owner = GetOwner();
		ownerPuppet = GetOwnerPuppet();
		if( !( ScriptedPuppet.IsActive( owner ) ) || ScriptedPuppet.IsUnconscious( owner ) )
		{
			return false;
		}
		if( m_highLevelState == gamedataNPCHighLevelState.Combat || m_highLevelState == gamedataNPCHighLevelState.Alerted )
		{
			return false;
		}
		if( ( ( NPCPuppet )( ownerPuppet ) ).IsRagdolling() )
		{
			return false;
		}
		if( ScriptedPuppet.IsBlinded( ownerPuppet ) )
		{
			return false;
		}
		if( m_reactionPreset.Type() == gamedataReactionPresetType.NoReaction || m_reactionPreset.Type() == gamedataReactionPresetType.Follower )
		{
			return false;
		}
		if( ownerPuppet.IsBoss() )
		{
			return false;
		}
		if( ( m_inReactionSequence || m_crowdFearStage == gameFearStage.Alarmed ) || m_crowdFearStage == gameFearStage.Panic )
		{
			return false;
		}
		if( StatusEffectSystem.ObjectHasStatusEffectWithTag( owner, 'LoreAnim' ) )
		{
			return false;
		}
		if( GameInstance.GetWorkspotSystem( owner.GetGame() ).IsActorInWorkspot( owner ) )
		{
			if( ( StatusEffectSystem.ObjectHasStatusEffectWithTag( owner, 'Braindance' ) || StatusEffectSystem.ObjectHasStatusEffectWithTag( owner, 'Sleep' ) ) || StatusEffectSystem.ObjectHasStatusEffectWithTag( owner, 'Busy' ) )
			{
				return false;
			}
		}
		sceneSystem = GameInstance.GetSceneSystem( owner.GetGame() ).GetScriptInterface();
		if( sceneSystem && ( sceneSystem.IsEntityInDialogue( owner.GetEntityID() ) || sceneSystem.IsEntityInScene( owner.GetEntityID() ) ) )
		{
			return false;
		}
		if( !( ownerPuppet.IsOnAutonomousAI() ) )
		{
			return false;
		}
		return true;
	}

	private function ShouldFearWhileAggressiveCrowdNPCCombat( stimEvent : StimuliEvent ) : Bool
	{
		var playerPuppet : PlayerPuppet;
		var threats : array< TrackedLocation >;
		threats = GetPlayerSystem().GetLocalPlayerControlledGameObject().GetTargetTrackerComponent().GetHostileThreats( false );
		if( threats.Size() > 1 )
		{
			return true;
		}
		playerPuppet = ( ( PlayerPuppet )( stimEvent.sourceObject ) );
		if( WeaponObject.IsMelee( GameObject.GetActiveWeapon( GetOwner() ).GetItemID() ) )
		{
			if( stimEvent.GetStimType() == gamedataStimType.WeaponDisplayed && WeaponObject.IsRanged( GameObject.GetActiveWeapon( playerPuppet ).GetItemID() ) )
			{
				return true;
			}
			if( stimEvent.GetStimType() == gamedataStimType.Gunshot )
			{
				return true;
			}
		}
		return false;
	}

	private function ShouldTriggerAggressiveCrowdNPCCombat( stimEvent : StimuliEvent ) : Bool
	{
		var distanceToPlayer : Float;
		var maxDistanceToTriggerCombat : Float;
		var playerPuppet : PlayerPuppet;
		var preventionSystem : PreventionSystem;
		var navigationSystem : AINavigationSystem;
		playerPuppet = ( ( PlayerPuppet )( stimEvent.sourceObject ) );
		if( !( playerPuppet ) )
		{
			return false;
		}
		if( playerPuppet.IsInCombat() )
		{
			return false;
		}
		preventionSystem = ( ( PreventionSystem )( GameInstance.GetScriptableSystemsContainer( GetOwner().GetGame() ).Get( 'PreventionSystem' ) ) );
		if( ( ( Int32 )( preventionSystem.GetHeatStage() ) ) > 0 )
		{
			return false;
		}
		if( stimEvent.IsTagInStimuli( 'NonAggressiveCrowd' ) )
		{
			return false;
		}
		if( !( IsTargetInFront( playerPuppet, 120.0 ) ) )
		{
			return false;
		}
		if( !( IsTargetInFront( playerPuppet, 150.0, true ) ) )
		{
			return false;
		}
		if( WeaponObject.IsRanged( GameObject.GetActiveWeapon( playerPuppet ).GetItemID() ) )
		{
			distanceToPlayer = Vector4.DistanceSquared( GetOwner().GetWorldPosition(), playerPuppet.GetWorldPosition() );
			maxDistanceToTriggerCombat = TweakDBInterface.GetFloat( T"AIGeneralSettings.distanceToTriggerAggressiveCrowdRanged", 15.0 );
			if( distanceToPlayer >= ( maxDistanceToTriggerCombat * maxDistanceToTriggerCombat ) )
			{
				return false;
			}
		}
		else
		{
			distanceToPlayer = Vector4.DistanceSquared( GetOwner().GetWorldPosition(), playerPuppet.GetWorldPosition() );
			maxDistanceToTriggerCombat = TweakDBInterface.GetFloat( T"AIGeneralSettings.distanceToTriggerAggressiveCrowdMelee", 5.0 );
			if( distanceToPlayer >= ( maxDistanceToTriggerCombat * maxDistanceToTriggerCombat ) )
			{
				return false;
			}
		}
		navigationSystem = GameInstance.GetAINavigationSystem( GetOwner().GetGame() );
		if( navigationSystem && !( navigationSystem.IsPointOnNavmesh( GetOwner(), GetOwner().GetWorldPosition(), 0.1 ) ) )
		{
			return false;
		}
		return true;
	}

	private function IsPlayerFearThreat() : Bool
	{
		if( IsTargetArmed( GetPlayerSystem().GetLocalPlayerControlledGameObject() ) )
		{
			return true;
		}
		if( IsPlayerCarryingBody( ( ( PlayerPuppet )( GetPlayerSystem().GetLocalPlayerControlledGameObject() ) ) ) )
		{
			return true;
		}
		return false;
	}

	private const function IsPlayerCarryingBody( playerPuppet : weak< PlayerPuppet > ) : Bool
	{
		var playerStateMachineBlackboard : IBlackboard;
		if( !( playerPuppet ) )
		{
			return false;
		}
		playerStateMachineBlackboard = GameInstance.GetBlackboardSystem( playerPuppet.GetGame() ).GetLocalInstanced( playerPuppet.GetEntityID(), GetAllBlackboardDefs().PlayerStateMachine );
		return playerStateMachineBlackboard.GetBool( GetAllBlackboardDefs().PlayerStateMachine.Carrying );
	}

	private function SetCrowdRunningAwayAnimFeature( stimType : gamedataStimType )
	{
		var crowdRunningAwayAnimFeature : AnimFeature_CrowdRunningAway;
		crowdRunningAwayAnimFeature = new AnimFeature_CrowdRunningAway;
		if( stimType == gamedataStimType.Driving )
		{
			crowdRunningAwayAnimFeature.isRunningAwayFromPlayersCar = true;
		}
		else
		{
			crowdRunningAwayAnimFeature.isRunningAwayFromPlayersCar = false;
		}
		AnimationControllerComponent.ApplyFeatureToReplicate( GetOwner(), 'CrowdRunningAway', crowdRunningAwayAnimFeature );
	}

	private function SafeToExitFear() : Bool
	{
		var distanceToPlayer : Float;
		if( IsPlayerFearThreat() )
		{
			distanceToPlayer = Vector4.DistanceSquared( GetOwner().GetWorldPosition(), GetPlayerSystem().GetLocalPlayerControlledGameObject().GetWorldPosition() );
			if( IsTargetInFront( GetPlayerSystem().GetLocalPlayerControlledGameObject(), 120.0 ) )
			{
				if( distanceToPlayer < ( m_fearToIdleDistance.X * m_fearToIdleDistance.X ) )
				{
					return false;
				}
			}
			else
			{
				if( distanceToPlayer < ( m_fearToIdleDistance.Y * m_fearToIdleDistance.Y ) )
				{
					return false;
				}
			}
		}
		return true;
	}

	private function SafeToExitPanicFear() : Bool
	{
		var distanceToPlayer : Float;
		var simTime : Float;
		distanceToPlayer = Vector4.DistanceSquared( GetOwner().GetWorldPosition(), GetPlayerSystem().GetLocalPlayerControlledGameObject().GetWorldPosition() );
		if( GameInstance.GetCameraSystem( GetOwner().GetGame() ).IsInCameraFrustum( GetOwner(), 2.0, 0.75 ) )
		{
			if( distanceToPlayer > ( 35.0 * 35.0 ) )
			{
				simTime = EngineTime.ToFloat( GameInstance.GetSimTime( GetOwner().GetGame() ) );
				if( m_successfulFearDeescalation == 0.0 )
				{
					m_successfulFearDeescalation = simTime + 1.5;
				}
				if( m_successfulFearDeescalation <= simTime )
				{
					return true;
				}
				else
				{
					return false;
				}
			}
		}
		else if( distanceToPlayer > ( 22.5 * 22.5 ) )
		{
			simTime = EngineTime.ToFloat( GameInstance.GetSimTime( GetOwner().GetGame() ) );
			if( m_successfulFearDeescalation == 0.0 )
			{
				m_successfulFearDeescalation = simTime + 0.5;
			}
			if( m_successfulFearDeescalation >= simTime )
			{
				return true;
			}
			else
			{
				return false;
			}
		}
		m_successfulFearDeescalation = 0.0;
		return false;
	}

	private function SurrenderToLeave() : Bool
	{
		var direction : Vector4;
		var angleToTarget : Float;
		var target : GameObject;
		var targetPos : Vector4;
		var ownerPos : Vector4;
		target = GetPlayerSystem().GetLocalPlayerControlledGameObject();
		targetPos = target.GetWorldPosition();
		ownerPos = GetOwner().GetWorldPosition();
		direction = targetPos - ownerPos;
		angleToTarget = Vector4.GetAngleDegAroundAxis( direction, GetOwner().GetWorldForward(), GetOwner().GetWorldUp() );
		if( AbsF( angleToTarget ) > 120.0 )
		{
			return true;
		}
		direction = ownerPos - targetPos;
		angleToTarget = Vector4.GetAngleDegAroundAxis( direction, target.GetWorldForward(), target.GetWorldUp() );
		if( AbsF( angleToTarget ) > 10.0 )
		{
			return true;
		}
		return false;
	}

	private function CanTriggerReprimandOrder() : Bool
	{
		var reprimandAbility : GameplayAbility_Record;
		var record : IPrereq_Record;
		var prereqCount : Int32;
		var i : Int32;
		var owner : GameObject;
		var game : GameInstance;
		owner = GetOwner();
		game = owner.GetGame();
		reprimandAbility = TweakDBInterface.GetGameplayAbilityRecord( T"Ability.CanAskToFollowOrder" );
		prereqCount = reprimandAbility.GetPrereqsForUseCount();
		for( i = 0; i < prereqCount; i += 1 )
		{
			record = reprimandAbility.GetPrereqsForUseItem( i );
			if( IPrereq.CreatePrereq( record.GetID() ).IsFulfilled( game, owner ) )
			{
				return true;
			}
		}
		return false;
	}

	public const function CanAskToHolsterWeapon() : Bool
	{
		var reprimandAbility : GameplayAbility_Record;
		var record : IPrereq_Record;
		var prereqCount : Int32;
		var i : Int32;
		var owner : GameObject;
		var game : GameInstance;
		owner = GetOwner();
		game = owner.GetGame();
		reprimandAbility = TweakDBInterface.GetGameplayAbilityRecord( T"Ability.CanAskToHolsterWeapon" );
		prereqCount = reprimandAbility.GetPrereqsForUseCount();
		for( i = 0; i < prereqCount; i += 1 )
		{
			record = reprimandAbility.GetPrereqsForUseItem( i );
			if( IPrereq.CreatePrereq( record.GetID() ).IsFulfilled( game, owner ) )
			{
				return true;
			}
		}
		return false;
	}

	private function NotifySecuritySystem( stimType : gamedataStimType, stimObject : GameObject )
	{
		if( stimType == gamedataStimType.DeadBody )
		{
			GetOwnerPuppet().TriggerSecuritySystemNotification( stimObject.GetWorldPosition(), stimObject, ESecurityNotificationType.ALARM, stimType );
		}
	}

	private function SetWarningMessage( lockey : String )
	{
		var simpleScreenMessage : SimpleScreenMessage;
		simpleScreenMessage.isShown = true;
		simpleScreenMessage.duration = 5.0;
		simpleScreenMessage.message = lockey;
		simpleScreenMessage.isInstant = true;
		GameInstance.GetBlackboardSystem( GetPlayerSystem().GetLocalPlayerControlledGameObject().GetGame() ).Get( GetAllBlackboardDefs().UI_Notifications ).SetVariant( GetAllBlackboardDefs().UI_Notifications.WarningMessage, simpleScreenMessage, true );
	}

	protected event OnTriggerDelayedReactionEvent( evt : TriggerDelayedReactionEvent )
	{
		TriggerReactionBehaviorForCrowd( evt.stimEvent, evt.behavior, evt.initAnim );
	}

	protected event OnExitWorkspotSequenceEvent( evt : ExitWorkspotSequenceEvent )
	{
		var owner : GameObject;
		var game : GameInstance;
		owner = GetOwner();
		game = owner.GetGame();
		if( m_inReactionSequence )
		{
			if( m_crowdFearStage == gameFearStage.Panic && VehicleComponent.IsMountedToVehicle( game, owner ) )
			{
				if( SafeToExitPanicFear() )
				{
					m_successfulFearDeescalation = 0.0;
					GameInstance.GetWorkspotSystem( game ).HardResetPlaybackToStart( owner );
				}
				else
				{
					GameInstance.GetDelaySystem( game ).CancelDelay( m_exitWorkspotSequenceEventId );
					m_exitWorkspotSequenceEventId = GameInstance.GetDelaySystem( game ).DelayEvent( owner, evt, 1.0 );
				}
			}
			else if( m_crowdFearStage != gameFearStage.Panic )
			{
				if( SafeToExitFear() )
				{
					if( VehicleComponent.IsMountedToVehicle( game, owner ) )
					{
						GameInstance.GetWorkspotSystem( game ).HardResetPlaybackToStart( owner );
					}
					else
					{
						GameInstance.GetWorkspotSystem( game ).ResetPlaybackToStart( owner );
					}
				}
				else
				{
					GameInstance.GetDelaySystem( game ).CancelDelay( m_exitWorkspotSequenceEventId );
					m_exitWorkspotSequenceEventId = GameInstance.GetDelaySystem( game ).DelayEvent( owner, evt, 1.0 );
				}
			}
		}
	}

	protected event OnDeescalateFearInVehicle( evt : DeescalateFearInVehicle )
	{
		var owner : GameObject;
		var game : GameInstance;
		var crowdSettingsEvent : CrowdSettingsEvent;
		var mountInfo : MountingInfo;
		owner = GetOwner();
		game = owner.GetGame();
		if( VehicleComponent.IsMountedToVehicle( game, owner ) )
		{
			if( SafeToExitPanicFear() )
			{
				m_crowdFearStage = gameFearStage.Relaxed;
				GetOwnerPuppet().GetCrowdMemberComponent().ChangeFearStage( m_crowdFearStage );
				m_successfulFearDeescalation = 0.0;
				AnimationControllerComponent.SetAnimWrapperWeightOnOwnerAndItems( owner, 'fear', 0.0 );
				crowdSettingsEvent = new CrowdSettingsEvent;
				crowdSettingsEvent.movementType = 'normal';
				mountInfo = GameInstance.GetMountingFacility( game ).GetMountingInfoSingleWithObjects( owner );
				GameInstance.FindEntityByID( game, mountInfo.parentId ).QueueEvent( crowdSettingsEvent );
			}
			else
			{
				GameInstance.GetDelaySystem( game ).CancelDelay( m_exitFearInVehicleEventId );
				m_exitFearInVehicleEventId = GameInstance.GetDelaySystem( game ).DelayEvent( owner, evt, 1.0 );
			}
		}
	}

	protected event OnCrowdSettingsEvent( evt : CrowdSettingsEvent )
	{
		GetOwnerPuppet().GetCrowdMemberComponent().ChangeMoveType( evt.movementType );
	}

	private function GetFearReactionPhase( stimEvent : StimuliEvent ) : Int32
	{
		var stimData : stimInvestigateData;
		var tags : array< CName >;
		tags = stimEvent.stimRecord.Tags();
		if( stimEvent.GetStimType() == gamedataStimType.IllegalAction )
		{
			stimData = stimEvent.stimInvestigateData;
			if( stimData.fearPhase != 0 )
			{
				return 0;
			}
		}
		if( tags.Contains( 'Uncomfortable' ) )
		{
			if( m_isInCrosswalk )
			{
				return 1;
			}
			return 0;
		}
		if( tags.Contains( 'PotentialFear' ) )
		{
			return 1;
		}
		if( tags.Contains( 'DirectThreat' ) )
		{
			if( IsTargetClose( stimEvent.sourceObject, 10.0 ) )
			{
				return 2;
			}
			else
			{
				return 1;
			}
		}
		if( tags.Contains( 'PanicFear' ) )
		{
			return 3;
		}
		if( stimEvent.GetStimType() == gamedataStimType.SpreadFear )
		{
			stimData = stimEvent.stimInvestigateData;
			if( stimData.fearPhase == 0 )
			{
				return 1;
			}
			else
			{
				return stimData.fearPhase;
			}
		}
		if( stimEvent.GetStimType() == gamedataStimType.Driving )
		{
			return 3;
		}
		return -1;
	}

	private function ShouldInterruptCurrentFearStage( fearPhase : Int32 ) : Bool
	{
		if( m_highLevelState == gamedataNPCHighLevelState.Relaxed )
		{
			return true;
		}
		if( fearPhase > ConvertFearStageToFearPhase( m_crowdFearStage ) )
		{
			return true;
		}
		return false;
	}

	private function ConvertFearStageToFearPhase( fearStage : gameFearStage ) : Int32
	{
		switch( fearStage )
		{
			case gameFearStage.Relaxed:
				return 0;
			case gameFearStage.Stressed:
				return 1;
			case gameFearStage.Alarmed:
				return 2;
			case gameFearStage.Panic:
				return 3;
		}
	}

	private function GetSpreadFearPhase( stimEvent : StimuliEvent ) : Int32
	{
		if( stimEvent.GetStimType() == gamedataStimType.CombatHit )
		{
			return 1;
		}
		if( ( m_desiredFearPhase > 0 ) && ( m_desiredFearPhase != 3 ) )
		{
			return 1;
		}
		return m_desiredFearPhase;
	}

	private function CanReactInVehicle( stimEvent : StimuliEvent ) : Bool
	{
		var mountingInfos : array< MountingInfo >;
		var carMountInfo : MountingInfo;
		var count, i : Int32;
		var owner : GameObject;
		var game : GameInstance;
		var stimTags : array< CName >;
		var randDraw : Int32;
		owner = GetOwner();
		game = owner.GetGame();
		if( VehicleComponent.IsMountedToVehicle( game, owner ) )
		{
			if( stimEvent.GetStimType() == gamedataStimType.VehicleHit )
			{
				randDraw = RandRange( 0, 100 );
				if( randDraw > 30 )
				{
					return false;
				}
			}
			if( ( stimEvent.GetStimType() == gamedataStimType.CrowdIllegalAction || stimEvent.GetStimType() == gamedataStimType.CrimeWitness ) || stimEvent.GetStimType() == gamedataStimType.SpreadFear )
			{
				return false;
			}
			stimTags = stimEvent.stimRecord.Tags();
			if( ( stimTags.Contains( 'TrafficPlayerOnly' ) && !( stimEvent.sourceObject.IsPlayer() ) ) && PlayerPuppet.GetCurrentCombatState( ( ( PlayerPuppet )( GetPlayerSystem().GetLocalPlayerMainGameObject() ) ) ) != gamePSMCombat.InCombat )
			{
				return false;
			}
			if( stimEvent.GetStimType() == gamedataStimType.Dying )
			{
				carMountInfo = GameInstance.GetMountingFacility( game ).GetMountingInfoSingleWithObjects( owner );
				mountingInfos = GameInstance.GetMountingFacility( game ).GetMountingInfoMultipleWithIds( , carMountInfo.parentId );
				count = mountingInfos.Size();
				for( i = 0; i < count; i += 1 )
				{
					if( ( ( GameObject )( GameInstance.FindEntityByID( game, mountingInfos[ i ].childId ) ) ) == stimEvent.sourceObject )
					{
						return true;
					}
				}
				return false;
			}
		}
		return true;
	}

	protected event OnCrowdCallingPoliceEvent( evt : CrowdCallingPoliceEvent )
	{
		var reactionSystem : ScriptedReactionSystem;
		var request : UnregisterPoliceCaller;
		m_willingToCallPolice = false;
		reactionSystem = ( ( ScriptedReactionSystem )( GameInstance.GetScriptableSystemsContainer( GetOwner().GetGame() ).Get( 'ScriptedReactionSystem' ) ) );
		if( reactionSystem && reactionSystem.IsCaller( GetEntity() ) )
		{
			TriggerReactionBehaviorForCrowd( GetPlayerSystem().GetLocalPlayerMainGameObject(), gamedataOutput.CallPolice, false );
			request = new UnregisterPoliceCaller;
			reactionSystem.QueueRequest( request );
		}
	}

	private function CheckStalk( target : GameObject, timeout : Float )
	{
		var stalkEvent : StalkEvent;
		if( m_playerProximity && ( m_reactionPreset.Type() != gamedataReactionPresetType.Civilian_Passive || !( SourceAttitude( target, EAIAttitude.AIA_Friendly ) ) ) )
		{
			stalkEvent = new StalkEvent;
			GameInstance.GetDelaySystem( GetOwner().GetGame() ).DelayEvent( GetOwner(), stalkEvent, timeout );
		}
	}

	private function CheckComfortZone()
	{
		var distrurbComfortZoneEvent : DisturbingComfortZone;
		var checkComfortZoneEvent : CheckComfortZoneEvent;
		var broadcaster : StimBroadcasterComponent;
		var owner : GameObject;
		var player : GameObject;
		var game : GameInstance;
		var simTime : Float;
		owner = GetOwner();
		player = GetPlayerSystem().GetLocalPlayerControlledGameObject();
		game = owner.GetGame();
		simTime = EngineTime.ToFloat( GameInstance.GetSimTime( game ) );
		if( ( m_playerProximity && IsTargetInFront( player ) ) && IsTargetInFront( player, 45.0, true ) )
		{
			if( m_disturbingComfortZoneInProgress )
			{
				if( m_comfortZoneTimestamp >= simTime )
				{
					m_entereProximityRecently += 1;
					if( m_entereProximityRecently >= 3 )
					{
						broadcaster = player.GetStimBroadcasterComponent();
						if( broadcaster )
						{
							broadcaster.SendDrirectStimuliToTarget( owner, gamedataStimType.CrowdIllegalAction, owner );
						}
					}
				}
				else
				{
					m_entereProximityRecently = 0;
					m_disturbingComfortZoneInProgress = false;
				}
			}
			else
			{
				m_disturbingComfortZoneInProgress = true;
				m_entereProximityRecently += 1;
				m_comfortZoneTimestamp = simTime + 10.0;
			}
			distrurbComfortZoneEvent = new DisturbingComfortZone;
			m_disturbComfortZoneEventId = GameInstance.GetDelaySystem( game ).DelayEvent( owner, distrurbComfortZoneEvent, 10.0 );
		}
		else if( m_playerProximity )
		{
			checkComfortZoneEvent = new CheckComfortZoneEvent;
			m_checkComfortZoneEventId = GameInstance.GetDelaySystem( game ).DelayEvent( owner, checkComfortZoneEvent, 1.0 );
		}
	}

	protected event OnDisturbingComfortZoneEvent( evt : DisturbingComfortZone )
	{
		var disturbEvent : DisturbingComfortZone;
		var broadcaster : StimBroadcasterComponent;
		var player : GameObject;
		player = GetPlayerSystem().GetLocalPlayerControlledGameObject();
		GameInstance.GetDelaySystem( GetOwner().GetGame() ).CancelDelay( m_disturbComfortZoneEventId );
		if( ( ( ( m_playerProximity && IsTargetInFront( player ) ) && !( GetOwnerPuppet().IsVendor() ) ) && IsTargetClose( player, 1.0 ) ) && IsTargetInFront( player, 45.0, true ) )
		{
			TriggerFacialLookAtReaction( true, true );
			broadcaster = player.GetStimBroadcasterComponent();
			if( broadcaster )
			{
				broadcaster.SendDrirectStimuliToTarget( GetOwner(), gamedataStimType.CrowdIllegalAction, GetOwner() );
			}
		}
		else if( m_playerProximity )
		{
			disturbEvent = new DisturbingComfortZone;
			m_disturbComfortZoneEventId = GameInstance.GetDelaySystem( GetOwner().GetGame() ).DelayEvent( GetOwner(), disturbEvent, 1.0 );
		}
	}

	protected event OnCheckComfortZoneEvent( evt : CheckComfortZoneEvent )
	{
		GameInstance.GetDelaySystem( GetOwner().GetGame() ).CancelDelay( m_checkComfortZoneEventId );
		CheckComfortZone();
	}

	private function GetOutputPriority( output : gamedataOutput ) : Float
	{
		var outputRecord : Output_Record;
		outputRecord = TweakDBInterface.GetOutputRecord( TDBID.Create( "ReactionOutput." + EnumValueToString( "gamedataOutput", ( ( Int32 )( output ) ) ) ) );
		if( outputRecord )
		{
			return outputRecord.AIPriority();
		}
		return 4.0;
	}

	private function DelayReaction( stimType : gamedataStimType ) : Bool
	{
		if( stimType == gamedataStimType.AimingAt )
		{
			return true;
		}
		return false;
	}

	private function SelectFacialEmotion( out lookAtData : LookAtData )
	{
		var personalities : array< gamedataStatType >;
		personalities.PushBack( gamedataStatType.PersonalityAggressive );
		personalities.PushBack( gamedataStatType.PersonalityCuriosity );
		personalities.PushBack( gamedataStatType.PersonalityDisgust );
		personalities.PushBack( gamedataStatType.PersonalityFear );
		personalities.PushBack( gamedataStatType.PersonalityFunny );
		personalities.PushBack( gamedataStatType.PersonalityJoy );
		personalities.PushBack( gamedataStatType.PersonalitySad );
		personalities.PushBack( gamedataStatType.PersonalityShock );
		personalities.PushBack( gamedataStatType.PersonalitySurprise );
		lookAtData.personality = personalities[ RandRange( 0, 9 ) ];
		lookAtData.category = 3;
		switch( lookAtData.personality )
		{
			case gamedataStatType.PersonalityAggressive:
				lookAtData.idle = 1;
			break;
			case gamedataStatType.PersonalityCuriosity:
				lookAtData.category = 1;
			lookAtData.idle = 3;
			break;
			case gamedataStatType.PersonalityDisgust:
				lookAtData.idle = 7;
			break;
			case gamedataStatType.PersonalityFear:
				lookAtData.idle = 10;
			break;
			case gamedataStatType.PersonalityFunny:
				lookAtData.idle = 5;
			break;
			case gamedataStatType.PersonalityJoy:
				lookAtData.idle = 5;
			break;
			case gamedataStatType.PersonalitySad:
				lookAtData.idle = 3;
			break;
			case gamedataStatType.PersonalityShock:
				lookAtData.idle = 8;
			break;
			case gamedataStatType.PersonalitySurprise:
				lookAtData.idle = 8;
			break;
			default:
				lookAtData.idle = 2;
			lookAtData.category = 2;
			break;
		}
	}

	private function MapLookAtVO( lookAtData : LookAtData, out vo : CName )
	{
		switch( lookAtData.personality )
		{
			case gamedataStatType.PersonalityAggressive:
				vo = 'fear_foll';
			break;
			case gamedataStatType.PersonalityCuriosity:
				vo = 'greeting';
			break;
			case gamedataStatType.PersonalityDisgust:
				vo = 'fear_foll';
			break;
			case gamedataStatType.PersonalityFear:
				vo = 'fear_foll';
			break;
			case gamedataStatType.PersonalityFunny:
				vo = 'greeting';
			break;
			case gamedataStatType.PersonalityJoy:
				vo = 'greeting';
			break;
			case gamedataStatType.PersonalitySad:
				vo = '';
			break;
			case gamedataStatType.PersonalityShock:
				vo = 'fear_foll';
			break;
			case gamedataStatType.PersonalitySurprise:
				vo = 'greeting';
			break;
			default:
				vo = '';
			break;
			break;
		}
	}

	private virtual function ActivateReactionLookAt( targetEntity : Entity, optional end : Bool, optional repeat : Bool, optional duration : Float, optional upperBody : Bool, optional inVehicle : Bool ) : Bool
	{
		var lookAtEvent : LookAtAddEvent;
		var endLookat : EndLookatEvent;
		var lookAtPartRequest : LookAtPartRequest;
		var lookAtParts : array< LookAtPartRequest >;
		var owner : GameObject;
		if( !( targetEntity ) )
		{
			return false;
		}
		if( m_highLevelState == gamedataNPCHighLevelState.Combat )
		{
			return false;
		}
		owner = GetOwner();
		if( StatusEffectSystem.ObjectHasStatusEffectWithTag( owner, 'LoreAnim' ) )
		{
			return false;
		}
		if( m_lookatEvent )
		{
			DeactiveLookAt();
		}
		lookAtEvent = new LookAtAddEvent;
		lookAtEvent.SetEntityTarget( targetEntity, 'pla_default_tgt', Vector4.EmptyVector() );
		lookAtEvent.SetStyle( animLookAtStyle.Normal );
		lookAtEvent.request.limits.softLimitDegrees = 360.0;
		lookAtEvent.request.limits.hardLimitDegrees = 270.0;
		lookAtEvent.request.limits.backLimitDegrees = 210.0;
		lookAtEvent.request.limits.hardLimitDistance = GetLookAtLimitDistanceValue( animLookAtLimitDistanceType.None );
		lookAtEvent.request.calculatePositionInParentSpace = true;
		lookAtEvent.bodyPart = 'Eyes';
		lookAtPartRequest.partName = 'Head';
		lookAtPartRequest.weight = 0.1;
		lookAtPartRequest.suppress = 1.0;
		lookAtPartRequest.mode = 0;
		lookAtParts.PushBack( lookAtPartRequest );
		if( !( inVehicle ) )
		{
			lookAtPartRequest.partName = 'Chest';
			lookAtPartRequest.weight = 2.0;
			lookAtPartRequest.suppress = 0.0;
			lookAtPartRequest.mode = 0;
			if( upperBody )
			{
				lookAtPartRequest.weight = 0.2;
			}
			lookAtParts.PushBack( lookAtPartRequest );
		}
		if( !( IsFinal() ) )
		{
			lookAtEvent.SetDebugInfo( "ScriptReactionComponent" );
		}
		lookAtEvent.SetAdditionalPartsArray( lookAtParts );
		owner.QueueEvent( lookAtEvent );
		if( end )
		{
			endLookat = new EndLookatEvent;
			endLookat.repeat = repeat;
			if( duration != 0.0 )
			{
				GetDelaySystem().DelayEvent( owner, endLookat, TweakDBInterface.GetFloat( T"AIGeneralSettings.reactionLookAtDuration", duration ) );
			}
			else
			{
				GetDelaySystem().DelayEvent( owner, endLookat, TweakDBInterface.GetFloat( T"AIGeneralSettings.reactionLookAtDuration", 5.0 ) );
			}
		}
		m_lookatEvent = lookAtEvent;
		return true;
	}

	private virtual function DeactiveLookAt( optional repeat : Bool ) : Bool
	{
		var repeatLookat : RepeatLookatEvent;
		var owner : GameObject;
		if( !( m_lookatEvent ) )
		{
			return false;
		}
		owner = GetOwner();
		LookAtRemoveEvent.QueueRemoveLookatEvent( owner, m_lookatEvent );
		m_lookatEvent = NULL;
		if( ( ( repeat && m_playerProximity ) && !( ScriptedPuppet.IsDefeated( owner ) ) ) && !( m_lookatRepeat ) )
		{
			repeatLookat = new RepeatLookatEvent;
			repeatLookat.target = GetPlayerSystem().GetLocalPlayerControlledGameObject();
			GetDelaySystem().DelayEvent( owner, repeatLookat, TweakDBInterface.GetFloat( T"AIGeneralSettings.repeatReactionLookAtDelay", 2.5 ) );
			m_lookatRepeat = true;
		}
		return true;
	}

	private function OnReactionStarted( reactionData : AIReactionData )
	{
		var owner : GameObject;
		var game : GameInstance;
		var ownerPuppet : ScriptedPuppet;
		var player : GameObject;
		var stimTypeName : CName;
		owner = GetOwner();
		ownerPuppet = GetOwnerPuppet();
		game = owner.GetGame();
		m_activeReaction = reactionData;
		if( m_desiredReaction == reactionData )
		{
			m_desiredReaction = NULL;
		}
		m_workspotReactionPlayed = false;
		if( ownerPuppet && ownerPuppet.GetPuppetStateBlackboard() )
		{
			ownerPuppet.GetPuppetStateBlackboard().SetInt( GetAllBlackboardDefs().PuppetState.ReactionBehavior, ( ( Int32 )( m_activeReaction.reactionBehaviorName ) ) );
			ownerPuppet.GetPuppetStateBlackboard().FireCallbacks();
		}
		if( reactionData.reactionCooldown != 0.0 )
		{
			GameObject.StartCooldown( owner, EnumValueToName( 'gamedataStimType', ( ( Int32 )( reactionData.stimType ) ) ), reactionData.reactionCooldown );
		}
		if( reactionData.reactionBehaviorName == gamedataOutput.DeviceInvestigate )
		{
			m_investigationList.PushBack( reactionData.stimEventData );
		}
		if( reactionData.reactionBehaviorName == gamedataOutput.Panic )
		{
			player = GameInstance.GetPlayerSystem( game ).GetLocalPlayerControlledGameObject();
			if( GameInstance.GetStatsSystem( game ).GetStatValue( player.GetEntityID(), gamedataStatType.CausingPanicReducesUltimateHacksCost ) == 1.0 )
			{
				StatusEffectHelper.ApplyStatusEffect( player, T"BaseStatusEffect.ReduceUltimateHackCostBy2" );
			}
		}
		stimTypeName = EnumValueToName( 'gamedataStimType', ( ( Int32 )( reactionData.stimType ) ) );
		if( !( GameObject.IsCooldownActive( owner, 'ActiveReactionValueCooldown-' + stimTypeName ) ) )
		{
			AddReactionValueToStatPool( reactionData );
			GameObject.StartCooldown( owner, 'ActiveReactionValueCooldown-' + stimTypeName, 1.0 );
		}
		CacheReaction( reactionData );
	}

	public function GetCurrentStimTimeStamp() : Float
	{
		return m_timeStampThreshold;
	}

	public function GetCurrentStimThresholdValue() : Int32
	{
		return m_currentStimThresholdValue;
	}

	public function GetCurrentStealthStimTimeStamp() : Float
	{
		return m_stealthTimeStampThreshold;
	}

	public function GetCurrentStealthStimThresholdValue() : Int32
	{
		return m_currentStealthStimThresholdValue;
	}

	private function AddInvestigatedBody( bodyID : EntityID )
	{
		var body : Entity;
		var bodyInvestigatedEvent : AddInvestigatorEvent;
		bodyInvestigatedEvent = new AddInvestigatorEvent;
		bodyInvestigatedEvent.investigator = GetOwner().GetEntityID();
		body = GameInstance.FindEntityByID( GetOwner().GetGame(), bodyID );
		body.QueueEvent( bodyInvestigatedEvent );
	}

	protected event OnAddInvestigatedBodyEvent( evt : AddInvestigatorEvent )
	{
		m_deadBodyInvestigators.PushBack( evt.investigator );
	}

	public function InformInvestigators()
	{
		var i : Int32;
		var bodyInvestigator : ScriptedPuppet;
		var removeIgnoreListEvent : IgnoreListEvent;
		removeIgnoreListEvent = new IgnoreListEvent;
		removeIgnoreListEvent.bodyID = GetOwner().GetEntityID();
		removeIgnoreListEvent.removeEvent = true;
		for( i = 0; i < m_deadBodyInvestigators.Size(); i += 1 )
		{
			bodyInvestigator = ( ( ScriptedPuppet )( GameInstance.FindEntityByID( GetOwner().GetGame(), m_deadBodyInvestigators[ i ] ) ) );
			if( ScriptedPuppet.IsAlive( bodyInvestigator ) )
			{
				bodyInvestigator.QueueEvent( removeIgnoreListEvent );
			}
		}
	}

	protected event OnBodyPickedUp( evt : SetBodyPositionEvent )
	{
		var droppedPosition : Vector4;
		var acceptableDistance : Float;
		acceptableDistance = 5.0;
		if( evt.pickedUp )
		{
			m_deadBodyStartingPosition = evt.bodyPosition;
			StatusEffectHelper.ApplyStatusEffect( GetOwner(), T"BaseStatusEffect.BeingCarried" );
		}
		else
		{
			droppedPosition = evt.bodyPosition;
			StatusEffectHelper.RemoveStatusEffect( GetOwner(), T"BaseStatusEffect.BeingCarried" );
			if( Vector4.IsZero( m_deadBodyStartingPosition ) )
			{
				return false;
			}
			if( Vector4.Distance( m_deadBodyStartingPosition, droppedPosition ) > acceptableDistance )
			{
				InformInvestigators();
			}
		}
	}

	private function OnReactionEnded()
	{
		var ownerPuppet : ScriptedPuppet;
		ownerPuppet = GetOwnerPuppet();
		m_activeReaction = NULL;
		if( ownerPuppet && ownerPuppet.GetPuppetStateBlackboard() )
		{
			ownerPuppet.GetPuppetStateBlackboard().SetInt( GetAllBlackboardDefs().PuppetState.ReactionBehavior, ( ( Int32 )( gamedataOutput.Ignore ) ) );
			GetPuppetReactionBlackboard().SetBool( GetAllBlackboardDefs().PuppetReaction.exitReactionFlag, false );
		}
		m_investigationList.Clear();
	}

	protected event OnResetReactionEvent( evt : ResetReactionEvent )
	{
		if( m_desiredReaction == evt.data )
		{
			m_desiredReaction = NULL;
		}
	}

	public static function BodyInvestigated( owner : weak< ScriptedPuppet > )
	{
		if( !( owner ) )
		{
			return;
		}
		owner.QueueEvent( new BodyInvestigatedEvent );
	}

	protected event OnBodyInvestigated( evt : BodyInvestigatedEvent )
	{
		var ignoreListEvent : IgnoreListEvent;
		if( ShouldAddToIgnoreList( m_activeReaction.stimType ) )
		{
			ignoreListEvent = new IgnoreListEvent;
			ignoreListEvent.bodyID = m_activeReaction.stimEventData.source.GetEntityID();
			m_ignoreList.PushBack( ignoreListEvent.bodyID );
			SendEventToSquad( ignoreListEvent );
		}
		if( GetOwnerPuppet().GetHighLevelStateFromBlackboard() != gamedataNPCHighLevelState.Combat )
		{
			SetWarningMessage( "LocKey#53240" );
			if( GetOwnerPuppet().IsConnectedToSecuritySystem() )
			{
				NotifySecuritySystem( m_activeReaction.stimType, m_activeReaction.stimTarget );
			}
		}
	}

	private function CheckSquadInvestigation( stimEventData : StimEventData ) : Bool
	{
		var smi : SquadScriptInterface;
		var squadMembers : array< weak< Entity > >;
		var member : ScriptedPuppet;
		var i : Int32;
		if( !( AISquadHelper.GetSquadMemberInterface( GetOwnerPuppet(), smi ) ) )
		{
			return IsInList( m_investigationList, stimEventData );
		}
		squadMembers = smi.ListMembersWeak();
		for( i = 0; i < squadMembers.Size(); i += 1 )
		{
			member = ( ( ScriptedPuppet )( squadMembers[ i ] ) );
			if( smi.HasOrderBySquadAction( 'Investigate', member ) )
			{
				return IsInList( m_investigationList, stimEventData );
			}
		}
		return IsInList( m_investigationList, stimEventData );
	}

	private const function GetOwnerPuppet() : ScriptedPuppet
	{
		return ( ( ScriptedPuppet )( GetOwner() ) );
	}

	private function HasCombatTarget() : Bool
	{
		var combatTarget : weak< GameObject >;
		if( !( GetOwnerPuppet() ) )
		{
			return false;
		}
		combatTarget = ( ( weak< weak< GameObject > > )( GetOwnerPuppet().GetAIControllerComponent().GetBehaviorArgument( 'CombatTarget' ) ) );
		if( combatTarget )
		{
			return true;
		}
		return false;
	}

	private function PickCloserTarget( newStimEvent : StimuliEvent, out updateByActive : Bool )
	{
		var activeDistanceSquared : Float;
		var ownerPos : Vector4;
		ownerPos = GetOwner().GetWorldPosition();
		activeDistanceSquared = Vector4.DistanceSquared( m_activeReaction.stimSource, ownerPos );
		if( activeDistanceSquared < Vector4.DistanceSquared( newStimEvent.sourcePosition, ownerPos ) )
		{
			updateByActive = true;
		}
	}

	private const function DidTargetMakeMeAlerted( target : GameObject ) : Bool
	{
		var reactionData : AIReactionData;
		var stimData : stimInvestigateData;
		var mountInfo : MountingInfo;
		var owner : GameObject;
		var game : GameInstance;
		var simTime : Float;
		var ownerPuppet : ScriptedPuppet;
		owner = GetOwner();
		ownerPuppet = GetOwnerPuppet();
		if( m_reactionCache.Size() == 0 )
		{
			return false;
		}
		if( ownerPuppet.GetHighLevelStateFromBlackboard() == gamedataNPCHighLevelState.Alerted && !( ownerPuppet.GetSecuritySystem().IsReprimandOngoing() ) )
		{
			reactionData = m_reactionCache[ m_reactionCache.Size() - 1 ];
			stimData = reactionData.stimInvestigateData;
			if( ( ( ( reactionData.stimTarget == target ) || ( stimData.attackInstigator == ( ( Entity )( target ) ) ) ) && ( reactionData.recentReactionTimeStamp >= simTime ) ) && reactionData.reactionBehaviorName != gamedataOutput.Reprimand )
			{
				return true;
			}
			game = owner.GetGame();
			simTime = EngineTime.ToFloat( GameInstance.GetSimTime( game ) );
			if( ( EngineTime.ToFloat( ( ( NPCPuppet )( owner ) ).GetLastSEAppliedByPlayer().GetLastApplicationSimTimestamp() ) + 10.0 ) >= simTime )
			{
				return true;
			}
			if( IsTargetInterestingForRecentSquadMates( target, reactionData.stimTarget ) )
			{
				return true;
			}
			if( m_stolenVehicle && VehicleComponent.IsMountedToVehicle( game, target ) )
			{
				mountInfo = GameInstance.GetMountingFacility( game ).GetMountingInfoSingleWithObjects( target );
				if( m_stolenVehicle == ( ( VehicleObject )( GameInstance.FindEntityByID( game, mountInfo.parentId ) ) ) )
				{
					return true;
				}
			}
		}
		return false;
	}

	private const function IsTargetInterestingForRecentSquadMates( target : GameObject, ally : GameObject ) : Bool
	{
		var stimData : stimInvestigateData;
		var reactionCache : array< AIReactionData >;
		var reactionData : AIReactionData;
		var simTime : Float;
		if( IsTargetRecentSquadAlly( ally ) )
		{
			reactionCache = ( ( ScriptedPuppet )( ally ) ).GetStimReactionComponent().GetReactionCache();
			reactionData = reactionCache[ reactionCache.Size() - 1 ];
			stimData = reactionData.stimInvestigateData;
			simTime = EngineTime.ToFloat( GameInstance.GetSimTime( GetOwner().GetGame() ) );
			if( ( stimData.attackInstigator == ( ( Entity )( target ) ) ) && ( reactionData.recentReactionTimeStamp >= simTime ) )
			{
				return true;
			}
			if( ( EngineTime.ToFloat( ( ( NPCPuppet )( ally ) ).GetLastSEAppliedByPlayer().GetLastApplicationSimTimestamp() ) + 10.0 ) >= simTime )
			{
				return true;
			}
		}
		return false;
	}

	private const function IsPlayerAiming() : Bool
	{
		var weapon : WeaponObject;
		var player : GameObject;
		var blackboard : IBlackboard;
		player = GameInstance.GetPlayerSystem( GetOwner().GetGame() ).GetLocalPlayerControlledGameObject();
		weapon = GameObject.GetActiveWeapon( player );
		blackboard = ( ( PlayerPuppet )( player ) ).GetPlayerStateMachineBlackboard();
		if( ( ( ( ( blackboard.GetInt( GetAllBlackboardDefs().PlayerStateMachine.UpperBody ) == ( ( Int32 )( gamePSMUpperBodyStates.Aim ) ) ) && weapon.IsRanged() ) || ( blackboard.GetInt( GetAllBlackboardDefs().PlayerStateMachine.MeleeWeapon ) == ( ( Int32 )( gamePSMMeleeWeapon.ChargedHold ) ) ) ) || ( blackboard.GetInt( GetAllBlackboardDefs().PlayerStateMachine.MeleeWeapon ) == ( ( Int32 )( gamePSMMeleeWeapon.Targeting ) ) ) ) || ( blackboard.GetInt( GetAllBlackboardDefs().PlayerStateMachine.LeftHandCyberware ) == ( ( Int32 )( gamePSMLeftHandCyberware.Charge ) ) ) )
		{
			if( GameInstance.GetBlackboardSystem( GetOwner().GetGame() ).Get( GetAllBlackboardDefs().UI_TargetingInfo ).GetEntityID( GetAllBlackboardDefs().UI_TargetingInfo.CurrentVisibleTarget ) == GetOwner().GetEntityID() )
			{
				return true;
			}
		}
		if( blackboard.GetInt( GetAllBlackboardDefs().PlayerStateMachine.CombatGadget ) == ( ( Int32 )( gamePSMCombatGadget.Charging ) ) )
		{
			return true;
		}
		return false;
	}

	public const function GetDesiredReactionData() : AIReactionData
	{
		return m_desiredReaction;
	}

	public const function GetActiveReactionData() : AIReactionData
	{
		return m_activeReaction;
	}

	public const function GetDesiredReactionName() : gamedataOutput
	{
		if( !( m_desiredReaction ) )
		{
			return gamedataOutput.Ignore;
		}
		return m_desiredReaction.reactionBehaviorName;
	}

	public const function GetReactionBehaviorName() : gamedataOutput
	{
		if( !( m_activeReaction ) )
		{
			return gamedataOutput.Ignore;
		}
		return m_activeReaction.reactionBehaviorName;
	}

	public const function GetReactionCache() : array< AIReactionData >
	{
		return m_reactionCache;
	}

	public const function GetStimuliCache() : array< StimEventTaskData >
	{
		return m_stimuliCache;
	}

	public const function GetReceivedStimType() : gamedataStimType
	{
		return m_receivedStimType;
	}

	public const function GetWorkSpotReactionFlag() : Bool
	{
		return m_workspotReactionPlayed;
	}

	public const function IsTargetInterestingForPerception( target : GameObject ) : Bool
	{
		var reactionData : AIReactionData;
		if( !( target ) )
		{
			return false;
		}
		if( DidTargetMakeMeAlerted( target ) )
		{
			return true;
		}
		if( IsPlayerCarryingBody( ( ( PlayerPuppet )( target ) ) ) && IsReactionAvailableInPreset( gamedataStimType.CarryBody ) )
		{
			return true;
		}
		if( ( ( PlayerPuppet )( target ) ).GetPlayerStateMachineBlackboard().GetInt( GetAllBlackboardDefs().PlayerStateMachine.Takedown ) > 0 )
		{
			return true;
		}
		if( IsPlayerAiming() && IsReactionAvailableInPreset( gamedataStimType.AimingAt ) )
		{
			return true;
		}
		if( ( !( WeaponObject.IsFists( GameObject.GetActiveWeapon( target ).GetItemID() ) ) && GameObject.GetActiveWeapon( target ) ) && CanAskToHolsterWeapon() )
		{
			return true;
		}
		reactionData = GetActiveReactionData();
		if( reactionData )
		{
			if( reactionData.reactionBehaviorName == gamedataOutput.BodyInvestigate )
			{
				return true;
			}
			if( reactionData.stimTarget == target )
			{
				if( reactionData.reactionBehaviorName == gamedataOutput.AskToFollowOrder && reactionData.reactionBehaviorName != gamedataOutput.TurnAt )
				{
					return false;
				}
				if( reactionData.reactionBehaviorName == gamedataOutput.PlayerCall )
				{
					return false;
				}
				return true;
			}
		}
		return false;
	}

	public const function GetPuppetReactionBlackboard() : IBlackboard
	{
		return m_puppetReactionBlackboard;
	}

	private function IsInitAnimShock( behavior : gamedataOutput ) : Bool
	{
		if( GetOwnerPuppet().GetHighLevelStateFromBlackboard() != gamedataNPCHighLevelState.Combat )
		{
			if( ( behavior == gamedataOutput.Investigate || behavior == gamedataOutput.Intruder ) || behavior == gamedataOutput.Panic )
			{
				return true;
			}
		}
		return false;
	}

	public const function IsInitAnimCall( stim : gamedataStimType ) : Bool
	{
		if( stim == gamedataStimType.Call )
		{
			return true;
		}
		return false;
	}

	public const function GetInPendingBehavior() : Bool
	{
		return m_inPendingBehavior;
	}

	public const function GetReactionPreset() : weak< ReactionPreset_Record >
	{
		return m_reactionPreset;
	}

	private function IsInPendingBehavior() : Bool
	{
		if( m_inPendingBehavior )
		{
			return true;
		}
		if( m_stanceState == gamedataNPCStanceState.Vehicle || m_stanceState == gamedataNPCStanceState.VehicleWindow )
		{
			return true;
		}
		if( ( ( NPCPuppet )( GetOwnerPuppet() ) ).IsRagdolling() )
		{
			return true;
		}
		return false;
	}

	public const function IsAlertedByDeadBody() : Bool
	{
		return m_isAlertedByDeadBody;
	}

	public function GetPreviousFearPhase() : Int32
	{
		return m_previousFearPhase;
	}

	public function GetEnvironmentalHazards() : array< StimuliEvent >
	{
		return m_environmentalHazards;
	}

	private const function GetActiveStimPriority() : gamedataStimPriority
	{
		if( !( m_activeReaction ) )
		{
			return gamedataStimPriority.Invalid;
		}
		return m_activeReaction.stimPriority;
	}

	private const function GetActiveStimTarget() : GameObject
	{
		if( !( m_activeReaction ) )
		{
			return NULL;
		}
		return m_activeReaction.stimTarget;
	}

	private const function GetActiveStimSource() : Vector4
	{
		if( !( m_activeReaction ) )
		{
			return Vector4.EmptyVector();
		}
		return m_activeReaction.stimSource;
	}

	private function ShouldUpdateThreatPosition( stimEvent : StimuliEvent ) : Bool
	{
		if( stimEvent.IsTagInStimuli( 'Direct' ) )
		{
			return false;
		}
		if( stimEvent.sourceObject != ( ( weak< weak< GameObject > > )( GetOwnerPuppet().GetAIControllerComponent().GetBehaviorArgument( 'CombatTarget' ) ) ) )
		{
			return false;
		}
		if( IsTargetVisible( stimEvent.sourceObject ) )
		{
			return false;
		}
		if( stimEvent.stimPropagation == gamedataStimPropagation.Visual && stimEvent.GetStimType() != gamedataStimType.Gunshot )
		{
			return false;
		}
		if( SenseComponent.ShouldIgnoreIfPlayerCompanion( GetOwnerPuppet(), stimEvent.sourceObject ) )
		{
			return false;
		}
		return true;
	}

	private function ShouldTriggerGrenadeDodgeBehavior( stimEvent : StimuliEvent ) : Bool
	{
		var stimDistanceSquared : Float;
		var innerRadius : Float;
		var ownerPuppet : ScriptedPuppet;
		var grenade : BaseGrenade;
		ownerPuppet = GetOwnerPuppet();
		if( ownerPuppet.IsCharacterCivilian() || ownerPuppet.GetNPCType() == gamedataNPCType.Drone )
		{
			return true;
		}
		if( StatusEffectSystem.ObjectHasStatusEffectOfType( ownerPuppet, gamedataStatusEffectType.Wounded ) )
		{
			return false;
		}
		innerRadius = TweakDBInterface.GetFloat( T"AIGeneralSettings.grenadeDodgeInnerRadius", 0.0 );
		stimDistanceSquared = Vector4.DistanceSquared( GetOwner().GetWorldPosition(), stimEvent.sourcePosition );
		grenade = ( ( BaseGrenade )( stimEvent.sourceObject ) );
		if( ( ( stimDistanceSquared <= ( innerRadius * innerRadius ) ) || IsTargetInFront( grenade ) ) || IsTargetInFront( grenade.GetUser() ) )
		{
			return true;
		}
		return false;
	}

	private function CanTriggerPanicInCombat( stimEvent : StimuliEvent ) : Bool
	{
		var stimDistanceSquared : Float;
		var distance : Float;
		if( !( HasCombatTarget() ) )
		{
			return true;
		}
		stimDistanceSquared = Vector4.DistanceSquared( GetOwner().GetWorldPosition(), stimEvent.sourcePosition );
		distance = TweakDBInterface.GetFloat( T"AIGeneralSettings.panicInCombatReactionDistance", 10.0 );
		if( stimDistanceSquared <= ( distance * distance ) )
		{
			return true;
		}
		return false;
	}

	private function CanStimInterruptCombat( stimEvent : StimuliEvent ) : Bool
	{
		var grenade : BaseGrenade;
		grenade = ( ( BaseGrenade )( stimEvent.sourceObject ) );
		if( !( stimEvent.IsTagInStimuli( 'Combat' ) ) && !( ( stimEvent.GetStimType() == gamedataStimType.ProjectileDistraction && grenade ) ) )
		{
			return false;
		}
		if( ScriptedPuppet.IsOnOffMeshLink( GetOwner() ) )
		{
			return false;
		}
		if( grenade && ( grenade.GetUser() == GetOwner() ) )
		{
			return false;
		}
		return true;
	}

	private function ShouldAddToIgnoreList( stimType : gamedataStimType ) : Bool
	{
		if( stimType == gamedataStimType.DeadBody )
		{
			return true;
		}
		return false;
	}

	private function IsTargetVisible( target : GameObject ) : Bool
	{
		var senseComponent : SenseComponent;
		senseComponent = GetOwnerPuppet().GetSensesComponent();
		if( !( senseComponent ) && !( target ) )
		{
			return false;
		}
		if( senseComponent.IsAgentVisible( target ) )
		{
			return true;
		}
		return false;
	}

	private function IsTargetDetected( target : GameObject ) : Bool
	{
		var senseComponent : SenseComponent;
		senseComponent = GetOwnerPuppet().GetSensesComponent();
		if( !( senseComponent ) && !( target ) )
		{
			return false;
		}
		if( senseComponent.GetDetection( target.GetEntityID() ) >= 100.0 )
		{
			return true;
		}
		return false;
	}

	private function SourceAttitude( source : weak< GameObject >, attitude : EAIAttitude ) : Bool
	{
		var attitudeOwner : AttitudeAgent;
		var attitudeTarget : AttitudeAgent;
		attitudeOwner = GetOwner().GetAttitudeAgent();
		attitudeTarget = source.GetAttitudeAgent();
		if( ( attitudeOwner && attitudeTarget ) && source )
		{
			if( attitudeOwner.GetAttitudeTowards( attitudeTarget ) == attitude )
			{
				return true;
			}
		}
		return false;
	}

	private function IsTargetInFront( target : weak< GameObject >, optional frontAngle : Float, optional meInFrontOfTarget : Bool ) : Bool
	{
		var direction : Vector4;
		var angleToTarget : Float;
		var owner : GameObject;
		var ownerPos : Vector4;
		var ownerFwd : Vector4;
		var ownerUp : Vector4;
		var targetPos : Vector4;
		owner = GetOwner();
		ownerPos = owner.GetWorldPosition();
		ownerFwd = owner.GetWorldForward();
		ownerUp = owner.GetWorldUp();
		targetPos = target.GetWorldPosition();
		if( frontAngle == 0.0 )
		{
			frontAngle = 90.0;
		}
		if( meInFrontOfTarget )
		{
			direction = ownerPos - targetPos;
			angleToTarget = Vector4.GetAngleDegAroundAxis( direction, target.GetWorldForward(), target.GetWorldUp() );
			if( AbsF( angleToTarget ) < frontAngle )
			{
				return true;
			}
		}
		else
		{
			direction = targetPos - ownerPos;
			angleToTarget = Vector4.GetAngleDegAroundAxis( direction, ownerFwd, ownerUp );
			if( AbsF( angleToTarget ) < frontAngle )
			{
				return true;
			}
		}
		return false;
	}

	private function IsTargetBehind( target : weak< GameObject >, optional angle : Float, optional meBehindOfTarget : Bool ) : Bool
	{
		var direction : Vector4;
		var angleToTarget : Float;
		var owner : GameObject;
		var ownerPos : Vector4;
		var ownerFwd : Vector4;
		var ownerUp : Vector4;
		var targetPos : Vector4;
		owner = GetOwner();
		ownerPos = owner.GetWorldPosition();
		ownerFwd = owner.GetWorldForward();
		ownerUp = owner.GetWorldUp();
		targetPos = target.GetWorldPosition();
		direction = targetPos - ownerPos;
		angleToTarget = Vector4.GetAngleDegAroundAxis( direction, ownerFwd, ownerUp );
		if( angle == 0.0 )
		{
			angle = 120.0;
		}
		if( meBehindOfTarget )
		{
			direction = ownerPos - targetPos;
			angleToTarget = Vector4.GetAngleDegAroundAxis( direction, target.GetWorldForward(), target.GetWorldUp() );
			if( AbsF( angleToTarget ) > angle )
			{
				return true;
			}
		}
		else
		{
			direction = targetPos - ownerPos;
			angleToTarget = Vector4.GetAngleDegAroundAxis( direction, ownerFwd, ownerUp );
			if( AbsF( angleToTarget ) > angle )
			{
				return true;
			}
		}
		return false;
	}

	public function IsTargetInMovementDirection( target : weak< GameObject > ) : Bool
	{
		var vecToTarget : Vector4;
		var angleToTarget : Float;
		var movementDirection : Vector4;
		vecToTarget = target.GetWorldPosition() - GetOwner().GetWorldPosition();
		movementDirection = GetOwnerPuppet().GetCrowdMemberComponent().GetMovementDirection();
		if( !( Vector4.IsZero( movementDirection ) ) )
		{
			angleToTarget = Vector4.GetAngleDegAroundAxis( vecToTarget, movementDirection, GetOwner().GetWorldUp() );
			if( AbsF( angleToTarget ) < 90.0 )
			{
				return true;
			}
		}
		return false;
	}

	private function IsTargetClose( target : weak< GameObject >, optional distance : Float ) : Bool
	{
		var distanceSquared : Float;
		distanceSquared = Vector4.DistanceSquared( target.GetWorldPosition(), GetOwner().GetWorldPosition() );
		if( distance > 0.0 )
		{
			if( distanceSquared < ( distance * distance ) )
			{
				return true;
			}
		}
		else if( distanceSquared < ( m_crowdAimingReactionDistance * m_crowdAimingReactionDistance ) )
		{
			return true;
		}
		return false;
	}

	private function TargetVerticalCheck( target : weak< GameObject >, optional distance : Float ) : Bool
	{
		var vecToTarget : Vector4;
		vecToTarget = GetOwner().GetWorldPosition() - target.GetWorldPosition();
		if( AbsF( vecToTarget.Z ) > 2.0 )
		{
			return false;
		}
		return true;
	}

	public static function ReactOnPlayerStealthStim( owner : weak< GameObject >, target : weak< GameObject > ) : Bool
	{
		var attitudeOwner : AttitudeAgent;
		var attitudeTarget : AttitudeAgent;
		var attitudeTowardsTarget : EAIAttitude;
		attitudeOwner = owner.GetAttitudeAgent();
		if( attitudeOwner )
		{
			attitudeTarget = target.GetAttitudeAgent();
			if( attitudeTarget && target.IsPlayer() )
			{
				attitudeTowardsTarget = attitudeOwner.GetAttitudeTowards( attitudeTarget );
			}
			else if( GameObject.IsVehicle( target ) )
			{
				target = GameInstance.GetPlayerSystem( owner.GetGame() ).GetLocalPlayerMainGameObject();
				attitudeTarget = target.GetAttitudeAgent();
				attitudeTowardsTarget = attitudeOwner.GetAttitudeTowards( attitudeTarget );
			}
			if( attitudeTarget )
			{
				if( attitudeTowardsTarget == EAIAttitude.AIA_Hostile )
				{
					return true;
				}
				else if( ( attitudeTowardsTarget == EAIAttitude.AIA_Neutral && owner.IsConnectedToSecuritySystem() ) && owner.IsTargetTresspassingMyZone( target ) )
				{
					return true;
				}
			}
		}
		return false;
	}

	private function CheckHearingDistance( stimEvent : StimuliEvent ) : Bool
	{
		var distanceSquared : Float;
		var radius : Float;
		distanceSquared = Vector4.DistanceSquared( GetOwner().GetWorldPosition(), stimEvent.sourcePosition );
		radius = stimEvent.radius * GameInstance.GetStatsSystem( GetOwner().GetGame() ).GetStatValue( GetOwner().GetEntityID(), gamedataStatType.Hearing );
		if( distanceSquared <= ( radius * radius ) )
		{
			return true;
		}
		return false;
	}

	private function IsVisible( stimEvent : StimuliEvent, stimOffset : Vector4 ) : Bool
	{
		var raycastTrace : TraceResult;
		var hit : Bool;
		hit = GameInstance.GetSpatialQueriesSystem( GetOwner().GetGame() ).SyncRaycastByQueryPreset( GetOwner().GetWorldPosition() + stimOffset, stimEvent.sourcePosition + stimOffset, 'Sight Blocker', raycastTrace );
		return !( hit );
	}

	private function ValidVisualGunshotTarget( stimEvent : StimuliEvent, reactionData : AIReactionData ) : Bool
	{
		if( reactionData.stimType == gamedataStimType.Gunshot )
		{
			return false;
		}
		if( IsTargetClose( stimEvent.sourceObject, 25.0 ) )
		{
			return false;
		}
		if( !( IsTargetInFront( stimEvent.sourceObject, 60.0 ) ) )
		{
			return false;
		}
		if( !( IsTargetInFront( stimEvent.sourceObject, 50.0, true ) ) )
		{
			return false;
		}
		return true;
	}

	private function IsDirectStimuli( stimType : gamedataStimType ) : Bool
	{
		if( stimType == gamedataStimType.Combat )
		{
			return true;
		}
		return false;
	}

	private function IsPublicZone( stimEvent : StimuliEvent ) : Bool
	{
		if( stimEvent.GetStimType() == gamedataStimType.WeaponDisplayed )
		{
			return true;
		}
		return false;
	}

	private function IsPlayerInZone( zone : gamePSMZones ) : Bool
	{
		var psmBlackboard : IBlackboard;
		var blackboardSystem : BlackboardSystem;
		blackboardSystem = GameInstance.GetBlackboardSystem( GetOwner().GetGame() );
		psmBlackboard = blackboardSystem.GetLocalInstanced( GetPlayerSystem().GetLocalPlayerMainGameObject().GetEntityID(), GetAllBlackboardDefs().PlayerStateMachine );
		if( ( ( gamePSMZones )( psmBlackboard.GetInt( GetAllBlackboardDefs().PlayerStateMachine.Zones ) ) ) == zone )
		{
			return true;
		}
		return false;
	}

	private function IgnoreStimIfNonFriendly( stimEvent : StimuliEvent ) : Bool
	{
		if( stimEvent.GetStimType() == gamedataStimType.DeadBody )
		{
			return true;
		}
		return false;
	}

	private function IsSameStimulus( stimEvent : StimuliEvent ) : Bool
	{
		if( m_activeReaction && m_activeReaction.stimType == stimEvent.GetStimType() )
		{
			return true;
		}
		return false;
	}

	private function IsSameSourceObject( stimEvent : StimuliEvent ) : Bool
	{
		if( m_activeReaction && ( m_activeReaction.stimTarget == stimEvent.sourceObject ) )
		{
			return true;
		}
		return false;
	}

	private function IgnoreStimIfFromSameSource( stimEvent : StimuliEvent ) : Bool
	{
		if( stimEvent.GetStimType() == gamedataStimType.Distract )
		{
			return true;
		}
		return false;
	}

	private function IsInList( list : array< StimEventData >, stimData : StimEventData ) : Bool
	{
		var i : Int32;
		for( i = 0; i < list.Size(); i += 1 )
		{
			if( ( list[ i ].source == stimData.source ) && list[ i ].stimType == stimData.stimType )
			{
				return true;
			}
		}
		return false;
	}

	private function IsCategory( stimEvent : StimuliEvent, category : CName ) : Bool
	{
		if( stimEvent.stimRecord.Category() == category )
		{
			return true;
		}
		return false;
	}

	private function IsStimPriorityValid( stimEvent : StimuliEvent, activePriority : gamedataStimPriority ) : Bool
	{
		if( stimEvent.stimRecord.Priority().Type() == gamedataStimPriority.Low && activePriority == gamedataStimPriority.High )
		{
			return false;
		}
		return true;
	}

	private function IsTargetSquadAlly( target : weak< GameObject > ) : Bool
	{
		var smi : SquadScriptInterface;
		var squadName : CName;
		if( !( AISquadHelper.GetSquadMemberInterface( GetOwnerPuppet(), smi ) ) )
		{
			return false;
		}
		squadName = smi.GetName();
		if( !( AISquadHelper.GetSquadMemberInterface( target, smi ) ) )
		{
			return false;
		}
		if( squadName != smi.GetName() )
		{
			return false;
		}
		return true;
	}

	private function IsTargetMelee( target : GameObject ) : Bool
	{
		if( GameObject.GetActiveWeapon( target ) && !( GameObject.GetActiveWeapon( target ).IsRanged() ) )
		{
			return true;
		}
		return false;
	}

	private function IsTargetArmed( target : GameObject ) : Bool
	{
		if( GameObject.GetActiveWeapon( target ) && !( WeaponObject.IsFists( GameObject.GetActiveWeapon( target ).GetItemID() ) ) )
		{
			return true;
		}
		return false;
	}

	private const function IsTargetRecentSquadAlly( target : weak< GameObject > ) : Bool
	{
		var smi : SquadScriptInterface;
		var squadCmp : SquadMemberComponent;
		var squadName : CName;
		squadCmp = target.GetSquadMemberComponent();
		if( !( squadCmp ) )
		{
			return false;
		}
		if( !( AISquadHelper.GetSquadMemberInterface( GetOwner(), smi ) ) )
		{
			return false;
		}
		squadName = smi.GetName();
		if( squadName != squadCmp.MySquadNameCurrentOrRecent( AISquadType.Combat ) )
		{
			return false;
		}
		return true;
	}

	private function IsTargetFromSameAttitudeGroup( target : weak< GameObject > ) : Bool
	{
		var groupName : CName;
		groupName = target.GetAttitudeAgent().GetAttitudeGroup();
		if( groupName == GetOwner().GetAttitudeAgent().GetAttitudeGroup() )
		{
			return true;
		}
		return false;
	}

	private function ShouldHelpAlly( stimType : gamedataStimType ) : Bool
	{
		if( ( ( ( ( ( stimType == gamedataStimType.Gunshot || stimType == gamedataStimType.Call ) || stimType == gamedataStimType.MeleeHit ) || stimType == gamedataStimType.VehicleHit ) || stimType == gamedataStimType.Bullet ) || stimType == gamedataStimType.Alarm ) || stimType == gamedataStimType.Dying )
		{
			return true;
		}
		return false;
	}

	private const function ShouldPoliceReact( stimEvent : StimuliEvent ) : Bool
	{
		var stimTargetPuppet : ScriptedPuppet;
		var attackData : stimInvestigateData;
		stimTargetPuppet = ( ( ScriptedPuppet )( stimEvent.sourceObject ) );
		if( ( stimEvent.GetStimType() == gamedataStimType.DeadBody && stimTargetPuppet ) && stimTargetPuppet.IsCharacterGanger() )
		{
			return false;
		}
		attackData = stimEvent.stimInvestigateData;
		if( stimEvent.GetStimType() == gamedataStimType.IllegalAction && attackData.victimEntity )
		{
			stimTargetPuppet = ( ( ScriptedPuppet )( attackData.victimEntity ) );
			if( stimTargetPuppet && stimTargetPuppet.IsCharacterGanger() )
			{
				return false;
			}
		}
		if( GetOwner().IsTargetTresspassingMyZone( stimEvent.sourceObject ) )
		{
			return true;
		}
		if( PreventionSystem.ShouldReactionBeAgressive( GetOwner().GetGame() ) )
		{
			return true;
		}
		if( stimEvent.GetStimType() == gamedataStimType.CrimeWitness )
		{
			return true;
		}
		return false;
	}

	private function ShouldBeDetected( stimType : gamedataStimType ) : Bool
	{
		if( stimType == gamedataStimType.IllegalInteraction || stimType == gamedataStimType.CarryBody )
		{
			return true;
		}
		return false;
	}

	private function SetBaseReactionPreset( optional ignoreSavedPreset : Bool )
	{
		var savedPresetID : TweakDBID;
		var ownerPuppet : ScriptedPuppet;
		ownerPuppet = GetOwnerPuppet();
		savedPresetID = ownerPuppet.GetReactionPresetID();
		if( TDBID.IsValid( savedPresetID ) && !( ignoreSavedPreset ) )
		{
			m_reactionPreset = TweakDBInterface.GetReactionPresetRecord( savedPresetID );
		}
		else
		{
			m_reactionPreset = TweakDBInterface.GetCharacterRecord( GetOwnerPuppet().GetRecordID() ).ReactionPreset();
		}
		if( m_reactionPreset != NULL )
		{
			m_presetName = m_reactionPreset.EnumName();
			ownerPuppet.SetReactionPresetID( m_reactionPreset.GetID() );
		}
		ownerPuppet.RefreshCachedReactionPresetData();
	}

	private function SetReactionPreset( reactionPreset : ReactionPreset_Record )
	{
		var ownerPuppet : ScriptedPuppet;
		ownerPuppet = GetOwnerPuppet();
		if( reactionPreset == TweakDBInterface.GetCharacterRecord( ownerPuppet.GetRecordID() ).ReactionPreset() )
		{
			ReevaluateReactionPreset( true );
		}
		else
		{
			m_reactionPreset = reactionPreset;
			m_presetName = m_reactionPreset.EnumName();
			ownerPuppet.SetReactionPresetID( reactionPreset.GetID() );
		}
		ownerPuppet.RefreshCachedReactionPresetData();
	}

	private function MapReactionPreset( mappingName : String )
	{
		var ownerPuppet : ScriptedPuppet;
		var basePreset : ReactionPreset_Record;
		var newPreset : ReactionPreset_Record;
		var presets : array< weak< PresetMapper_Record > >;
		var i : Int32;
		ownerPuppet = GetOwnerPuppet();
		if( mappingName == "NoReaction" )
		{
			newPreset = TweakDBInterface.GetReactionPresetRecord( T"ReactionPresets.NoReaction" );
		}
		else if( mappingName == "Follower" )
		{
			newPreset = TweakDBInterface.GetReactionPresetRecord( T"ReactionPresets.Follower" );
		}
		else
		{
			basePreset = TweakDBInterface.GetCharacterRecord( ownerPuppet.GetRecordID() ).ReactionPreset();
			basePreset.PresetMapper( presets );
			for( i = 0; i < presets.Size(); i += 1 )
			{
				if( presets[ i ].MappingName() == mappingName )
				{
					newPreset = presets[ i ].Preset();
				}
			}
		}
		if( newPreset == NULL )
		{
			newPreset = basePreset;
		}
		m_reactionPreset = newPreset;
		m_presetName = m_reactionPreset.EnumName();
		ownerPuppet.RefreshCachedReactionPresetData();
	}

	private function ReevaluateReactionPreset( optional ignoreSavedPreset : Bool )
	{
		if( StatusEffectSystem.ObjectHasStatusEffectWithTag( GetOwner(), 'Braindance' ) || StatusEffectSystem.ObjectHasStatusEffectWithTag( GetOwner(), 'Drunk' ) )
		{
			MapReactionPreset( "NoReaction" );
		}
		else if( m_aiRole == EAIRole.Follower )
		{
			MapReactionPreset( "Follower" );
		}
		else if( StatusEffectSystem.ObjectHasStatusEffectWithTag( GetOwner(), 'Sleep' ) )
		{
			MapReactionPreset( "Sleep" );
		}
		else if( StatusEffectSystem.ObjectHasStatusEffectWithTag( GetOwner(), 'LoreAnim' ) )
		{
			MapReactionPreset( "Lore" );
		}
		else if( m_stanceState == gamedataNPCStanceState.Vehicle || m_stanceState == gamedataNPCStanceState.VehicleWindow )
		{
			MapReactionPreset( "Vehicle" );
		}
		else
		{
			SetBaseReactionPreset( ignoreSavedPreset );
		}
	}

	private function CheckCrowd()
	{
		m_inCrowd = GetOwnerPuppet().IsCrowd();
	}

	private function SetDeadBodyVisibleComponent( killer : GameObject )
	{
		var visibleObject : VisibleObjectComponent;
		var visibleObjectPosition : Vector4;
		var attackData : stimInvestigateData;
		var broadcaster : StimBroadcasterComponent;
		var exitEvent : AIEvent;
		var mountInfo : MountingInfo;
		var detectMultEvent : VisibleObjectDetectionMultEvent;
		var owner : GameObject;
		var game : GameInstance;
		owner = GetOwner();
		game = owner.GetGame();
		if( killer && killer.IsPlayer() )
		{
			visibleObject = ( ( NPCPuppet )( owner ) ).GetVisibleObjectComponent();
			visibleObject.Toggle( true );
			visibleObjectPosition = visibleObject.GetLocalPosition();
			visibleObjectPosition.Z = visibleObjectPosition.Z + 1.0;
			visibleObject.SetLocalPosition( visibleObjectPosition );
			visibleObject.visibleObject.description = 'Dead_Body';
			visibleObject.visibleObject.visibilityDistance = TweakDBInterface.GetFloat( T"AIGeneralSettings.deadBodyVisibilityDistance", 20.0 );
			detectMultEvent = new VisibleObjectDetectionMultEvent;
			detectMultEvent.multiplier = 1.20000005;
			owner.QueueEvent( detectMultEvent );
			broadcaster = killer.GetStimBroadcasterComponent();
			if( broadcaster )
			{
				attackData.victimEntity = EntityGameInterface.GetEntity( owner.GetEntity() );
				broadcaster.SetSingleActiveStimuli( owner, gamedataStimType.IllegalAction, 2.5, , attackData );
			}
			broadcaster = owner.GetStimBroadcasterComponent();
			if( broadcaster )
			{
				attackData.attackInstigator = killer;
				attackData.attackInstigatorPosition = killer.GetWorldPosition();
				broadcaster.AddActiveStimuli( owner, gamedataStimType.Dying, 2.0, , attackData );
				broadcaster.TriggerSingleBroadcast( owner, gamedataStimType.Dying, 4.0, attackData, true );
				broadcaster.AddActiveStimuli( owner, gamedataStimType.CrowdIllegalAction, -1.0 );
			}
		}
		if( VehicleComponent.IsMountedToVehicle( game, owner ) && m_inCrowd )
		{
			exitEvent = new AIEvent;
			exitEvent.name = 'ExitVehicleInPanic';
			mountInfo = GameInstance.GetMountingFacility( game ).GetMountingInfoSingleWithObjects( owner );
			VehicleComponent.QueueEventToAllNonFriendlyActivePassengers( game, mountInfo.parentId, exitEvent, owner );
		}
	}

	public static function SendVOEventToSquad( owner : weak< GameObject >, voEvent : CName, optional setOwnerAsAnsweringEntity : Bool )
	{
		var smi : SquadScriptInterface;
		var squadMembers : array< weak< Entity > >;
		var member : ScriptedPuppet;
		var ownerPuppet : ScriptedPuppet;
		var i : Int32;
		var answeringEntityId : EntityID;
		var ownerPosition : Vector4;
		var maxDistBattleCry : Float;
		var voiceOverName : CName;
		ownerPuppet = ( ( ScriptedPuppet )( owner ) );
		if( setOwnerAsAnsweringEntity )
		{
			answeringEntityId = ownerPuppet.GetEntityID();
		}
		if( !( AISquadHelper.GetSquadMemberInterface( ownerPuppet, smi ) ) )
		{
			return;
		}
		squadMembers = smi.ListMembersWeak();
		if( squadMembers.Size() <= 1 )
		{
			return;
		}
		ownerPosition = ownerPuppet.GetWorldPosition();
		maxDistBattleCry = TweakDBInterface.GetFloat( T"AIGeneralSettings.maxDistanceBattleCry", 0.0 );
		voiceOverName = 'Scripts:SendVOEventToSquad: ' + voEvent;
		for( i = 0; i < squadMembers.Size(); i += 1 )
		{
			member = ( ( ScriptedPuppet )( squadMembers[ i ] ) );
			if( member == ownerPuppet )
			{
				continue;
			}
			if( !( ScriptedPuppet.IsActive( member ) ) )
			{
				continue;
			}
			if( Vector4.Distance( member.GetWorldPosition(), ownerPosition ) < maxDistBattleCry )
			{
				GameObject.PlayVoiceOver( member, voEvent, voiceOverName, 0.0, answeringEntityId );
			}
		}
	}

	private function SendEventToSquad( optional ignoreListEvent : IgnoreListEvent )
	{
		var smi : SquadScriptInterface;
		var squadMembers : array< weak< Entity > >;
		var member : ScriptedPuppet;
		var i : Int32;
		var ownerPuppet : ScriptedPuppet;
		ownerPuppet = GetOwnerPuppet();
		if( !( AISquadHelper.GetSquadMemberInterface( ownerPuppet, smi ) ) )
		{
			return;
		}
		squadMembers = smi.ListMembersWeak();
		if( squadMembers.Size() <= 1 )
		{
			return;
		}
		for( i = 0; i < squadMembers.Size(); i += 1 )
		{
			member = ( ( ScriptedPuppet )( squadMembers[ i ] ) );
			if( member == ownerPuppet )
			{
				continue;
			}
			if( !( ScriptedPuppet.IsActive( member ) ) )
			{
				continue;
			}
			if( ignoreListEvent )
			{
				member.QueueEvent( ignoreListEvent );
			}
		}
	}

	private function GetThreatDistanceSquared( threat : GameObject ) : Float
	{
		var distanceSquared : Float;
		distanceSquared = Vector4.DistanceSquared( GetOwner().GetWorldPosition(), threat.GetWorldPosition() );
		return distanceSquared;
	}

	private function GetFearAnimWrapper( fearPhase : Int32 ) : CName
	{
		switch( fearPhase )
		{
			case 1:
				if( m_fastWalk )
				{
					return 'disturbed';
				}
				else
				{
					return 'default';
				}
			case 2:
				return 'fear';
			case 3:
				return 'panic';
			default:
				return 'default';
		}
	}

	public const function GetRandomFearLocomotionAnimWrapper( fearPhase : Int32, optional stimType : gamedataStimType ) : CName
	{
		var rand : Float;
		if( stimType == gamedataStimType.Driving )
		{
			rand = RandF();
			if( rand <= 0.33000001 )
			{
				return 'FearLocomotion1';
			}
			else if( ( rand > 0.33000001 ) && ( rand <= 0.66000003 ) )
			{
				return 'FearLocomotion3';
			}
			else
			{
				return 'FearLocomotion4';
			}
		}
		rand = RandF();
		if( ( rand > 0.25 ) && ( rand <= 0.5 ) )
		{
			return 'FearLocomotion1';
		}
		else if( ( rand > 0.5 ) && ( rand <= 0.75 ) )
		{
			return 'FearLocomotion2';
		}
		else if( rand <= 0.25 )
		{
			return 'FearLocomotion3';
		}
		else
		{
			return 'FearLocomotion4';
		}
	}

	private function ResetAllFearAnimWrappers()
	{
		var owner : GameObject;
		owner = GetOwner();
		AnimationControllerComponent.SetAnimWrapperWeightOnOwnerAndItems( owner, 'disturbed', 0.0 );
		AnimationControllerComponent.SetAnimWrapperWeightOnOwnerAndItems( owner, 'fear', 0.0 );
		AnimationControllerComponent.SetAnimWrapperWeightOnOwnerAndItems( owner, 'panic', 0.0 );
		AnimationControllerComponent.SetAnimWrapperWeightOnOwnerAndItems( owner, 'FearLocomotion1', 0.0 );
		AnimationControllerComponent.SetAnimWrapperWeightOnOwnerAndItems( owner, 'FearLocomotion2', 0.0 );
		AnimationControllerComponent.SetAnimWrapperWeightOnOwnerAndItems( owner, 'FearLocomotion3', 0.0 );
		AnimationControllerComponent.SetAnimWrapperWeightOnOwnerAndItems( owner, 'FearLocomotion4', 0.0 );
		m_fearLocomotionWrapper = false;
	}

	public const function IsFearLocomotionWrapperSet() : Bool
	{
		return m_fearLocomotionWrapper;
	}

	private function ReevaluateReaction()
	{
		if( SourceAttitude( m_activeReaction.stimTarget, EAIAttitude.AIA_Friendly ) )
		{
			GetPuppetReactionBlackboard().SetBool( GetAllBlackboardDefs().PuppetReaction.exitReactionFlag, true );
			NPCPuppet.ChangeHighLevelState( GetOwner(), gamedataNPCHighLevelState.Relaxed );
		}
	}

	protected event OnStanceLevelChanged( evt : StanceStateChangeEvent )
	{
		m_stanceState = evt.state;
		ReevaluateReactionPreset();
		if( m_stanceState == gamedataNPCStanceState.Stand )
		{
			TriggerPendingReaction();
		}
		if( ( m_stanceState == gamedataNPCStanceState.Vehicle || m_stanceState == gamedataNPCStanceState.VehicleWindow ) || m_stanceState == gamedataNPCStanceState.Swim )
		{
			GetOwnerPuppet().GetBumpComponent().Toggle( false );
		}
		else
		{
			GetOwnerPuppet().GetBumpComponent().ToggleComponentOn();
		}
	}

	protected event OnHighLevelStateDataEvent( evt : gameHighLevelStateDataEvent )
	{
		m_highLevelState = evt.currentHighLevelState;
		if( m_highLevelState == gamedataNPCHighLevelState.Dead )
		{
			DeactiveLookAt();
			Toggle( false );
		}
		else if( m_highLevelState == gamedataNPCHighLevelState.Relaxed )
		{
			TriggerPendingReaction();
		}
		if( m_highLevelState == gamedataNPCHighLevelState.Combat )
		{
			( ( NPCPuppet )( GetOwner() ) ).GetComfortZoneComponent().Toggle( false );
		}
		if( ( GetOwnerPuppet().IsConnectedToSecuritySystem() && m_highLevelState != gamedataNPCHighLevelState.Alerted ) && m_isAlertedByDeadBody )
		{
			m_isAlertedByDeadBody = false;
		}
		if( ( ( GameInstance.GetGameFeatureManager( GetOwner().GetGame() ).AggressiveCrowdsEnabled() && m_inCrowd ) && m_highLevelState != gamedataNPCHighLevelState.Combat ) && ( ( NPCPuppet )( GetOwner() ) ).IsAggressive() )
		{
			( ( NPCPuppet )( GetOwner() ) ).CallUnregisterAggressiveNPC();
		}
	}

	protected event OnRagdollEnabledEvent( evt : RagdollNotifyEnabledEvent )
	{
		if( m_inCrowd )
		{
			m_desiredFearPhase = -1;
		}
	}

	private export function OnGameDetach()
	{
		var puppetBlackboard : IBlackboard;
		if( GetOwnerPuppet() )
		{
			puppetBlackboard = GetOwnerPuppet().GetPuppetStateBlackboard();
		}
		if( puppetBlackboard && m_pendingBehaviorCb )
		{
			puppetBlackboard.UnregisterListenerBool( GetAllBlackboardDefs().PuppetState.InPendingBehavior, m_pendingBehaviorCb );
		}
		if( m_ignoreList.Size() != 0 )
		{
			InformInvestigators();
		}
	}

	protected event OnDeadBodyEvent( evt : DeadBodyEvent )
	{
		SetDeadBodyVisibleComponent( ( ( NPCPuppet )( GetOwner() ) ).GetMyKiller() );
	}

	protected event OnIgnoreListEvent( evt : IgnoreListEvent )
	{
		if( evt.removeEvent )
		{
			if( m_ignoreList.Contains( evt.bodyID ) )
			{
				m_ignoreList.Remove( evt.bodyID );
			}
		}
		else
		{
			m_ignoreList.PushBack( evt.bodyID );
			AddInvestigatedBody( evt.bodyID );
		}
	}

	protected event OnNPCRoleChangeEvent( evt : NPCRoleChangeEvent )
	{
		m_aiRole = evt.m_newRole.GetRoleEnum();
		ReevaluateReactionPreset();
		if( m_aiRole == EAIRole.Follower )
		{
			GetOwnerPuppet().GetBumpComponent().Toggle( false );
		}
	}

	protected event OnWorkspotStartedEvent( evt : WorkspotStartedEvent ) {}

	protected event OnWorkspotFinishedEvent( evt : WorkspotFinishedEvent ) {}

	protected event OnStatusEffectApplied( evt : ApplyStatusEffectEvent )
	{
		var additionalParam : CName;
		additionalParam = evt.staticData.AdditionalParam();
		if( ( evt.staticData.StatusEffectType().Type() == gamedataStatusEffectType.Sleep || additionalParam == 'Drunk' ) || evt.staticData.GameplayTagsContains( 'Braindance' ) )
		{
			ReevaluateReactionPreset();
		}
		if( additionalParam == 'LoreAnim' )
		{
			ReevaluateReactionPreset();
			m_workspotReactionPlayed = true;
		}
		if( additionalParam == 'LoreVictimSaved' )
		{
			AnimationControllerComponent.SetAnimWrapperWeight( GetOwnerPuppet(), 'LoreVictimSaved', 1.0 );
		}
		if( additionalParam == 'Busy' )
		{
			GetOwnerPuppet().EnableInteraction( 'GenericTalk', false );
		}
	}

	protected event OnStatusEffectRemoved( evt : RemoveStatusEffect )
	{
		var startReaction : StimuliEvent;
		var additionalParam : CName;
		var ownerPuppet : ScriptedPuppet;
		additionalParam = evt.staticData.AdditionalParam();
		ownerPuppet = GetOwnerPuppet();
		if( ( evt.staticData.StatusEffectType().Type() == gamedataStatusEffectType.Sleep || additionalParam == 'Drunk' ) || evt.staticData.GameplayTagsContains( 'Braindance' ) )
		{
			ReevaluateReactionPreset();
		}
		if( additionalParam == 'LoreAnim' )
		{
			if( m_activeReaction || ownerPuppet.GetHighLevelStateFromBlackboard() == gamedataNPCHighLevelState.Alerted )
			{
				startReaction = new StimuliEvent;
				startReaction.name = 'loreAnim';
				GetOwner().QueueEvent( startReaction );
			}
			if( m_cacheSecuritySysOutput )
			{
				ReactToSecuritySystemOutputByTask( m_cacheSecuritySysOutput );
			}
			ReevaluateReactionPreset();
		}
		if( additionalParam == 'LoreVictimSaved' )
		{
			AnimationControllerComponent.SetAnimWrapperWeight( ownerPuppet, 'LoreVictimSaved', 0.0 );
		}
		if( additionalParam == 'Busy' )
		{
			ownerPuppet.EnableInteraction( 'GenericTalk', true );
		}
	}

	protected event OnReactionFinishedEvent( evt : ReactionFinishedEvent )
	{
		var crowdSettingsEvent : CrowdSettingsEvent;
		var mountInfo : MountingInfo;
		var owner : GameObject;
		var game : GameInstance;
		owner = GetOwner();
		game = owner.GetGame();
		DeactiveLookAt();
		ResetFacial( m_facialCooldown );
		m_inReactionSequence = false;
		m_crowdFearStage = gameFearStage.Relaxed;
		GetOwnerPuppet().GetCrowdMemberComponent().ChangeFearStage( m_crowdFearStage );
		if( VehicleComponent.IsMountedToVehicle( game, owner ) )
		{
			crowdSettingsEvent = new CrowdSettingsEvent;
			crowdSettingsEvent.movementType = 'panic';
			mountInfo = GameInstance.GetMountingFacility( game ).GetMountingInfoSingleWithObjects( owner );
			GameInstance.FindEntityByID( game, mountInfo.parentId ).QueueEvent( crowdSettingsEvent );
		}
	}

	protected event OnReevaluatePresetEvent( evt : ReevaluatePresetEvent )
	{
		var setAggressiveMaskEvent : SetAggressiveMask;
		ReevaluateReactionPreset();
		CheckCrowd();
		if( m_reactionPreset && m_reactionPreset.IsAggressive() )
		{
			setAggressiveMaskEvent = new SetAggressiveMask;
			GetOwnerPuppet().QueueEvent( setAggressiveMaskEvent );
		}
	}

	protected event OnReactionChangeRequestEvent( evt : ReactionChangeRequestEvent )
	{
		SetReactionPreset( evt.reactionPresetRecord );
	}

	protected event OnPendingBehaviorChanged( value : Bool )
	{
		var triggerAIEvent : AIEvent;
		if( value )
		{
			m_inPendingBehavior = true;
		}
		else
		{
			m_inPendingBehavior = false;
			triggerAIEvent = new AIEvent;
			triggerAIEvent.name = 'TriggerCombatReaction';
			GetOwnerPuppet().QueueEvent( triggerAIEvent );
		}
	}

	protected event OnAttitudeGroupChanged( evt : AttitudeGroupChangedEvent )
	{
		if( m_activeReaction )
		{
			ReevaluateReaction();
		}
	}

	private function CalculateMoveTypeChangeDelay( totalDistance : Float, distanceLeft : Float, minDistance : Float, maxDelay : Float ) : Float
	{
		var delay : Float;
		delay = ( ( 1.0 - ( ( distanceLeft - minDistance ) / ( totalDistance - minDistance ) ) ) * maxDelay ) * 0.5;
		delay += ( ( RandF() * maxDelay ) * 0.5 );
		return delay;
	}

	protected event OnCrosswalkEvent( evt : CrosswalkEvent )
	{
		var ownerPuppet : ScriptedPuppet;
		var crowdMemberComponent : CrowdMemberBaseComponent;
		var changeMoveTypeEvent : CrowdSettingsEvent;
		ownerPuppet = GetOwnerPuppet();
		changeMoveTypeEvent = new CrowdSettingsEvent;
		if( evt.oldTrafficLightColor == worldTrafficLightColor.INVALID )
		{
			m_isInCrosswalk = true;
		}
		if( evt.trafficLightColor == worldTrafficLightColor.INVALID )
		{
			m_isInCrosswalk = false;
		}
		if( evt.oldTrafficLightColor == worldTrafficLightColor.INVALID || m_crowdFearStage != gameFearStage.Relaxed )
		{
			return false;
		}
		crowdMemberComponent = ownerPuppet.GetCrowdMemberComponent();
		if( evt.trafficLightColor == worldTrafficLightColor.RED )
		{
			if( ( evt.totalDistance - evt.distanceLeft ) <= 1.5 )
			{
				crowdMemberComponent.TryChangeMovementDirection();
			}
			else if( evt.distanceLeft > 2.0 )
			{
				changeMoveTypeEvent.movementType = 'jog';
				GameInstance.GetDelaySystem( GetOwner().GetGame() ).DelayEvent( GetOwner(), changeMoveTypeEvent, CalculateMoveTypeChangeDelay( evt.totalDistance, evt.distanceLeft, 2.0, evt.totalDistance / 5.0 ) );
			}
		}
		else if( evt.trafficLightColor == worldTrafficLightColor.YELLOW )
		{
			if( ( evt.totalDistance - evt.distanceLeft ) <= 1.5 )
			{
				crowdMemberComponent.TryChangeMovementDirection();
			}
			else if( evt.distanceLeft > 4.0 )
			{
				changeMoveTypeEvent.movementType = 'jog';
				GameInstance.GetDelaySystem( GetOwner().GetGame() ).DelayEvent( GetOwner(), changeMoveTypeEvent, CalculateMoveTypeChangeDelay( evt.totalDistance, evt.distanceLeft, 4.0, evt.totalDistance / 5.0 ) );
			}
		}
		else if( evt.trafficLightColor == worldTrafficLightColor.GREEN )
		{
			crowdMemberComponent.ChangeMoveType( 'walk' );
		}
		else
		{
			crowdMemberComponent.ChangeMoveType( 'walk' );
		}
	}

	protected event OnBumpEvent( evt : BumpEvent )
	{
		var workspotSystem : WorkspotGameSystem;
		var broadcaster : StimBroadcasterComponent;
		var distanceSquared : Float;
		var triggerDistance : Float;
		var speedModifier : Float;
		var distanceBuffer : Float;
		var vehicle : VehicleObject;
		var blackboard : IBlackboard;
		var player : GameObject;
		var owner : GameObject;
		var ownerPuppet : ScriptedPuppet;
		var game : GameInstance;
		owner = GetOwner();
		ownerPuppet = GetOwnerPuppet();
		game = owner.GetGame();
		if( !( ownerPuppet ) || !( ownerPuppet.IsActive() ) )
		{
			return false;
		}
		if( m_reactionPreset.Type() == gamedataReactionPresetType.NoReaction )
		{
			return false;
		}
		if( !( m_initCrowd ) )
		{
			InitCrowd();
			m_initCrowd = true;
		}
		player = GetPlayerSystem().GetLocalPlayerMainGameObject();
		if( evt.isMounted )
		{
			distanceBuffer = m_bumpTriggerDistanceBufferMounted;
		}
		else
		{
			if( ( GameInstance.GetWorkspotSystem( owner.GetGame() ).IsActorInWorkspot( owner ) && GameInstance.GetWorkspotSystem( owner.GetGame() ).IsActorInWorkspot( GetPlayerSystem().GetLocalPlayerControlledGameObject() ) ) && StatusEffectSystem.ObjectHasStatusEffect( GetOwner(), T"WorkspotStatus.SyncAnimation" ) )
			{
				return false;
			}
			if( ScriptedPuppet.IsBeingGrappled( ownerPuppet ) )
			{
				return false;
			}
			blackboard = GameInstance.GetBlackboardSystem( game ).GetLocalInstanced( player.GetEntityID(), GetAllBlackboardDefs().PlayerStateMachine );
			if( blackboard.GetInt( GetAllBlackboardDefs().PlayerStateMachine.Locomotion ) == ( ( Int32 )( gamePSMLocomotionStates.Crouch ) ) )
			{
				distanceBuffer = m_bumpTriggerDistanceBufferCrouched;
			}
		}
		vehicle = ( ( VehicleObject )( GameInstance.FindEntityByID( game, evt.vehicleEntityID ) ) );
		if( evt.sourceSpeed > 15.0 )
		{
			speedModifier = 3.5;
		}
		else if( evt.sourceSpeed > 10.0 )
		{
			speedModifier = 2.5;
		}
		else if( evt.sourceSpeed > 5.0 )
		{
			speedModifier = 1.5;
		}
		else if( evt.sourceSpeed > 1.5 )
		{
			speedModifier = 0.5;
		}
		distanceSquared = evt.sourceSquaredDistance;
		triggerDistance = ( ( evt.sourceRadius + m_NPCRadius ) + distanceBuffer ) + speedModifier;
		if( evt.isMounted )
		{
			if( distanceSquared > ( triggerDistance * triggerDistance ) )
			{
				return false;
			}
		}
		else
		{
			triggerDistance = ( evt.sourceRadius + m_NPCRadius ) + distanceBuffer;
			if( distanceSquared > ( triggerDistance * triggerDistance ) )
			{
				return false;
			}
		}
		if( !( GameObject.IsCooldownActive( ownerPuppet, 'bumpCooldown' ) ) )
		{
			if( evt.isMounted )
			{
				GameObject.StartCooldown( ownerPuppet, 'bumpCooldown', TDB.GetFloat( T"AIGeneralSettings.vehicleBumpCooldown" ) );
				if( !( ( ( NPCPuppet )( ownerPuppet ) ).IsRagdolling() ) && ownerPuppet.GetHighLevelStateFromBlackboard() != gamedataNPCHighLevelState.Combat )
				{
					TriggerReactionBehaviorForCrowd( vehicle, gamedataOutput.DodgeToSide, false, evt.sourcePosition );
				}
			}
			else
			{
				GameObject.StartCooldown( ownerPuppet, 'bumpCooldown', 1.0 );
				if( SourceAttitude( player, EAIAttitude.AIA_Friendly ) )
				{
					return false;
				}
				GameObject.PlayVoiceOver( owner, 'bump', 'Scripts:OnBumpEvent' );
				broadcaster = player.GetStimBroadcasterComponent();
				workspotSystem = GameInstance.GetWorkspotSystem( game );
				if( workspotSystem.IsActorInWorkspot( ownerPuppet ) )
				{
				}
				else if( m_inTrafficLane )
				{
				}
				else
				{
					if( m_inCrowd || IsReactionAvailableInPreset( gamedataStimType.Bump ) )
					{
						TriggerReactionBehaviorForCrowd( player, gamedataOutput.Bump, false );
					}
				}
				if( m_bumpTimestamp >= EngineTime.ToFloat( GameInstance.GetSimTime( game ) ) )
				{
					m_bumpedRecently += 1;
					if( m_inCrowd )
					{
						if( m_bumpedRecently > 2 )
						{
							TriggerFacialLookAtReaction( true, true );
							if( broadcaster )
							{
								broadcaster.SendDrirectStimuliToTarget( ownerPuppet, gamedataStimType.Bump, ownerPuppet );
							}
						}
					}
					else if( m_reactionPreset.IsAggressive() && broadcaster )
					{
						if( m_bumpedRecently <= 2 )
						{
							if( workspotSystem.IsActorInWorkspot( ownerPuppet ) && !( ownerPuppet.IsConnectedToSecuritySystem() ) )
							{
								broadcaster.SendDrirectStimuliToTarget( ownerPuppet, gamedataStimType.Provoke, ownerPuppet );
							}
							else if( m_desiredReaction )
							{
								m_desiredReaction.escalateProvoke = true;
							}
						}
						else if( ( !( CanTriggerReprimandOrder() ) && m_activeReaction ) && m_activeReaction.reactionBehaviorName == gamedataOutput.Bump )
						{
							broadcaster.SendDrirectStimuliToTarget( ownerPuppet, gamedataStimType.Combat, ownerPuppet );
						}
					}
				}
				else
				{
					m_bumpedRecently = 1;
					m_bumpTimestamp = EngineTime.ToFloat( GameInstance.GetSimTime( game ) ) + 10.0;
					if( m_inCrowd )
					{
						TriggerFacialLookAtReaction( true );
					}
					else if( m_reactionPreset.IsAggressive() )
					{
						if( ( broadcaster && workspotSystem.IsActorInWorkspot( ownerPuppet ) ) && !( ownerPuppet.IsConnectedToSecuritySystem() ) )
						{
							broadcaster.SendDrirectStimuliToTarget( ownerPuppet, gamedataStimType.Provoke, ownerPuppet );
						}
					}
				}
			}
		}
	}

	protected event OnClearFearOnHitEvent( evt : ClearFearOnHitEvent )
	{
		if( GetOwnerPuppet().IsCharacterCivilian() && !( m_pendingReaction ) )
		{
			m_crowdFearStage = gameFearStage.Relaxed;
			ResetAllFearAnimWrappers();
		}
	}

	private function PlayBumpInWorkspot( side : gameinteractionsBumpSide, direction : Vector4 )
	{
		var workspotSystem : WorkspotGameSystem;
		var actor : weak< GameObject >;
		var isBumpFromFront : Bool;
		var reactionName : CName;
		actor = GetOwner();
		workspotSystem = GameInstance.GetWorkspotSystem( actor.GetGame() );
		isBumpFromFront = Vector4.Dot2D( actor.GetWorldForward(), direction ) < 0.0;
		switch( side )
		{
			case gameinteractionsBumpSide.Left:
				reactionName = ( ( isBumpFromFront ) ? ( 'BumpLeftFront' ) : ( 'BumpLeftBack' ) );
			break;
			case gameinteractionsBumpSide.Right:
				reactionName = ( ( isBumpFromFront ) ? ( 'BumpRightFront' ) : ( 'BumpRightBack' ) );
			break;
			default:
				return;
		}
		if( workspotSystem.IsReactionAvailable( actor, reactionName ) )
		{
			workspotSystem.SendReactionSignal( actor, reactionName );
		}
	}

	protected event OnVehicleHit( evt : gameVehicleHitEvent )
	{
		var instigator : GameObject;
		instigator = evt.attackData.GetInstigator();
		if( !( instigator ) )
		{
			return false;
		}
		if( instigator.IsPlayer() )
		{
			StimBroadcasterComponent.BroadcastStim( instigator, gamedataStimType.CrimeWitness );
		}
		if( !( GameObject.IsCooldownActive( GetOwner(), 'vehicleHitCooldown' ) ) )
		{
			GameObject.StartCooldown( GetOwner(), 'vehicleHitCooldown', 1.0 );
			StimBroadcasterComponent.BroadcastStim( instigator, gamedataStimType.VehicleHit, TweakDBInterface.GetFloat( T"AIGeneralSettings.vehicleHitFearSpreadRange", 5.0 ) );
		}
	}

	protected event OnPlayerProximityStartEvent( evt : PlayerProximityStartEvent )
	{
		var proximityLookatEvent : ProximityLookatEvent;
		var player : weak< PlayerPuppet >;
		player = ( ( PlayerPuppet )( GetPlayerSystem().GetLocalPlayerControlledGameObject() ) );
		if( !( player ) )
		{
			return false;
		}
		if( evt.profile == 'Crowds' )
		{
			m_playerProximity = true;
			if( m_inCrowd || !( GetOwnerPuppet().IsConnectedToSecuritySystem() ) )
			{
				if( CanTriggerExpressionLookAt() )
				{
					if( IsTargetInFront( player, 45.0, true ) && IsTargetInFront( player ) )
					{
						if( m_inCrowd )
						{
							ActivateReactionLookAt( player, true, true );
						}
						else
						{
							ActivateReactionLookAt( player, false );
						}
					}
					proximityLookatEvent = new ProximityLookatEvent;
					m_proximityLookatEventId = GetDelaySystem().DelayEvent( GetOwner(), proximityLookatEvent, 2.0 );
				}
			}
		}
	}

	protected event OnPlayerProximityStopEvent( evt : PlayerProximityStopEvent )
	{
		var delaySystem : DelaySystem;
		if( m_playerProximity )
		{
			m_playerProximity = false;
			if( !( m_inReactionSequence ) )
			{
				DeactiveLookAt();
				ResetFacial( m_facialCooldown );
			}
		}
		delaySystem = GameInstance.GetDelaySystem( GetOwner().GetGame() );
		delaySystem.CancelDelay( m_disturbComfortZoneEventId );
		delaySystem.CancelDelay( m_checkComfortZoneEventId );
		delaySystem.CancelDelay( m_proximityLookatEventId );
	}

	protected event OnProximityLookatEvent( evt : ProximityLookatEvent )
	{
		var proximityLookatEvent : ProximityLookatEvent;
		GameInstance.GetDelaySystem( GetOwner().GetGame() ).CancelDelay( m_proximityLookatEventId );
		if( CanTriggerExpressionLookAt() )
		{
			if( ( m_playerProximity && IsTargetInFront( GetPlayerSystem().GetLocalPlayerControlledGameObject() ) ) && IsTargetInFront( GetPlayerSystem().GetLocalPlayerControlledGameObject(), 45.0, true ) )
			{
				TriggerFacialLookAtReaction();
			}
			else if( m_playerProximity )
			{
				proximityLookatEvent = new ProximityLookatEvent;
				m_proximityLookatEventId = GetDelaySystem().DelayEvent( GetOwner(), proximityLookatEvent, 1.5 );
			}
		}
	}

	protected event OnTeleported( evt : AIPuppetSwappedEvent )
	{
		if( m_crowdFearStage != gameFearStage.Relaxed )
		{
			GetPuppetReactionBlackboard().SetBool( GetAllBlackboardDefs().PuppetReaction.exitReactionFlag, true );
			ResetAllFearAnimWrappers();
			GameInstance.GetReactionSystem( GetOwner().GetGame() ).UnmarkDespawnCandidate( GetOwner().GetEntityID() );
		}
	}

	protected event OnInCrowd( evt : InCrowd )
	{
		m_inTrafficLane = true;
	}

	protected event OnOutOfCrowd( evt : OutOfCrowd )
	{
		m_inTrafficLane = false;
	}

	public function IsInTrafficLane() : Bool
	{
		return m_inTrafficLane;
	}

	protected event OnVehicleHijackEvent( evt : VehicleHijackEvent )
	{
		m_beignHijacked = true;
	}

	protected event OnResetVehicleHijackEvent( evt : ResetVehicleHijackEvent )
	{
		m_beignHijacked = false;
	}

	protected event OnSwapPreset( evt : SwapPresetEvent )
	{
		if( evt.mappingName == "Base" )
		{
			SetBaseReactionPreset();
		}
		else
		{
			MapReactionPreset( evt.mappingName );
		}
	}

	protected event OnRainEvent( evt : RainEvent ) {}

	protected event OnDistrurbComfortZoneAggressiveEvent( evt : DistrurbComfortZoneAggressiveEvent )
	{
		var broadcaster : StimBroadcasterComponent;
		var owner : GameObject;
		owner = GetOwner();
		m_backOffInProgress = true;
		m_backOffTimestamp = EngineTime.ToFloat( GameInstance.GetSimTime( owner.GetGame() ) ) + 50.0;
		broadcaster = GetPlayerSystem().GetLocalPlayerControlledGameObject().GetStimBroadcasterComponent();
		if( broadcaster )
		{
			broadcaster.SendDrirectStimuliToTarget( owner, gamedataStimType.Provoke, owner );
		}
	}

	protected event OnAreaEnter( trigger : AreaEnteredEvent )
	{
		var distrurbComfortZoneAggressiveEvent : DistrurbComfortZoneAggressiveEvent;
		var broadcaster : StimBroadcasterComponent;
		var owner : GameObject;
		var game : GameInstance;
		owner = GetOwner();
		game = owner.GetGame();
		GameObject.PlayVoiceOver( owner, 'stlh_curious_grunt', 'Scripts:ProcessReactionOutput' );
		ActivateReactionLookAt( GameInstance.GetPlayerSystem( game ).GetLocalPlayerMainGameObject(), true );
		if( m_backOffInProgress && ( m_backOffTimestamp >= EngineTime.ToFloat( GameInstance.GetSimTime( game ) ) ) )
		{
			broadcaster = GetPlayerSystem().GetLocalPlayerControlledGameObject().GetStimBroadcasterComponent();
			if( broadcaster )
			{
				broadcaster.SendDrirectStimuliToTarget( owner, gamedataStimType.Provoke, owner );
			}
		}
		else
		{
			m_backOffInProgress = false;
			distrurbComfortZoneAggressiveEvent = new DistrurbComfortZoneAggressiveEvent;
			m_disturbComfortZoneAggressiveEventId = GameInstance.GetDelaySystem( game ).DelayEvent( owner, distrurbComfortZoneAggressiveEvent, 2.0 );
		}
	}

	protected event OnAreaExit( trigger : AreaExitedEvent )
	{
		DeactiveLookAt();
		GameInstance.GetDelaySystem( GetOwner().GetGame() ).CancelDelay( m_disturbComfortZoneAggressiveEventId );
	}

	protected event OnExplorationEnteredEvent( evt : ExplorationEnteredEvent )
	{
		GetOwnerPuppet().GetPuppetStateBlackboard().SetBool( GetAllBlackboardDefs().PuppetState.InPendingBehavior, true );
	}

	protected event OnExplorationLeftEvent( evt : ExplorationLeftEvent )
	{
		GetOwnerPuppet().GetPuppetStateBlackboard().SetBool( GetAllBlackboardDefs().PuppetState.InPendingBehavior, false );
	}

}

exec function SwapPreset( gameInstance : GameInstance, mappingName : String )
{
	var localPlayer : GameObject;
	var swap : SwapPresetEvent;
	swap = new SwapPresetEvent;
	swap.mappingName = mappingName;
	localPlayer = GameInstance.GetPlayerSystem( gameInstance ).GetLocalPlayerMainGameObject();
	GameInstance.GetTargetingSystem( gameInstance ).GetLookAtObject( localPlayer ).QueueEvent( swap );
}

